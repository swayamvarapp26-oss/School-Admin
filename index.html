 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHOOL ADMIN - Management Portal</title>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updatePassword, updateProfile, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getDatabase, ref, get, set, remove, child, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
            authDomain: "schooladmin-51cdd.firebaseapp.com",
            databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
            projectId: "schooladmin-51cdd",
            storageBucket: "schooladmin-51cdd.firebasestorage.app",
            messagingSenderId: "185301938780",
            appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
            measurementId: "G-V8C5DE930K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        window.firebase = { 
            auth, db, rtdb,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail, 
            updatePassword, 
            updateProfile,
            signOut,
            onAuthStateChanged,
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc,
            setDoc, getDoc,
            query, where, orderBy, serverTimestamp,
            ref, get, set, remove, child, push, onValue
        };
        
        console.log("Firebase initialized successfully!");
    </script>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ALL YOUR EXISTING CSS REMAINS THE SAME */
        /* I'll include only the new/modified styles */

        /* New Status Badges */
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .status-approved { background-color: rgba(46, 204, 113, 0.1); color: #27ae60; }
        .status-pending { background-color: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .status-rejected { background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; }

        /* Profile Image Styles */
        .profile-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--secondary);
        }

        .profile-image-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--secondary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-xs {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        /* Teacher Details Modal */
        .teacher-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .teacher-details-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease;
        }

        .teacher-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light);
        }

        .teacher-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--secondary);
        }

        .teacher-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .teacher-info p {
            color: var(--gray);
            margin-bottom: 5px;
        }

        .teacher-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            background: rgba(52, 152, 219, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detail-item p {
            font-size: 16px;
            color: var(--dark);
            font-weight: 500;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Review Actions */
        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        /* Search Box */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Tabs */
        .data-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .data-tab {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .data-tab.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 20px;
            color: white;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: 600;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-item .label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <!-- Auth Screens (Same as before) -->
    <div class="auth-container" id="authContainer">
        <!-- Your existing auth HTML -->
    </div>
    
    <!-- Email Settings Modal (Same as before) -->
    <div class="email-settings-modal" id="emailSettingsModal">
        <!-- Your existing email settings HTML -->
    </div>
    
    <!-- Main Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h1>SCHOOL <span>ADMIN</span></h1>
            </div>
            
            <div class="user-info">
                <div class="notification-bell" id="notificationBell" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="notificationCount" style="display: none;">0</span>
                </div>
                <div class="user-avatar" id="adminAvatar">A</div>
                <div class="user-details">
                    <h3 id="adminName">Admin User</h3>
                    <p id="adminEmail">admin@school.com</p>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <div class="container">
            <aside class="sidebar">
                <ul class="nav-links">
                    <li>
                        <a href="#" class="active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="sendNotice">
                            <i class="fas fa-bullhorn"></i>
                            <span>Send Notice</span>
                            <span class="nav-count" id="noticeCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageNotices">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Manage Notices</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageTeachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Manage Teachers</span>
                            <span class="nav-count" id="teacherCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="teacherRequests">
                            <i class="fas fa-user-clock"></i>
                            <span>Teacher Requests</span>
                            <span class="nav-count" id="pendingRequestsCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="students">
                            <i class="fas fa-user-graduate"></i>
                            <span>Students</span>
                            <span class="nav-count" id="studentCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </aside>
            
            <main class="main-content">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboardSection">
                    <div class="section-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p id="currentDate">Loading date...</p>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="dashboard-stats">
                        <div class="stat-item">
                            <div class="value" id="totalApprovedTeachers">0</div>
                            <div class="label">Approved Teachers</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="totalPendingRequests">0</div>
                            <div class="label">Pending Requests</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="totalNotices">0</div>
                            <div class="label">Total Notices</div>
                        </div>
                        <div class="stat-item">
                            <div class="value" id="totalStudents">0</div>
                            <div class="label">Students</div>
                        </div>
                    </div>
                    
                    <!-- Activity Log -->
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityLog">
                                <!-- Activity log will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Teacher Requests Section -->
                <div class="content-section" id="teacherRequestsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-user-clock"></i> Teacher Approval Requests</h2>
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label>Status:</label>
                                <select id="requestStatusFilter" class="form-control" style="width: 150px;">
                                    <option value="all">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="search-box">
                                <input type="text" id="searchRequests" placeholder="Search teachers...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Teacher</th>
                                    <th>Email</th>
                                    <th>Subject</th>
                                    <th>Grade</th>
                                    <th>Applied On</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                <!-- Requests will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Students Section -->
                <div class="content-section" id="studentsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-user-graduate"></i> Student Management</h2>
                        <div class="filter-controls">
                            <div class="search-box">
                                <input type="text" id="searchStudents" placeholder="Search students...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Grade</th>
                                    <th>Email</th>
                                    <th>Parent Contact</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="content-section" id="settingsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                    </div>
                    
                    <div class="form-container">
                        <!-- Account Settings -->
                        <div class="form-group">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-user-circle"></i> Account Settings
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="settingsName" class="form-control" value="Admin User">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="settingsEmail" class="form-control" value="admin@school.com" readonly>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="updateProfileBtn">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                        
                        <!-- Change Password -->
                        <div class="form-group" style="margin-top: 40px;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-key"></i> Change Password
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="settingsNewPassword" class="form-control" placeholder="Enter new password">
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="settingsConfirmPassword" class="form-control" placeholder="Confirm new password">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                        
                        <!-- Email Settings -->
                        <div class="form-group" style="margin-top: 40px;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-envelope"></i> Email System Settings
                            </h3>
                            <p style="color: var(--gray); margin-bottom: 15px;">
                                Configure EmailJS to send OTPs for registration and password reset
                            </p>
                            <button type="button" class="btn btn-secondary" id="configureEmailBtn">
                                <i class="fas fa-cog"></i> Configure Email Settings
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Teacher Details Modal -->
    <div class="teacher-details-modal" id="teacherDetailsModal">
        <div class="teacher-details-content">
            <div class="teacher-header">
                <img id="teacherDetailImage" src="" alt="Teacher" class="teacher-avatar" onerror="this.src='https://via.placeholder.com/100'">
                <div class="teacher-info">
                    <h3 id="teacherDetailName">Teacher Name</h3>
                    <p id="teacherDetailSubject">Subject</p>
                    <p id="teacherDetailGrade">Grade</p>
                    <p id="teacherDetailEmail">Email</p>
                    <p id="teacherDetailPhone">Phone</p>
                </div>
            </div>
            
            <div class="teacher-details-grid">
                <div class="detail-item">
                    <label>UID</label>
                    <p id="teacherDetailUid">Loading...</p>
                </div>
                <div class="detail-item">
                    <label>Status</label>
                    <p><span id="teacherDetailStatus" class="status-badge">Loading...</span></p>
                </div>
                <div class="detail-item">
                    <label>Applied On</label>
                    <p id="teacherDetailCreatedAt">Loading...</p>
                </div>
                <div class="detail-item">
                    <label>Reviewed On</label>
                    <p id="teacherDetailReviewedAt">Not reviewed</p>
                </div>
                <div class="detail-item">
                    <label>Reviewed By</label>
                    <p id="teacherDetailReviewedBy">Not reviewed</p>
                </div>
                <div class="detail-item">
                    <label>Profile Image</label>
                    <p><a href="#" id="teacherDetailProfileLink" target="_blank">View Image</a></p>
                </div>
            </div>
            
            <div class="review-actions" id="reviewActions">
                <!-- Buttons will be added dynamically -->
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="closeTeacherDetails">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div class="success-message" id="successMessage">
        <div class="success-message-content">
            <i class="fas fa-check-circle"></i>
            <div class="success-message-text">
                <h4>Success!</h4>
                <p id="successText">Operation completed successfully.</p>
            </div>
        </div>
    </div>
    
    <!-- App Logic -->
    <script>
        // Application State
        let currentUser = null;
        let currentAdmin = null;
        let emailConfig = {
            publicKey: "",
            serviceId: "",
            templateId: "",
            senderName: "School Admin System"
        };
        let teachers = [];
        let pendingRequests = [];
        let students = [];
        let notices = [];
        let selectedTeacher = null;

        // Load saved config
        const savedConfig = localStorage.getItem('emailjsConfig');
        if (savedConfig) {
            emailConfig = JSON.parse(savedConfig);
            if (emailConfig.publicKey) {
                emailjs.init(emailConfig.publicKey);
            }
        }

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const verifyRegOtpBtn = document.getElementById('verifyRegOtpBtn');
        const configureEmailBtn = document.getElementById('configureEmailBtn');
        const emailSettingsModal = document.getElementById('emailSettingsModal');
        const closeEmailSettings = document.getElementById('closeEmailSettings');
        const testEmailBtn = document.getElementById('testEmailBtn');
        const saveEmailSettingsBtn = document.getElementById('saveEmailSettingsBtn');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        const logoutBtn = document.getElementById('logoutBtn');
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const notificationBell = document.getElementById('notificationBell');
        const notificationCount = document.getElementById('notificationCount');
        const teacherDetailsModal = document.getElementById('teacherDetailsModal');
        const closeTeacherDetails = document.getElementById('closeTeacherDetails');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Check auth state
            checkAuthState();
            
            // Load email config to form
            loadEmailConfigToForm();
        });

        // ============================
        // SETUP EVENT LISTENERS
        // ============================

        function setupEventListeners() {
            // Auth Tab Switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });

            // Navigation
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    const sectionId = link.dataset.section + 'Section';
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.style.display = 'none';
                        if (section.id === sectionId) {
                            section.style.display = 'block';
                            loadSectionData(sectionId);
                        }
                    });
                });
            });

            // Auth buttons
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            sendOtpBtn.addEventListener('click', handleSendOtp);
            verifyOtpBtn.addEventListener('click', handleVerifyOtp);
            resetPasswordBtn.addEventListener('click', handleResetPassword);
            verifyRegOtpBtn.addEventListener('click', handleVerifyRegOtp);
            
            // Email Settings
            if (configureEmailBtn) {
                configureEmailBtn.addEventListener('click', () => {
                    emailSettingsModal.style.display = 'flex';
                });
            }
            closeEmailSettings.addEventListener('click', () => {
                emailSettingsModal.style.display = 'none';
            });
            testEmailBtn.addEventListener('click', testEmailConfiguration);
            saveEmailSettingsBtn.addEventListener('click', saveEmailConfiguration);
            
            // Teacher Details Modal
            closeTeacherDetails.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });
            
            // Notification Bell
            notificationBell.addEventListener('click', () => {
                // Navigate to teacher requests
                document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
                document.querySelector('.nav-links a[data-section="teacherRequests"]').classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
                document.getElementById('teacherRequestsSection').style.display = 'block';
                loadSectionData('teacherRequestsSection');
            });
            
            // Search Filters
            document.getElementById('requestStatusFilter')?.addEventListener('change', filterTeacherRequests);
            document.getElementById('searchRequests')?.addEventListener('input', filterTeacherRequests);
            document.getElementById('searchStudents')?.addEventListener('input', filterStudents);
        }

        // ============================
        // AUTHENTICATION
        // ============================

        function checkAuthState() {
            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || 'Admin User',
                        photoURL: user.photoURL
                    };
                    localStorage.setItem('schoolAdminUser', JSON.stringify(currentUser));
                    showAdminPanel();
                    loadDashboardData();
                } else {
                    const storedUser = localStorage.getItem('schoolAdminUser');
                    if (storedUser) {
                        currentUser = JSON.parse(storedUser);
                        showAdminPanel();
                        loadDashboardData();
                    }
                }
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(
                    window.firebase.auth, 
                    email, 
                    password
                );
                
                currentUser = {
                    uid: userCredential.user.uid,
                    email: userCredential.user.email,
                    displayName: userCredential.user.displayName || 'Admin User',
                    photoURL: userCredential.user.photoURL
                };
                
                localStorage.setItem('schoolAdminUser', JSON.stringify(currentUser));
                showSuccess('Login successful!');
                showAdminPanel();
                loadDashboardData();
                
            } catch (error) {
                showError('Login failed: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                await window.firebase.signOut(window.firebase.auth);
                localStorage.removeItem('schoolAdminUser');
                currentUser = null;
                authContainer.style.display = 'flex';
                adminPanel.style.display = 'none';
                showSuccess('Logged out successfully!');
            } catch (error) {
                showError('Logout failed: ' + error.message);
            }
        }

        // ============================
        // DASHBOARD & DATA LOADING
        // ============================

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboardSection':
                    loadDashboardData();
                    break;
                case 'teacherRequestsSection':
                    loadTeacherRequests();
                    break;
                case 'studentsSection':
                    loadStudents();
                    break;
            }
        }

        async function loadDashboardData() {
            try {
                // Load teacher requests
                await loadTeacherRequests();
                
                // Load approved teachers
                const approvedTeachers = teachers.filter(t => t.status === 'approved');
                document.getElementById('totalApprovedTeachers').textContent = approvedTeachers.length;
                document.getElementById('teacherCount').textContent = approvedTeachers.length;
                
                // Load pending requests
                const pending = teachers.filter(t => t.status === 'pending');
                document.getElementById('totalPendingRequests').textContent = pending.length;
                document.getElementById('pendingRequestsCount').textContent = pending.length;
                updateNotificationCount(pending.length);
                
                // Load notices count
                const noticesRef = window.firebase.ref(window.firebase.rtdb, 'notices');
                const noticesSnapshot = await window.firebase.get(noticesRef);
                const noticesCount = noticesSnapshot.exists() ? Object.keys(noticesSnapshot.val()).length : 0;
                document.getElementById('totalNotices').textContent = noticesCount;
                document.getElementById('noticeCount').textContent = noticesCount;
                
                // Load students count
                const studentsRef = window.firebase.ref(window.firebase.rtdb, 'students');
                const studentsSnapshot = await window.firebase.get(studentsRef);
                const studentsCount = studentsSnapshot.exists() ? Object.keys(studentsSnapshot.val()).length : 0;
                document.getElementById('totalStudents').textContent = studentsCount;
                document.getElementById('studentCount').textContent = studentsCount;
                
                // Load activity log
                loadActivityLog();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateNotificationCount(count) {
            if (count > 0) {
                notificationCount.textContent = count;
                notificationCount.style.display = 'flex';
            } else {
                notificationCount.style.display = 'none';
            }
        }

        async function loadTeacherRequests() {
            try {
                const teachersRef = window.firebase.ref(window.firebase.rtdb, 'teachers');
                const snapshot = await window.firebase.get(teachersRef);
                
                teachers = [];
                if (snapshot.exists()) {
                    const teachersData = snapshot.val();
                    Object.keys(teachersData).forEach(uid => {
                        const teacher = {
                            uid: uid,
                            ...teachersData[uid]
                        };
                        teachers.push(teacher);
                    });
                    
                    // Sort by creation date (newest first)
                    teachers.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                }
                
                updateTeacherRequestsTable();
                updateDashboardCounts();
                
            } catch (error) {
                console.error('Error loading teacher requests:', error);
                showError('Failed to load teacher requests');
            }
        }

        function updateTeacherRequestsTable() {
            const tableBody = document.getElementById('requestsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (teachers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No teacher requests found</h3>
                        </td>
                    </tr>
                `;
                return;
            }
            
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                
                // Status badge
                let statusBadge = '';
                if (teacher.status === 'approved') {
                    statusBadge = '<span class="status-badge status-approved">Approved</span>';
                } else if (teacher.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">Pending</span>';
                } else if (teacher.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                }
                
                // Profile image
                const profileImg = teacher.profileImage || 'https://via.placeholder.com/40';
                
                // Actions based on status
                let actions = '';
                if (teacher.status === 'pending') {
                    actions = `
                        <div class="action-buttons">
                            <button class="btn btn-success btn-xs approve-btn" data-uid="${teacher.uid}">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-xs reject-btn" data-uid="${teacher.uid}">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="btn btn-primary btn-xs view-btn" data-uid="${teacher.uid}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                } else {
                    actions = `
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-xs view-btn" data-uid="${teacher.uid}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${teacher.status === 'approved' ? 
                                `<button class="btn btn-warning btn-xs revoke-btn" data-uid="${teacher.uid}">
                                    <i class="fas fa-ban"></i> Revoke
                                </button>` : ''
                            }
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${profileImg}" alt="${teacher.fullName}" class="profile-image-small" 
                                 onerror="this.src='https://via.placeholder.com/40'">
                            <span>${teacher.fullName || 'N/A'}</span>
                        </div>
                    </td>
                    <td>${teacher.email || 'N/A'}</td>
                    <td>${teacher.subject || 'N/A'}</td>
                    <td>${teacher.grade || 'N/A'}</td>
                    <td>${teacher.createdAt ? new Date(teacher.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            addTeacherActionListeners();
        }

        function addTeacherActionListeners() {
            // View buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uid = this.dataset.uid;
                    showTeacherDetails(uid);
                });
            });
            
            // Approve buttons
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uid = this.dataset.uid;
                    approveTeacher(uid);
                });
            });
            
            // Reject buttons
            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uid = this.dataset.uid;
                    rejectTeacher(uid);
                });
            });
            
            // Revoke buttons
            document.querySelectorAll('.revoke-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uid = this.dataset.uid;
                    revokeTeacher(uid);
                });
            });
        }

        async function showTeacherDetails(uid) {
            const teacher = teachers.find(t => t.uid === uid);
            if (!teacher) return;
            
            selectedTeacher = teacher;
            
            // Populate modal
            document.getElementById('teacherDetailName').textContent = teacher.fullName || 'N/A';
            document.getElementById('teacherDetailSubject').textContent = teacher.subject || 'N/A';
            document.getElementById('teacherDetailGrade').textContent = teacher.grade || 'N/A';
            document.getElementById('teacherDetailEmail').textContent = teacher.email || 'N/A';
            document.getElementById('teacherDetailPhone').textContent = teacher.phone || 'N/A';
            document.getElementById('teacherDetailUid').textContent = teacher.uid || 'N/A';
            
            // Status
            const statusElement = document.getElementById('teacherDetailStatus');
            statusElement.className = 'status-badge';
            if (teacher.status === 'approved') {
                statusElement.textContent = 'Approved';
                statusElement.classList.add('status-approved');
            } else if (teacher.status === 'pending') {
                statusElement.textContent = 'Pending';
                statusElement.classList.add('status-pending');
            } else if (teacher.status === 'rejected') {
                statusElement.textContent = 'Rejected';
                statusElement.classList.add('status-rejected');
            }
            
            // Dates
            document.getElementById('teacherDetailCreatedAt').textContent = 
                teacher.createdAt ? new Date(teacher.createdAt).toLocaleString() : 'N/A';
            document.getElementById('teacherDetailReviewedAt').textContent = 
                teacher.reviewedAt ? new Date(teacher.reviewedAt).toLocaleString() : 'Not reviewed';
            document.getElementById('teacherDetailReviewedBy').textContent = 
                teacher.reviewedByName || teacher.reviewedBy || 'Not reviewed';
            
            // Profile image
            const imgElement = document.getElementById('teacherDetailImage');
            const profileImg = teacher.profileImage || 'https://via.placeholder.com/100';
            imgElement.src = profileImg;
            
            // Profile link
            const linkElement = document.getElementById('teacherDetailProfileLink');
            linkElement.href = profileImg;
            linkElement.textContent = profileImg.includes('placeholder') ? 'No Image' : 'View Image';
            
            // Review actions
            const reviewActions = document.getElementById('reviewActions');
            reviewActions.innerHTML = '';
            
            if (teacher.status === 'pending') {
                reviewActions.innerHTML = `
                    <button class="btn btn-success" id="modalApproveBtn">
                        <i class="fas fa-check"></i> Approve Teacher
                    </button>
                    <button class="btn btn-danger" id="modalRejectBtn">
                        <i class="fas fa-times"></i> Reject Teacher
                    </button>
                `;
                
                document.getElementById('modalApproveBtn').addEventListener('click', () => approveTeacher(uid));
                document.getElementById('modalRejectBtn').addEventListener('click', () => rejectTeacher(uid));
            } else if (teacher.status === 'approved') {
                reviewActions.innerHTML = `
                    <button class="btn btn-warning" id="modalRevokeBtn">
                        <i class="fas fa-ban"></i> Revoke Approval
                    </button>
                `;
                
                document.getElementById('modalRevokeBtn').addEventListener('click', () => revokeTeacher(uid));
            }
            
            // Show modal
            teacherDetailsModal.style.display = 'flex';
        }

        async function approveTeacher(uid) {
            if (!confirm('Are you sure you want to approve this teacher?')) return;
            
            try {
                const teacherRef = window.firebase.ref(window.firebase.rtdb, `teachers/${uid}`);
                await window.firebase.update(teacherRef, {
                    status: 'approved',
                    approved: true,
                    reviewedAt: new Date().toISOString(),
                    reviewedBy: currentUser.uid,
                    reviewedByName: currentUser.displayName || 'Admin'
                });
                
                showSuccess('Teacher approved successfully!');
                await loadTeacherRequests();
                teacherDetailsModal.style.display = 'none';
                
            } catch (error) {
                showError('Failed to approve teacher: ' + error.message);
            }
        }

        async function rejectTeacher(uid) {
            if (!confirm('Are you sure you want to reject this teacher?')) return;
            
            try {
                const teacherRef = window.firebase.ref(window.firebase.rtdb, `teachers/${uid}`);
                await window.firebase.update(teacherRef, {
                    status: 'rejected',
                    approved: false,
                    reviewedAt: new Date().toISOString(),
                    reviewedBy: currentUser.uid,
                    reviewedByName: currentUser.displayName || 'Admin'
                });
                
                showSuccess('Teacher rejected successfully!');
                await loadTeacherRequests();
                teacherDetailsModal.style.display = 'none';
                
            } catch (error) {
                showError('Failed to reject teacher: ' + error.message);
            }
        }

        async function revokeTeacher(uid) {
            if (!confirm('Are you sure you want to revoke this teacher\'s approval?')) return;
            
            try {
                const teacherRef = window.firebase.ref(window.firebase.rtdb, `teachers/${uid}`);
                await window.firebase.update(teacherRef, {
                    status: 'pending',
                    approved: false,
                    reviewedAt: new Date().toISOString(),
                    reviewedBy: currentUser.uid,
                    reviewedByName: currentUser.displayName || 'Admin'
                });
                
                showSuccess('Teacher approval revoked successfully!');
                await loadTeacherRequests();
                teacherDetailsModal.style.display = 'none';
                
            } catch (error) {
                showError('Failed to revoke teacher: ' + error.message);
            }
        }

        async function loadStudents() {
            try {
                const studentsRef = window.firebase.ref(window.firebase.rtdb, 'students');
                const snapshot = await window.firebase.get(studentsRef);
                
                students = [];
                if (snapshot.exists()) {
                    const studentsData = snapshot.val();
                    Object.keys(studentsData).forEach(uid => {
                        const student = {
                            uid: uid,
                            ...studentsData[uid]
                        };
                        students.push(student);
                    });
                }
                
                updateStudentsTable();
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Failed to load students');
            }
        }

        function updateStudentsTable() {
            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (students.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-user-graduate" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No students found</h3>
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                
                // Status badge
                let statusBadge = '<span class="status-badge status-approved">Active</span>';
                
                row.innerHTML = `
                    <td>${student.fullName || 'N/A'}</td>
                    <td>${student.grade || 'N/A'}</td>
                    <td>${student.email || 'N/A'}</td>
                    <td>${student.parentPhone || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-xs view-student-btn" data-uid="${student.uid}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function filterTeacherRequests() {
            const statusFilter = document.getElementById('requestStatusFilter')?.value || 'all';
            const searchTerm = document.getElementById('searchRequests')?.value.toLowerCase() || '';
            
            const filteredTeachers = teachers.filter(teacher => {
                // Status filter
                if (statusFilter !== 'all' && teacher.status !== statusFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        teacher.fullName,
                        teacher.email,
                        teacher.subject,
                        teacher.grade,
                        teacher.phone
                    ].filter(Boolean).map(f => f.toLowerCase());
                    
                    return searchFields.some(field => field.includes(searchTerm));
                }
                
                return true;
            });
            
            updateFilteredTeacherRequests(filteredTeachers);
        }

        function updateFilteredTeacherRequests(filteredTeachers) {
            const tableBody = document.getElementById('requestsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No matching requests found</h3>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredTeachers.forEach(teacher => {
                const row = document.createElement('tr');
                
                // Same row creation logic as updateTeacherRequestsTable()
                // ... (copy the row creation code from updateTeacherRequestsTable)
                
                tableBody.appendChild(row);
            });
            
            addTeacherActionListeners();
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchStudents')?.value.toLowerCase() || '';
            
            const filteredStudents = students.filter(student => {
                if (searchTerm) {
                    const searchFields = [
                        student.fullName,
                        student.email,
                        student.grade,
                        student.parentPhone
                    ].filter(Boolean).map(f => f.toLowerCase());
                    
                    return searchFields.some(field => field.includes(searchTerm));
                }
                
                return true;
            });
            
            updateFilteredStudents(filteredStudents);
        }

        function updateFilteredStudents(filteredStudents) {
            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) return;
            
            // Similar logic to updateStudentsTable() but using filteredStudents
        }

        function updateDashboardCounts() {
            const approvedCount = teachers.filter(t => t.status === 'approved').length;
            const pendingCount = teachers.filter(t => t.status === 'pending').length;
            
            document.getElementById('totalApprovedTeachers').textContent = approvedCount;
            document.getElementById('totalPendingRequests').textContent = pendingCount;
            document.getElementById('teacherCount').textContent = approvedCount;
            document.getElementById('pendingRequestsCount').textContent = pendingCount;
            updateNotificationCount(pendingCount);
        }

        async function loadActivityLog() {
            try {
                // This is a simplified version. In a real app, you would load from a dedicated logs collection
                const activityLog = [
                    {
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        activity: 'Dashboard Loaded',
                        details: 'Admin dashboard initialized',
                        status: 'Completed'
                    }
                ];
                
                // Add recent teacher approvals
                const recentApprovals = teachers
                    .filter(t => t.status === 'approved' && t.reviewedAt)
                    .sort((a, b) => new Date(b.reviewedAt) - new Date(a.reviewedAt))
                    .slice(0, 5);
                
                recentApprovals.forEach(teacher => {
                    activityLog.push({
                        time: teacher.reviewedAt ? new Date(teacher.reviewedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A',
                        activity: 'Teacher Approved',
                        details: `${teacher.fullName} - ${teacher.subject}`,
                        status: 'Completed'
                    });
                });
                
                updateActivityLogTable(activityLog);
                
            } catch (error) {
                console.error('Error loading activity log:', error);
            }
        }

        function updateActivityLogTable(activities) {
            const tableBody = document.getElementById('activityLog');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                    <td><span style="color: var(--success); font-weight: 600;">${activity.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ============================
        // ADMIN PANEL UI
        // ============================

        function showAdminPanel() {
            document.getElementById('adminName').textContent = currentUser.displayName || 'Admin User';
            document.getElementById('adminEmail').textContent = currentUser.email;
            document.getElementById('settingsName').value = currentUser.displayName || 'Admin User';
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('adminAvatar').textContent = (currentUser.displayName || 'A').charAt(0).toUpperCase();
            
            authContainer.style.display = 'none';
            adminPanel.style.display = 'block';
        }

        async function updateProfile() {
            const name = document.getElementById('settingsName').value;
            
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            try {
                await window.firebase.updateProfile(window.firebase.auth.currentUser, {
                    displayName: name
                });
                
                currentUser.displayName = name;
                document.getElementById('adminName').textContent = name;
                document.getElementById('adminAvatar').textContent = name.charAt(0).toUpperCase();
                
                localStorage.setItem('schoolAdminUser', JSON.stringify(currentUser));
                
                showSuccess('Profile updated successfully!');
                
            } catch (error) {
                showError('Profile update failed: ' + error.message);
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showError('Please fill both password fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                await window.firebase.updatePassword(window.firebase.auth.currentUser, newPassword);
                
                showSuccess('Password changed successfully!');
                
                document.getElementById('settingsNewPassword').value = '';
                document.getElementById('settingsConfirmPassword').value = '';
                
            } catch (error) {
                showError('Password change failed: ' + error.message);
            }
        }

        // ============================
        // EMAILJS CONFIGURATION
        // ============================

        function loadEmailConfigToForm() {
            document.getElementById('emailjsPublicKey').value = emailConfig.publicKey || '';
            document.getElementById('emailjsServiceId').value = emailConfig.serviceId || '';
            document.getElementById('emailjsTemplateId').value = emailConfig.templateId || '';
            document.getElementById('senderName').value = emailConfig.senderName;
        }

        function saveEmailConfiguration() {
            const publicKey = document.getElementById('emailjsPublicKey').value;
            const serviceId = document.getElementById('emailjsServiceId').value;
            const templateId = document.getElementById('emailjsTemplateId').value;
            const senderName = document.getElementById('senderName').value;
            
            if (!publicKey || !serviceId || !templateId) {
                showError('Please fill all EmailJS configuration fields');
                return;
            }
            
            emailConfig = {
                publicKey: publicKey,
                serviceId: serviceId,
                templateId: templateId,
                senderName: senderName
            };
            
            localStorage.setItem('emailjsConfig', JSON.stringify(emailConfig));
            emailjs.init(publicKey);
            
            showSuccess('Email configuration saved successfully!');
            emailSettingsModal.style.display = 'none';
        }

        async function testEmailConfiguration() {
            if (!currentUser) {
                showError('Please login first to test email configuration');
                return;
            }
            
            if (!emailConfig.publicKey || !emailConfig.serviceId || !emailConfig.templateId) {
                showError('Please save your EmailJS configuration first');
                return;
            }
            
            // ... (same as before)
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }
    </script>
</body>
</html>
