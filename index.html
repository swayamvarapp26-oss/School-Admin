<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHOOL ADMIN - Management Portal</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #3498db;
            --secondary-dark: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #bdc3c7;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 32px;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
        }

        .user-details h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-details p {
            font-size: 14px;
            color: var(--light-gray);
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: white;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
            padding: 30px 0;
            transition: var(--transition);
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 18px 30px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            border-left: 5px solid transparent;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 5px solid var(--secondary);
        }

        .nav-links i {
            font-size: 20px;
            margin-right: 15px;
            width: 25px;
        }

        .nav-count {
            background-color: var(--secondary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .card-notices::before { background: linear-gradient(90deg, #3498db, #2ecc71); }
        .card-teachers::before { background: linear-gradient(90deg, #9b59b6, #e74c3c); }
        .card-students::before { background: linear-gradient(90deg, #f39c12, #d35400); }
        .card-urgent::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 30px;
            color: white;
        }

        .card-notices .card-icon { background: linear-gradient(135deg, #3498db, #2ecc71); }
        .card-teachers .card-icon { background: linear-gradient(135deg, #9b59b6, #e74c3c); }
        .card-students .card-icon { background: linear-gradient(135deg, #f39c12, #d35400); }
        .card-urgent .card-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .dashboard-card h3 {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .dashboard-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .dashboard-card .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--gray);
        }

        .trend.up { color: var(--success); }
        .trend.down { color: var(--danger); }

        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h2 i {
            color: var(--secondary);
        }

        /* Forms */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        /* Buttons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-block {
            width: 100%;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: var(--primary);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 16px;
        }

        tbody tr {
            border-bottom: 1px solid var(--light);
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        td {
            padding: 18px 15px;
            color: var(--dark);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .priority-high { background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .priority-medium { background-color: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .priority-low { background-color: rgba(52, 152, 219, 0.1); color: #3498db; }

        /* Call Button */
        .call-btn {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: var(--transition);
        }

        .call-btn:hover {
            background-color: rgba(46, 204, 113, 0.2);
            color: #219653;
        }

        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-box {
            background-color: white;
            border-radius: 20px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .auth-logo i {
            font-size: 42px;
            color: var(--secondary);
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        .auth-content {
            display: none;
        }

        .auth-content.active {
            display: block;
        }

        .otp-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .otp-input {
            flex: 1;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            transition: var(--transition);
        }

        .otp-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .resend-otp {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
            font-size: 14px;
        }

        .resend-otp a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray);
            font-size: 14px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px 0;
            }
            
            .nav-links {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-links li {
                flex-shrink: 0;
            }
            
            .nav-links a {
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 15px 20px;
            }
            
            .nav-links a:hover, .nav-links a.active {
                border-left: none;
                border-bottom: 3px solid var(--secondary);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .auth-box {
                padding: 30px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screens -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-user-shield"></i>
                    <h1>SCHOOL <span>ADMIN</span></h1>
                </div>
                <p>School Administration Management Portal</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Create Account</div>
                <div class="auth-tab" data-tab="forgot">Reset Password</div>
            </div>
            
            <!-- Login Tab -->
            <div class="auth-content active" id="loginTab">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="admin@school.com" value="admin@school.com">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" value="admin123">
                </div>
                
                <div class="form-group" style="text-align: right;">
                    <a href="#" class="forgot-password-link" style="color: var(--secondary); text-decoration: none; font-size: 14px;">
                        Forgot Password?
                    </a>
                </div>
                
                <button class="btn btn-primary btn-block" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login to Admin Panel
                </button>
                
                <div class="auth-footer">
                    <p>Default Admin Credentials: admin@school.com / admin123</p>
                </div>
            </div>
            
            <!-- Register Tab -->
            <div class="auth-content" id="registerTab">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" class="form-control" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" class="form-control" placeholder="Enter your school email">
                </div>
                
                <div class="form-group">
                    <label>Create Password</label>
                    <input type="password" id="regPassword" class="form-control" placeholder="Create a strong password">
                </div>
                
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="regConfirmPassword" class="form-control" placeholder="Confirm your password">
                </div>
                
                <button class="btn btn-success btn-block" id="registerBtn">
                    <i class="fas fa-user-plus"></i> Create Admin Account
                </button>
                
                <div class="otp-container" id="regOtpContainer" style="display: none;">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                </div>
                
                <div class="resend-otp" id="regResendOtp" style="display: none;">
                    <p>Didn't receive OTP? <a href="#" id="regResendLink">Resend OTP</a></p>
                    <p id="regOtpTimer" style="color: var(--danger); font-weight: 600;"></p>
                </div>
                
                <button class="btn btn-primary btn-block" id="verifyRegOtpBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Verify OTP & Complete Registration
                </button>
            </div>
            
            <!-- Forgot Password Tab -->
            <div class="auth-content" id="forgotTab">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" class="form-control" placeholder="Enter your registered email">
                </div>
                
                <button class="btn btn-primary btn-block" id="sendOtpBtn">
                    <i class="fas fa-paper-plane"></i> Send OTP to Email
                </button>
                
                <div class="otp-container" id="forgotOtpContainer" style="display: none; margin-top: 30px;">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                    <input type="text" class="otp-input" maxlength="1">
                </div>
                
                <div class="resend-otp" id="forgotResendOtp" style="display: none;">
                    <p>Didn't receive OTP? <a href="#" id="forgotResendLink">Resend OTP</a></p>
                    <p id="forgotOtpTimer" style="color: var(--danger); font-weight: 600;"></p>
                </div>
                
                <button class="btn btn-success btn-block" id="verifyOtpBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Verify OTP
                </button>
                
                <div id="resetPasswordForm" style="display: none;">
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                    </div>
                    
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="resetPasswordBtn">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h1>SCHOOL <span>ADMIN</span></h1>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="adminAvatar">A</div>
                <div class="user-details">
                    <h3 id="adminName">Admin User</h3>
                    <p id="adminEmail">admin@school.com</p>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <!-- Main Container -->
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <ul class="nav-links">
                    <li>
                        <a href="#" class="active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="sendNotice">
                            <i class="fas fa-bullhorn"></i>
                            <span>Send Notice</span>
                            <span class="nav-count" id="noticeCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageNotices">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Manage Notices</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageTeachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Manage Teachers</span>
                            <span class="nav-count" id="teacherCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboardSection">
                    <div class="section-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p id="currentDate">Loading date...</p>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card card-notices">
                            <div class="card-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <h3>Total Notices</h3>
                            <div class="number" id="totalNoticesCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>5 sent this week</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-teachers">
                            <div class="card-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h3>Teachers</h3>
                            <div class="number" id="totalTeachersCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>2 new this month</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-students">
                            <div class="card-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3>Students (App Users)</h3>
                            <div class="number" id="totalStudentsCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>45 active today</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-urgent">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Urgent Notices</h3>
                            <div class="number" id="urgentNoticesCount">0</div>
                            <div class="trend down">
                                <i class="fas fa-arrow-down"></i>
                                <span>1 resolved</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityLog">
                                <!-- Activity log will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Send Notice Section -->
                <div class="content-section" id="sendNoticeSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-bullhorn"></i> Send New Notice</h2>
                        <p>Notices will be sent to Teachers & Students apps</p>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label for="noticeTitle">Notice Title *</label>
                            <input type="text" id="noticeTitle" class="form-control" placeholder="Enter notice title">
                        </div>
                        
                        <div class="form-group">
                            <label for="noticeContent">Notice Content *</label>
                            <textarea id="noticeContent" class="form-control textarea" placeholder="Enter notice content..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="noticePriority">Priority Level</label>
                                <select id="noticePriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="noticeCategory">Category</label>
                                <select id="noticeCategory" class="form-control">
                                    <option value="general">General Announcement</option>
                                    <option value="academic">Academic</option>
                                    <option value="exam">Exam Related</option>
                                    <option value="event">School Event</option>
                                    <option value="holiday">Holiday</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Send To *</label>
                            <div style="display: flex; gap: 30px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToTeachers" checked>
                                    <label for="sendToTeachers">All Teachers</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToStudents" checked>
                                    <label for="sendToStudents">All Students</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="button" class="btn btn-primary pulse" id="sendNoticeBtn">
                                <i class="fas fa-paper-plane"></i> Send Notice
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Notices Section -->
                <div class="content-section" id="manageNoticesSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-clipboard-list"></i> Manage Notices</h2>
                        <button class="btn btn-primary" id="refreshNoticesBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                    <th>Sent To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="noticesTableBody">
                                <!-- Notices will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Teachers Section -->
                <div class="content-section" id="manageTeachersSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-chalkboard-teacher"></i> Manage Teachers</h2>
                        <button class="btn btn-success" id="addTeacherBtn">
                            <i class="fas fa-plus"></i> Add Teacher
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Phone Number</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody">
                                <!-- Teachers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="content-section" id="settingsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-user-circle"></i> Account Settings
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="settingsName" class="form-control" value="Admin User">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="settingsEmail" class="form-control" value="admin@school.com" disabled>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="updateProfileBtn">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                        
                        <div class="form-group" style="margin-top: 40px;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-key"></i> Change Password
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                        </div>
                        
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="settingsNewPassword" class="form-control" placeholder="Enter new password">
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="settingsConfirmPassword" class="form-control" placeholder="Confirm new password">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add Teacher Modal -->
    <div class="modal" id="addTeacherModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Teacher</h3>
                <button class="close-modal" id="closeTeacherModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="teacherName" class="form-control" placeholder="Enter teacher's full name">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Subject *</label>
                    <input type="text" id="teacherSubject" class="form-control" placeholder="e.g., Mathematics">
                </div>
                
                <div class="form-group">
                    <label>Grade/Class</label>
                    <input type="text" id="teacherGrade" class="form-control" placeholder="e.g., Grade 10">
                </div>
            </div>
            
            <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" id="teacherPhone" class="form-control" placeholder="+91 9876543210">
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="teacherEmail" class="form-control" placeholder="teacher@school.com">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveTeacherBtn">
                    <i class="fas fa-save"></i> Save Teacher
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Confirm Delete</h3>
                <button class="close-modal" id="closeDeleteModal">&times;</button>
            </div>
            
            <div class="form-group">
                <p id="deleteMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div id="successMessage" style="display: none; position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <div>
                <h4 style="margin-bottom: 5px;">Success!</h4>
                <p id="successText">Operation completed successfully.</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase Configuration and App Logic -->
    <script>
        // ============================
        // CONFIGURATION SECTION
        // ============================
        
        // 1. FIREBASE CONFIGURATION
        // REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
  authDomain: "schooladmin-51cdd.firebaseapp.com",
  databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
  projectId: "schooladmin-51cdd",
  storageBucket: "schooladmin-51cdd.firebasestorage.app",
  messagingSenderId: "185301938780",
  appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
  measurementId: "G-V8C5DE930K"
};


        // 2. EMAILJS CONFIGURATION
        // REPLACE WITH YOUR ACTUAL EMAILJS CREDENTIALS
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: "D-8liyb21zvqmvhPc",      // Get from EmailJS Dashboard → Integration
            SERVICE_ID: "service_u035226",      // Get from EmailJS → Email Services
            TEMPLATE_ID: "D-8liyb21zvqmvhPc"     // Get from EmailJS → Email Templates
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize EmailJS
        emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
        // ============================
        // APPLICATION STATE
        // ============================
        let currentUser = null;
        let currentAdmin = null;
        let notices = [];
        let teachers = [];
        let activityLog = [];
        let itemToDelete = null;
        let deleteType = null;
        
        // OTP Storage (in production, use database)
        const otpStorage = {};

        // ============================
        // EMAILJS OTP FUNCTIONS
        // ============================

        // Generate 6-digit OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Send OTP via EmailJS
        async function sendOTPEmail(email, name, purpose = 'verification') {
            try {
                // Generate OTP
                const otpCode = generateOTP();
                
                // Store OTP with timestamp (10 minutes expiry)
                otpStorage[email] = {
                    code: otpCode,
                    expires: Date.now() + 10 * 60 * 1000, // 10 minutes
                    purpose: purpose,
                    timestamp: new Date().toISOString()
                };
                
                // Prepare email parameters
                const templateParams = {
                    user_name: name || 'User',
                    otp_code: otpCode,
                    action_type: purpose === 'registration' ? 'account creation' : 'password reset',
                    to_email: email,
                    timestamp: new Date().toLocaleString(),
                    school_name: 'School Admin System'
                };
                
                // Send email using EmailJS
                const response = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ID,
                    templateParams
                );
                
                console.log('✅ OTP email sent successfully:', response.status, response.text);
                return {
                    success: true,
                    message: 'OTP sent to your email! Please check your inbox.',
                    otp: otpCode // For testing only
                };
                
            } catch (error) {
                console.error('❌ Failed to send OTP:', error);
                return {
                    success: false,
                    message: 'Failed to send OTP. Please try again in a moment.'
                };
            }
        }

        // Verify OTP
        function verifyOTP(email, enteredOTP, purpose = 'verification') {
            const storedData = otpStorage[email];
            
            // Check if OTP exists
            if (!storedData) {
                return {
                    valid: false,
                    message: 'No OTP found. Please request a new one.'
                };
            }
            
            // Check if OTP expired
            if (Date.now() > storedData.expires) {
                delete otpStorage[email];
                return {
                    valid: false,
                    message: 'OTP has expired. Please request a new one.'
                };
            }
            
            // Check if purpose matches
            if (storedData.purpose !== purpose) {
                return {
                    valid: false,
                    message: 'Invalid OTP purpose.'
                };
            }
            
            // Verify OTP code
            if (storedData.code === enteredOTP) {
                delete otpStorage[email]; // Clear OTP after successful verification
                return {
                    valid: true,
                    message: 'OTP verified successfully!'
                };
            }
            
            return {
                valid: false,
                message: 'Invalid OTP. Please try again.'
            };
        }

        // Resend OTP
        async function resendOTP(email, name, purpose = 'verification') {
            // Clear old OTP first
            delete otpStorage[email];
            
            // Send new OTP
            return await sendOTPEmail(email, name, purpose);
        }

        // ============================
        // DOM ELEMENTS
        // ============================
        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminName = document.getElementById('adminName');
        const adminEmail = document.getElementById('adminEmail');
        const adminAvatar = document.getElementById('adminAvatar');
        
        // Auth Elements
        const authTabs = document.querySelectorAll('.auth-tab');
        const authContents = document.querySelectorAll('.auth-content');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const verifyRegOtpBtn = document.getElementById('verifyRegOtpBtn');
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-links a');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Dashboard Elements
        const totalNoticesCount = document.getElementById('totalNoticesCount');
        const totalTeachersCount = document.getElementById('totalTeachersCount');
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const urgentNoticesCount = document.getElementById('urgentNoticesCount');
        const noticeCount = document.getElementById('noticeCount');
        const teacherCount = document.getElementById('teacherCount');
        const activityLogTable = document.getElementById('activityLog');
        const currentDateElement = document.getElementById('currentDate');
        
        // Notice Elements
        const sendNoticeBtn = document.getElementById('sendNoticeBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const refreshNoticesBtn = document.getElementById('refreshNoticesBtn');
        const noticesTableBody = document.getElementById('noticesTableBody');
        
        // Teacher Elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const teachersTableBody = document.getElementById('teachersTableBody');
        const saveTeacherBtn = document.getElementById('saveTeacherBtn');
        const cancelTeacherBtn = document.getElementById('cancelTeacherBtn');
        
        // Modal Elements
        const addTeacherModal = document.getElementById('addTeacherModal');
        const deleteModal = document.getElementById('deleteModal');
        const closeTeacherModal = document.getElementById('closeTeacherModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // Settings Elements
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Success Message
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // ============================
        // INITIALIZE APPLICATION
        // ============================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            currentDateElement.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Check if user is already logged in
            checkAuthState();
            
            // Load sample data for demo
            loadSampleData();
        });

        // ============================
        // EVENT LISTENERS SETUP
        // ============================
        function setupEventListeners() {
            // Auth Tab Switching
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Update active tab
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    authContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId + 'Tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // Forgot password link
            document.querySelector('.forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                authTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.auth-tab[data-tab="forgot"]').classList.add('active');
                authContents.forEach(content => content.classList.remove('active'));
                document.getElementById('forgotTab').classList.add('active');
            });

            // Login
            loginBtn.addEventListener('click', handleLogin);
            
            // Register
            registerBtn.addEventListener('click', handleRegister);
            
            // Send OTP for password reset
            sendOtpBtn.addEventListener('click', handleSendOtp);
            
            // Verify OTP for password reset
            verifyOtpBtn.addEventListener('click', handleVerifyOtp);
            
            // Reset Password
            resetPasswordBtn.addEventListener('click', handleResetPassword);
            
            // Verify OTP for registration
            verifyRegOtpBtn.addEventListener('click', handleVerifyRegOtp);
            
            // Resend OTP links
            document.getElementById('regResendLink')?.addEventListener('click', handleResendRegOtp);
            document.getElementById('forgotResendLink')?.addEventListener('click', handleResendForgotOtp);

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = link.dataset.section + 'Section';
                    contentSections.forEach(section => {
                        section.style.display = 'none';
                        if (section.id === sectionId) {
                            section.style.display = 'block';
                        }
                    });
                    
                    // Load section data if needed
                    if (sectionId === 'manageNoticesSection') {
                        loadNoticesTable();
                    } else if (sectionId === 'manageTeachersSection') {
                        loadTeachersTable();
                    }
                });
            });

            // Notice Management
            sendNoticeBtn.addEventListener('click', sendNotice);
            saveDraftBtn.addEventListener('click', saveNoticeAsDraft);
            refreshNoticesBtn.addEventListener('click', loadNoticesTable);

            // Teacher Management
            addTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'flex';
            });
            
            saveTeacherBtn.addEventListener('click', saveTeacher);
            cancelTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            closeTeacherModal.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });

            // Modal Controls
            closeDeleteModal.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
            });
            
            cancelDeleteBtn.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
            });
            
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            // Settings
            updateProfileBtn.addEventListener('click', updateProfile);
            changePasswordBtn.addEventListener('click', changePassword);
            logoutBtn.addEventListener('click', handleLogout);

            // OTP Input Handling
            setupOtpInputs();
        }

        // ============================
        // FIREBASE AUTHENTICATION FUNCTIONS
        // ============================
        function checkAuthState() {
            // For demo purposes, we'll simulate checking auth state
            // In real implementation, use: auth.onAuthStateChanged(user => {...})
            
            // Check if user is stored in localStorage (for demo)
            const storedUser = localStorage.getItem('schoolAdminUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showAdminPanel();
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            // Show loading
            const btn = loginBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE IMPLEMENTATION
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Fetch admin data from Firestore
                const adminDoc = await db.collection('admins').doc(currentUser.uid).get();
                
                if (adminDoc.exists) {
                    currentAdmin = adminDoc.data();
                    
                    // Store in localStorage for demo
                    localStorage.setItem('schoolAdminUser', JSON.stringify({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName || 'Admin User'
                    }));
                    
                    showSuccess('Login successful!');
                    showAdminPanel();
                } else {
                    showError('Admin account not found');
                    await auth.signOut();
                }
                
            } catch (error) {
                // For demo - simulate Firebase auth
                if (email === 'admin@school.com' && password === 'admin123') {
                    currentUser = {
                        uid: 'admin001',
                        email: email,
                        displayName: 'Admin User',
                        photoURL: null
                    };
                    
                    // Store in localStorage for demo
                    localStorage.setItem('schoolAdminUser', JSON.stringify(currentUser));
                    
                    showSuccess('Login successful!');
                    showAdminPanel();
                } else {
                    showError('Invalid email or password: ' + error.message);
                }
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            // Validation
            if (!name || !email || !password || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            // Show loading
            const btn = registerBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
            btn.disabled = true;
            
            try {
                // Send OTP via EmailJS
                const result = await sendOTPEmail(email, name, 'registration');
                
                if (result.success) {
                    showSuccess(result.message);
                    
                    // Store registration data temporarily
                    window.pendingRegistration = { name, email, password };
                    
                    // Show OTP section
                    document.getElementById('regOtpContainer').style.display = 'flex';
                    document.getElementById('regResendOtp').style.display = 'block';
                    document.getElementById('verifyRegOtpBtn').style.display = 'block';
                    document.getElementById('registerBtn').style.display = 'none';
                    
                    // Auto-focus first OTP input
                    setTimeout(() => {
                        document.querySelector('#regOtpContainer .otp-input').focus();
                    }, 100);
                    
                    // Start OTP timer
                    startOtpTimer('reg', email, name, 'registration');
                    
                    // For testing only - log OTP to console
                    console.log('📧 Test OTP for registration:', result.otp);
                    
                } else {
                    showError(result.message);
                }
                
            } catch (error) {
                showError('Failed to send OTP. Please try again.');
                console.error(error);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleVerifyRegOtp() {
            const otp = getOtpValue('reg');
            
            if (!otp || otp.length !== 6) {
                showError('Please enter a valid 6-digit OTP');
                return;
            }
            
            const { name, email, password } = window.pendingRegistration || {};
            
            if (!email) {
                showError('Registration data not found. Please start over.');
                return;
            }
            
            // Verify OTP
            const verification = verifyOTP(email, otp, 'registration');
            
            if (!verification.valid) {
                showError(verification.message);
                return;
            }
            
            // Show loading
            const btn = verifyRegOtpBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE REGISTRATION
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Update profile with name
                await currentUser.updateProfile({
                    displayName: name
                });
                
                // Send email verification
                await currentUser.sendEmailVerification();
                
                // Store admin data in Firestore
                await db.collection('admins').doc(currentUser.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null,
                    isActive: true,
                    role: 'admin'
                });
                
                showSuccess('Account created successfully! Please check your email to verify your account.');
                
                // Switch to login tab
                document.querySelector('.auth-tab[data-tab="login"]').click();
                
                // Reset form
                document.getElementById('regOtpContainer').style.display = 'none';
                document.getElementById('regResendOtp').style.display = 'none';
                document.getElementById('verifyRegOtpBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'block';
                
                clearRegistrationForm();
                delete window.pendingRegistration;
                
            } catch (error) {
                showError('Registration failed: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleSendOtp() {
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Show loading
            const btn = sendOtpBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
            btn.disabled = true;
            
            try {
                // Check if email exists in Firebase
                const methods = await auth.fetchSignInMethodsForEmail(email);
                if (methods.length === 0) {
                    showError('No account found with this email address');
                    return;
                }
                
                // Send OTP via EmailJS
                const result = await sendOTPEmail(email, 'User', 'password_reset');
                
                if (result.success) {
                    showSuccess(result.message);
                    
                    // Store email for verification
                    window.pendingPasswordReset = email;
                    
                    // Show OTP section
                    document.getElementById('forgotOtpContainer').style.display = 'flex';
                    document.getElementById('forgotResendOtp').style.display = 'block';
                    document.getElementById('verifyOtpBtn').style.display = 'block';
                    document.getElementById('sendOtpBtn').style.display = 'none';
                    
                    // Auto-focus first OTP input
                    setTimeout(() => {
                        document.querySelector('#forgotOtpContainer .otp-input').focus();
                    }, 100);
                    
                    // Start OTP timer
                    startOtpTimer('forgot', email, 'User', 'password_reset');
                    
                    // For testing only - log OTP to console
                    console.log('📧 Test OTP for password reset:', result.otp);
                    
                } else {
                    showError(result.message);
                }
                
            } catch (error) {
                showError('Failed to send OTP. Please try again.');
                console.error(error);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleVerifyOtp() {
            const otp = getOtpValue('forgot');
            
            if (!otp || otp.length !== 6) {
                showError('Please enter a valid 6-digit OTP');
                return;
            }
            
            const email = window.pendingPasswordReset;
            
            if (!email) {
                showError('Session expired. Please start over.');
                return;
            }
            
            // Verify OTP
            const verification = verifyOTP(email, otp, 'password_reset');
            
            if (verification.valid) {
                showSuccess('OTP verified! You can now reset your password.');
                
                // Show password reset form
                document.getElementById('resetPasswordForm').style.display = 'block';
                document.getElementById('verifyOtpBtn').style.display = 'none';
                document.getElementById('forgotOtpContainer').style.display = 'none';
                document.getElementById('forgotResendOtp').style.display = 'none';
            } else {
                showError(verification.message);
            }
        }

        async function handleResetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const email = window.pendingPasswordReset;
            
            if (!email) {
                showError('Session expired. Please start over.');
                return;
            }
            
            if (!newPassword || !confirmNewPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            // Show loading
            const btn = resetPasswordBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting password...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE PASSWORD RESET
                await auth.sendPasswordResetEmail(email);
                
                showSuccess('Password reset email sent! Please check your inbox for reset instructions.');
                
                // Switch to login tab
                document.querySelector('.auth-tab[data-tab="login"]').click();
                
                // Reset form
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('sendOtpBtn').style.display = 'block';
                document.getElementById('forgotEmail').value = '';
                document.getElementById('forgotOtpContainer').style.display = 'none';
                document.getElementById('forgotResendOtp').style.display = 'none';
                
                delete window.pendingPasswordReset;
                
            } catch (error) {
                showError('Password reset failed: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleResendRegOtp(e) {
            e.preventDefault();
            const email = window.pendingRegistration?.email;
            const name = window.pendingRegistration?.name;
            
            if (!email) {
                showError('Session expired. Please start over.');
                return;
            }
            
            const result = await resendOTP(email, name, 'registration');
            
            if (result.success) {
                showSuccess('New OTP sent to your email!');
                
                // Restart timer
                if (window.regTimer) {
                    clearInterval(window.regTimer);
                }
                startOtpTimer('reg', email, name, 'registration');
            } else {
                showError(result.message);
            }
        }

        async function handleResendForgotOtp(e) {
            e.preventDefault();
            const email = window.pendingPasswordReset;
            
            if (!email) {
                showError('Session expired. Please start over.');
                return;
            }
            
            const result = await resendOTP(email, 'User', 'password_reset');
            
            if (result.success) {
                showSuccess('New OTP sent to your email!');
                
                // Restart timer
                if (window.forgotTimer) {
                    clearInterval(window.forgotTimer);
                }
                startOtpTimer('forgot', email, 'User', 'password_reset');
            } else {
                showError(result.message);
            }
        }

        function handleLogout() {
            // Clear local storage
            localStorage.removeItem('schoolAdminUser');
            
            // Reset app state
            currentUser = null;
            currentAdmin = null;
            
            // Show auth screen
            authContainer.style.display = 'flex';
            adminPanel.style.display = 'none';
            
            // Reset forms
            clearLoginForm();
            
            showSuccess('Logged out successfully!');
        }

        // ============================
        // OTP HELPER FUNCTIONS
        // ============================
        function setupOtpInputs() {
            // For registration OTP
            const regOtpInputs = document.querySelectorAll('#regOtpContainer .otp-input');
            setupOtpInputBehavior(regOtpInputs);
            
            // For forgot password OTP
            const forgotOtpInputs = document.querySelectorAll('#forgotOtpContainer .otp-input');
            setupOtpInputBehavior(forgotOtpInputs);
        }

        function setupOtpInputBehavior(inputs) {
            inputs.forEach((input, index) => {
                // Clear input on focus
                input.addEventListener('focus', () => {
                    input.value = '';
                });
                
                input.addEventListener('input', (e) => {
                    // Allow only numbers
                    input.value = input.value.replace(/\D/g, '');
                    
                    // Auto-focus next input
                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    
                    // Enable paste
                    if (input.value.length > 1) {
                        const pastedValue = input.value.replace(/\D/g, '');
                        for (let i = 0; i < Math.min(pastedValue.length, inputs.length); i++) {
                            inputs[i].value = pastedValue[i];
                            if (i < inputs.length - 1) {
                                inputs[i + 1].focus();
                            }
                        }
                        input.value = pastedValue[0] || '';
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    // Handle backspace
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = '';
                    }
                    
                    // Handle arrow keys
                    if (e.key === 'ArrowLeft' && index > 0) {
                        inputs[index - 1].focus();
                    }
                    if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
            });
        }

        function getOtpValue(type) {
            const containerId = type === 'reg' ? 'regOtpContainer' : 'forgotOtpContainer';
            const inputs = document.querySelectorAll(`#${containerId} .otp-input`);
            let otp = '';
            inputs.forEach(input => {
                otp += input.value;
            });
            return otp;
        }

        function startOtpTimer(type, email, name, purpose) {
            const timerId = type === 'reg' ? 'regOtpTimer' : 'forgotOtpTimer';
            const timerElement = document.getElementById(timerId);
            const resendLinkId = type === 'reg' ? 'regResendLink' : 'forgotResendLink';
            const resendLink = document.getElementById(resendLinkId);
            
            let timeLeft = 600; // 10 minutes in seconds
            
            // Disable resend link initially
            resendLink.style.pointerEvents = 'none';
            resendLink.style.opacity = '0.5';
            resendLink.textContent = 'Resend OTP';
            resendLink.classList.remove('resend-active');
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `OTP expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                timerElement.style.color = timeLeft < 60 ? 'var(--danger)' : 'var(--gray)';
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timer);
                    timerElement.textContent = 'OTP expired';
                    timerElement.style.color = 'var(--danger)';
                    
                    // Enable resend link
                    resendLink.style.pointerEvents = 'auto';
                    resendLink.style.opacity = '1';
                    resendLink.textContent = 'Resend OTP';
                    resendLink.classList.add('resend-active');
                }
            }, 1000);
            
            // Store timer reference
            window[`${type}Timer`] = timer;
        }

        // ============================
        // ADMIN PANEL FUNCTIONS
        // ============================
        function showAdminPanel() {
            // Update user info
            adminName.textContent = currentUser.displayName || 'Admin User';
            adminEmail.textContent = currentUser.email;
            adminAvatar.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'A';
            
            // Switch to admin panel
            authContainer.style.display = 'none';
            adminPanel.style.display = 'block';
            
            // Load dashboard data
            loadDashboardData();
        }

        function loadDashboardData() {
            // Update counts
            totalNoticesCount.textContent = notices.length;
            totalTeachersCount.textContent = teachers.length;
            totalStudentsCount.textContent = '2847'; // Simulated data
            urgentNoticesCount.textContent = notices.filter(n => n.priority === 'high').length;
            noticeCount.textContent = notices.length;
            teacherCount.textContent = teachers.length;
            
            // Load activity log
            loadActivityLog();
        }

        function loadActivityLog() {
            // Simulated activity data
            const activities = [
                { time: '10:30 AM', activity: 'Sent Notice', details: 'Annual Sports Day Announcement', status: 'Completed' },
                { time: 'Yesterday, 3:15 PM', activity: 'Added Teacher', details: 'Mr. John Smith - Mathematics', status: 'Completed' },
                { time: 'Mar 12, 9:45 AM', activity: 'Deleted Notice', details: 'Old Library Schedule', status: 'Completed' },
                { time: 'Mar 10, 2:20 PM', activity: 'Password Changed', details: 'Account security update', status: 'Completed' },
                { time: 'Mar 8, 11:05 AM', activity: 'Sent Notice', details: 'Parent-Teacher Meeting Schedule', status: 'Completed' }
            ];
            
            activityLogTable.innerHTML = '';
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                    <td><span style="color: var(--success); font-weight: 600;">${activity.status}</span></td>
                `;
                activityLogTable.appendChild(row);
            });
        }

        // ============================
        // NOTICE MANAGEMENT FUNCTIONS
        // ============================
        async function sendNotice() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const priority = document.getElementById('noticePriority').value;
            const category = document.getElementById('noticeCategory').value;
            const sendToTeachers = document.getElementById('sendToTeachers').checked;
            const sendToStudents = document.getElementById('sendToStudents').checked;
            
            if (!title || !content) {
                showError('Please enter notice title and content');
                return;
            }
            
            if (!sendToTeachers && !sendToStudents) {
                showError('Please select at least one recipient group');
                return;
            }
            
            // Show loading
            const btn = sendNoticeBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE IMPLEMENTATION
                const noticeRef = await db.collection('notices').add({
                    title: title,
                    content: content,
                    priority: priority,
                    category: category,
                    recipients: {
                        teachers: sendToTeachers,
                        students: sendToStudents
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent',
                    sentBy: currentUser.uid,
                    sentByName: currentUser.displayName || 'Admin'
                });
                
                showSuccess('Notice sent successfully to Teachers & Students apps!');
                
                // Create notice object for local state
                const notice = {
                    id: noticeRef.id,
                    title: title,
                    content: content,
                    priority: priority,
                    category: category,
                    recipients: {
                        teachers: sendToTeachers,
                        students: sendToStudents
                    },
                    timestamp: new Date().toISOString(),
                    status: 'sent',
                    sentBy: currentUser.displayName || 'Admin'
                };
                
                // Add to notices array
                notices.unshift(notice);
                
                // Update dashboard
                loadDashboardData();
                
                // Clear form
                clearNoticeForm();
                
                // If on manage notices tab, refresh
                if (document.getElementById('manageNoticesSection').style.display === 'block') {
                    loadNoticesTable();
                }
                
                // Log activity
                addActivityLog('Sent Notice', title);
                
            } catch (error) {
                showError('Failed to send notice: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function saveNoticeAsDraft() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            
            if (!title || !content) {
                showError('Please enter notice title and content to save as draft');
                return;
            }
            
            showSuccess('Notice saved as draft successfully!');
            
            // Log activity
            addActivityLog('Saved Draft', title);
        }

        async function loadNoticesTable() {
            // Show loading
            refreshNoticesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            refreshNoticesBtn.disabled = true;
            
            try {
                // REAL FIREBASE IMPLEMENTATION
                const querySnapshot = await db.collection('notices')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                notices = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    notices.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // Clear table
                noticesTableBody.innerHTML = '';
                
                // Check if we have notices
                if (notices.length === 0) {
                    noticesTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No notices found</h3>
                                <p>Send your first notice using the "Send Notice" tab</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add notices to table
                notices.forEach(notice => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = new Date(notice.timestamp);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    // Priority badge
                    let priorityBadge = '';
                    if (notice.priority === 'high') {
                        priorityBadge = '<span class="priority-badge priority-high">High</span>';
                    } else if (notice.priority === 'medium') {
                        priorityBadge = '<span class="priority-badge priority-medium">Medium</span>';
                    } else {
                        priorityBadge = '<span class="priority-badge priority-low">Low</span>';
                    }
                    
                    // Recipients text
                    let recipientsText = '';
                    if (notice.recipients?.teachers && notice.recipients?.students) {
                        recipientsText = 'All Teachers & Students';
                    } else if (notice.recipients?.teachers) {
                        recipientsText = 'Teachers Only';
                    } else if (notice.recipients?.students) {
                        recipientsText = 'Students Only';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${notice.title}</strong></td>
                        <td>${notice.category || 'General'}</td>
                        <td>${priorityBadge}</td>
                        <td>${formattedDate}</td>
                        <td>${recipientsText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm view-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    noticesTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const noticeId = this.dataset.id;
                        showDeleteConfirmation('notice', noticeId, 'Are you sure you want to delete this notice?');
                    });
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-notice-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const noticeId = this.dataset.id;
                        viewNotice(noticeId);
                    });
                });
                
            } catch (error) {
                showError('Failed to load notices: ' + error.message);
            } finally {
                // Reset button
                refreshNoticesBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshNoticesBtn.disabled = false;
            }
        }

        function viewNotice(noticeId) {
            const notice = notices.find(n => n.id === noticeId);
            if (!notice) return;
            
            alert(`Notice Details:\n\nTitle: ${notice.title}\n\nContent: ${notice.content}\n\nPriority: ${notice.priority}\n\nCategory: ${notice.category}\n\nSent to: ${notice.recipients?.teachers ? 'Teachers' : ''}${notice.recipients?.teachers && notice.recipients?.students ? ' & ' : ''}${notice.recipients?.students ? 'Students' : ''}\n\nDate: ${new Date(notice.timestamp).toLocaleString()}`);
        }

        // ============================
        // TEACHER MANAGEMENT FUNCTIONS
        // ============================
        async function loadTeachersTable() {
            try {
                // REAL FIREBASE IMPLEMENTATION
                const querySnapshot = await db.collection('teachers').get();
                
                teachers = [];
                querySnapshot.forEach(doc => {
                    teachers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Clear table
                teachersTableBody.innerHTML = '';
                
                // Check if we have teachers
                if (teachers.length === 0) {
                    teachersTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No teachers added yet</h3>
                                <p>Add your first teacher using the "Add Teacher" button</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add teachers to table
                teachers.forEach(teacher => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><strong>${teacher.name}</strong></td>
                        <td>${teacher.subject}</td>
                        <td>${teacher.phone}</td>
                        <td>${teacher.email || 'Not provided'}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="tel:${teacher.phone}" class="call-btn" target="_blank">
                                    <i class="fas fa-phone"></i> Call
                                </a>
                                <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    teachersTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        showDeleteConfirmation('teacher', teacherId, 'Are you sure you want to delete this teacher?');
                    });
                });
                
            } catch (error) {
                showError('Failed to load teachers: ' + error.message);
            }
        }

        async function saveTeacher() {
            const name = document.getElementById('teacherName').value;
            const subject = document.getElementById('teacherSubject').value;
            const grade = document.getElementById('teacherGrade').value;
            const phone = document.getElementById('teacherPhone').value;
            const email = document.getElementById('teacherEmail').value;
            
            if (!name || !subject || !phone) {
                showError('Please fill all required fields (Name, Subject, Phone)');
                return;
            }
            
            // Show loading
            const btn = saveTeacherBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE IMPLEMENTATION
                const teacherRef = await db.collection('teachers').add({
                    name: name,
                    subject: subject,
                    grade: grade,
                    phone: phone,
                    email: email,
                    addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: currentUser.uid,
                    addedByName: currentUser.displayName || 'Admin'
                });
                
                showSuccess('Teacher added successfully!');
                
                // Create teacher object for local state
                const teacher = {
                    id: teacherRef.id,
                    name: name,
                    subject: subject,
                    grade: grade,
                    phone: phone,
                    email: email,
                    addedDate: new Date().toISOString(),
                    addedBy: currentUser.displayName || 'Admin'
                };
                
                // Add to teachers array
                teachers.push(teacher);
                
                // Close modal
                document.getElementById('addTeacherModal').style.display = 'none';
                
                // Update dashboard
                loadDashboardData();
                
                // If on manage teachers tab, refresh
                if (document.getElementById('manageTeachersSection').style.display === 'block') {
                    loadTeachersTable();
                }
                
                // Clear form
                clearTeacherForm();
                
                // Log activity
                addActivityLog('Added Teacher', `${name} - ${subject}`);
                
            } catch (error) {
                showError('Failed to add teacher: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherGrade').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherEmail').value = '';
        }

        // ============================
        // DELETE FUNCTIONS
        // ============================
        function showDeleteConfirmation(type, id, message) {
            itemToDelete = id;
            deleteType = type;
            
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        async function confirmDelete() {
            if (!itemToDelete || !deleteType) return;
            
            // Show loading
            confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            confirmDeleteBtn.disabled = true;
            
            try {
                if (deleteType === 'notice') {
                    // REAL FIREBASE IMPLEMENTATION
                    await db.collection('notices').doc(itemToDelete).delete();
                    
                    // Remove from local state
                    const index = notices.findIndex(n => n.id === itemToDelete);
                    if (index !== -1) {
                        const noticeTitle = notices[index].title;
                        notices.splice(index, 1);
                        
                        showSuccess(`Notice "${noticeTitle}" deleted successfully!`);
                        addActivityLog('Deleted Notice', noticeTitle);
                    }
                    
                    // Update UI
                    loadDashboardData();
                    if (document.getElementById('manageNoticesSection').style.display === 'block') {
                        loadNoticesTable();
                    }
                    
                } else if (deleteType === 'teacher') {
                    // REAL FIREBASE IMPLEMENTATION
                    await db.collection('teachers').doc(itemToDelete).delete();
                    
                    // Remove from local state
                    const index = teachers.findIndex(t => t.id === itemToDelete);
                    if (index !== -1) {
                        const teacherName = teachers[index].name;
                        teachers.splice(index, 1);
                        
                        showSuccess(`Teacher "${teacherName}" deleted successfully!`);
                        addActivityLog('Deleted Teacher', teacherName);
                    }
                    
                    // Update UI
                    loadDashboardData();
                    if (document.getElementById('manageTeachersSection').style.display === 'block') {
                        loadTeachersTable();
                    }
                }
                
            } catch (error) {
                showError('Failed to delete: ' + error.message);
            } finally {
                // Close modal
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
                
                // Reset button
                confirmDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                confirmDeleteBtn.disabled = false;
            }
        }

        // ============================
        // SETTINGS FUNCTIONS
        // ============================
        async function updateProfile() {
            const name = document.getElementById('settingsName').value;
            
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            // Show loading
            const btn = updateProfileBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            btn.disabled = true;
            
            try {
                // Update in Firestore
                await db.collection('admins').doc(currentUser.uid).update({
                    name: name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update in Firebase Auth
                await currentUser.updateProfile({
                    displayName: name
                });
                
                // Update local state
                currentUser.displayName = name;
                adminName.textContent = name;
                adminAvatar.textContent = name.charAt(0).toUpperCase();
                
                // Update localStorage for demo
                localStorage.setItem('schoolAdminUser', JSON.stringify({
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: name
                }));
                
                showSuccess('Profile updated successfully!');
                addActivityLog('Updated Profile', 'Changed display name');
                
            } catch (error) {
                showError('Failed to update profile: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('New password must be at least 6 characters');
                return;
            }
            
            // Show loading
            const btn = changePasswordBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
            btn.disabled = true;
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Change password
                await currentUser.updatePassword(newPassword);
                
                showSuccess('Password changed successfully!');
                
                // Clear form
                document.getElementById('currentPassword').value = '';
                document.getElementById('settingsNewPassword').value = '';
                document.getElementById('settingsConfirmPassword').value = '';
                
                // Log activity
                addActivityLog('Changed Password', 'Account security update');
                
            } catch (error) {
                showError('Failed to change password: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function loadSampleData() {
            // Sample notices (for demo when Firebase is not connected)
            notices = [
                {
                    id: 'notice_1',
                    title: 'Annual Sports Day Announcement',
                    content: 'We are pleased to announce that our Annual Sports Day will be held on 25th November 2023. All students are required to participate in at least one event. Teachers are requested to coordinate with the sports department.',
                    priority: 'high',
                    category: 'event',
                    recipients: { teachers: true, students: true },
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                },
                {
                    id: 'notice_2',
                    title: 'Library Maintenance Notice',
                    content: 'The main library will be closed for maintenance on 5th October 2023. Students can use the digital library during this period. All borrowed books must be returned by 4th October.',
                    priority: 'medium',
                    category: 'academic',
                    recipients: { teachers: false, students: true },
                    timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                },
                {
                    id: 'notice_3',
                    title: 'Parent-Teacher Meeting Schedule',
                    content: 'Meeting scheduled for all classes from 10th to 15th October 2023. Parents are requested to book their slots through the portal. Teachers should prepare progress reports.',
                    priority: 'high',
                    category: 'general',
                    recipients: { teachers: true, students: true },
                    timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                }
            ];
            
            // Sample teachers (for demo when Firebase is not connected)
            teachers = [
                {
                    id: 'teacher_1',
                    name: 'Mr. John Smith',
                    subject: 'Mathematics',
                    grade: 'Grade 10',
                    phone: '+91 9876543210',
                    email: 'john.smith@school.com',
                    addedDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin'
                },
                {
                    id: 'teacher_2',
                    name: 'Ms. Sarah Johnson',
                    subject: 'Science',
                    grade: 'Grade 9 & 10',
                    phone: '+91 9876543211',
                    email: 'sarah.j@school.com',
                    addedDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin'
                },
                {
                    id: 'teacher_3',
                    name: 'Mr. Robert Williams',
                    subject: 'English Literature',
                    grade: 'Grade 11 & 12',
                    phone: '+91 9876543212',
                    email: 'robert.w@school.com',
                    addedDate: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin'
                }
            ];
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function clearNoticeForm() {
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('noticePriority').value = 'low';
            document.getElementById('noticeCategory').value = 'general';
            document.getElementById('sendToTeachers').checked = true;
            document.getElementById('sendToStudents').checked = true;
        }

        function clearLoginForm() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function clearRegistrationForm() {
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
        }

        function addActivityLog(activity, details) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Add to beginning of array
            activityLog.unshift({
                time: timeString,
                activity: activity,
                details: details,
                status: 'Completed'
            });
            
            // Update activity log table if on dashboard
            if (document.getElementById('dashboardSection').style.display === 'block') {
                loadActivityLog();
            }
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }
    </script>
</body>
</html>
