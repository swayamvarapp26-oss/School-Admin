<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHOOL ADMIN - Management Portal</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #3498db;
            --secondary-dark: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #bdc3c7;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 32px;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
            object-fit: cover;
        }

        .user-details h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-details p {
            font-size: 14px;
            color: var(--light-gray);
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: white;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
            padding: 30px 0;
            transition: var(--transition);
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 18px 30px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            border-left: 5px solid transparent;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 5px solid var(--secondary);
        }

        .nav-links i {
            font-size: 20px;
            margin-right: 15px;
            width: 25px;
        }

        .nav-count {
            background-color: var(--secondary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .card-notices::before { background: linear-gradient(90deg, #3498db, #2ecc71); }
        .card-teachers::before { background: linear-gradient(90deg, #9b59b6, #e74c3c); }
        .card-students::before { background: linear-gradient(90deg, #f39c12, #d35400); }
        .card-urgent::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 30px;
            color: white;
        }

        .card-notices .card-icon { background: linear-gradient(135deg, #3498db, #2ecc71); }
        .card-teachers .card-icon { background: linear-gradient(135deg, #9b59b6, #e74c3c); }
        .card-students .card-icon { background: linear-gradient(135deg, #f39c12, #d35400); }
        .card-urgent .card-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .dashboard-card h3 {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .dashboard-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .dashboard-card .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--gray);
        }

        .trend.up { color: var(--success); }
        .trend.down { color: var(--danger); }

        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h2 i {
            color: var(--secondary);
        }

        /* Forms */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        /* Buttons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-block {
            width: 100%;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: var(--primary);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 16px;
        }

        tbody tr {
            border-bottom: 1px solid var(--light);
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        td {
            padding: 18px 15px;
            color: var(--dark);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .priority-high { background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .priority-medium { background-color: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .priority-low { background-color: rgba(52, 152, 219, 0.1); color: #3498db; }

        /* Call Button */
        .call-btn {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: var(--transition);
        }

        .call-btn:hover {
            background-color: rgba(46, 204, 113, 0.2);
            color: #219653;
        }

        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-box {
            background-color: white;
            border-radius: 20px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .auth-logo i {
            font-size: 42px;
            color: var(--secondary);
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .auth-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray);
            font-size: 14px;
        }

        /* OTP Input Container */
        .otp-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .otp-input {
            width: 45px !important;
            height: 45px !important;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            transition: var(--transition);
        }

        .otp-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        /* Password Requirements */
        .password-requirements {
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
        }

        .password-requirements h4 {
            margin-bottom: 8px;
            color: var(--dark);
        }

        .password-requirements ul {
            list-style: none;
            padding-left: 5px;
        }

        .password-requirements li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-requirements li i {
            font-size: 12px;
            width: 16px;
        }

        .requirement-met {
            color: var(--success);
        }

        .requirement-not-met {
            color: var(--danger);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* Admin Profile Images */
        .admin-profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--light);
        }

        .admin-profile-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--secondary);
            margin: 0 auto 20px;
            display: block;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Success Message */
        #successMessage {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            max-width: 350px;
        }

        #errorMessage {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--danger);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            max-width: 350px;
        }

        /* Approval badge styles */
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending { 
            background-color: rgba(243, 156, 18, 0.1); 
            color: #f39c12; 
        }
        
        .status-approved { 
            background-color: rgba(46, 204, 113, 0.1); 
            color: #27ae60; 
        }
        
        .status-rejected { 
            background-color: rgba(231, 76, 60, 0.1); 
            color: #e74c3c; 
        }
        
        .approval-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .approve-btn {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .approve-btn:hover {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        .reject-btn {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .reject-btn:hover {
            background-color: rgba(231, 76, 60, 0.2);
        }
        
        .view-btn {
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .view-btn:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }

        .btn.active {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        }

        /* Admin status badges */
        .status-active { 
            background-color: rgba(46, 204, 113, 0.1); 
            color: #27ae60; 
        }
        
        .status-inactive { 
            background-color: rgba(231, 76, 60, 0.1); 
            color: #e74c3c; 
        }

        /* Auth Tabs */
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        /* Error Message in Forgot Password */
        .email-not-registered {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        /* Profile Image Container */
        .profile-image-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        }

        .profile-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-image-container i {
            font-size: 20px;
            color: white;
        }

        .profile-large-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border: 4px solid var(--secondary);
            margin: 0 auto 20px;
        }

        .profile-large-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-large-container i {
            font-size: 48px;
            color: white;
        }

        /* Simple Forgot Password Button */
        .simple-forgot-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-align: right;
            width: 100%;
            transition: var(--transition);
        }
        
        .simple-forgot-btn:hover {
            color: var(--secondary-dark);
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px 0;
            }
            
            .nav-links {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-links li {
                flex-shrink: 0;
            }
            
            .nav-links a {
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 15px 20px;
            }
            
            .nav-links a:hover, .nav-links a.active {
                border-left: none;
                border-bottom: 3px solid var(--secondary);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .auth-box {
                padding: 30px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screens -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-user-shield"></i>
                    <h1>SCHOOL <span>ADMIN</span></h1>
                </div>
                <p>School Administration Management Portal</p>
            </div>
            
            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="forgot">Forgot Password</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginTab" class="auth-tab-content active">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="admin@school.com" value="admin@school.com">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" value="admin123">
                </div>
                
                <!-- Simple Forgot Password Button -->
                <button class="simple-forgot-btn" id="simpleForgotBtn">
                    <i class="fas fa-key"></i> Forgot Password?
                </button>
                
                <button class="btn btn-primary btn-block" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login to Admin Panel
                </button>
                
                <div class="auth-footer">
                    <p>Default Admin Credentials: admin@school.com / admin123</p>
                </div>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotTab" class="auth-tab-content" style="display: none;">
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="forgotEmail" class="form-control" placeholder="admin@school.com">
                </div>
                
                <button class="btn btn-warning btn-block" id="sendResetOtpBtn">
                    <i class="fas fa-key"></i> Send Reset OTP
                </button>
                
                <div class="form-group" id="resetOtpSection" style="display: none;">
                    <label>Enter OTP *</label>
                    <div class="otp-container">
                        <input type="text" class="otp-input" maxlength="1" data-index="0">
                        <input type="text" class="otp-input" maxlength="1" data-index="1">
                        <input type="text" class="otp-input" maxlength="1" data-index="2">
                        <input type="text" class="otp-input" maxlength="1" data-index="3">
                        <input type="text" class="otp-input" maxlength="1" data-index="4">
                        <input type="text" class="otp-input" maxlength="1" data-index="5">
                    </div>
                </div>
                
                <!-- VERIFY OTP BUTTON -->
                <button class="btn btn-primary btn-block" id="verifyOtpBtn" style="display: none; margin-top: 20px;">
                    <i class="fas fa-check"></i> Verify OTP
                </button>
                
                <!-- NEW PASSWORD FIELDS -->
                <div id="newPasswordFields" style="display: none;">
                    <div class="form-group">
                        <label>New Password *</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                        <div class="password-requirements">
                            <h4>Password Requirements:</h4>
                            <ul>
                                <li id="forgotReqLength">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    At least 6 characters
                                </li>
                                <li id="forgotReqLowercase">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains lowercase letter
                                </li>
                                <li id="forgotReqUppercase">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains uppercase letter
                                </li>
                                <li id="forgotReqNumber">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains number
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Confirm New Password *</label>
                        <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
                    </div>
                    
                    <!-- CHANGE PASSWORD BUTTON - Initially hidden -->
                    <button class="btn btn-primary btn-block" id="resetPasswordBtn" style="display: none; margin-top: 20px;">
                        <i class="fas fa-sync-alt"></i> Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h1>SCHOOL <span>ADMIN</span></h1>
            </div>
            
            <div class="user-info">
                <div class="profile-image-container" id="adminAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h3 id="adminName">Admin User</h3>
                    <p id="adminEmail">admin@school.com</p>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <!-- Main Container -->
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <ul class="nav-links">
                    <li>
                        <a href="#" class="active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="sendNotice">
                            <i class="fas fa-bullhorn"></i>
                            <span>Send Notice</span>
                            <span class="nav-count" id="noticeCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageNotices">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Manage Notices</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageTeachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Manage Teachers</span>
                            <span class="nav-count" id="teacherCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageAdmins">
                            <i class="fas fa-user-shield"></i>
                            <span>Manage Admins</span>
                            <span class="nav-count" id="adminCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboardSection">
                    <div class="section-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p id="currentDate">Loading date...</p>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card card-notices">
                            <div class="card-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <h3>Total Notices</h3>
                            <div class="number" id="totalNoticesCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>5 sent this week</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-teachers">
                            <div class="card-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h3>Approved Teachers</h3>
                            <div class="number" id="totalTeachersCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>2 new this month</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-students">
                            <div class="card-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3>Students (App Users)</h3>
                            <div class="number" id="totalStudentsCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>45 active today</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-urgent">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Total Admins</h3>
                            <div class="number" id="totalAdminsCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>3 active</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityLog">
                                <!-- Activity log will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Send Notice Section -->
                <div class="content-section" id="sendNoticeSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-bullhorn"></i> Send New Notice</h2>
                        <p>Notices will be sent to Teachers & Students apps</p>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label for="noticeTitle">Notice Title *</label>
                            <input type="text" id="noticeTitle" class="form-control" placeholder="Enter notice title">
                        </div>
                        
                        <div class="form-group">
                            <label for="noticeContent">Notice Content *</label>
                            <textarea id="noticeContent" class="form-control textarea" placeholder="Enter notice content..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="noticePriority">Priority Level</label>
                                <select id="noticePriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="noticeCategory">Category</label>
                                <select id="noticeCategory" class="form-control">
                                    <option value="general">General Announcement</option>
                                    <option value="academic">Academic</option>
                                    <option value="exam">Exam Related</option>
                                    <option value="event">School Event</option>
                                    <option value="holiday">Holiday</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Send To *</label>
                            <div style="display: flex; gap: 30px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToTeachers" checked>
                                    <label for="sendToTeachers">All Teachers</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToStudents" checked>
                                    <label for="sendToStudents">All Students</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="button" class="btn btn-primary pulse" id="sendNoticeBtn">
                                <i class="fas fa-paper-plane"></i> Send Notice
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Notices Section -->
                <div class="content-section" id="manageNoticesSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-clipboard-list"></i> Manage Notices</h2>
                        <button class="btn btn-primary" id="refreshNoticesBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                    <th>Sent To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="noticesTableBody">
                                <!-- Notices will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Teachers Section -->
                <div class="content-section" id="manageTeachersSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-chalkboard-teacher"></i> Manage Teachers</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary active" id="showAllTeachersBtn">
                                <i class="fas fa-users"></i> All Teachers
                            </button>
                            <button class="btn btn-warning" id="showPendingTeachersBtn">
                                <i class="fas fa-clock"></i> Pending Approval
                                <span class="nav-count" id="pendingTeachersCount">0</span>
                            </button>
                            <button class="btn btn-success" id="addTeacherBtn">
                                <i class="fas fa-plus"></i> Add Teacher
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Grade</th>
                                    <th>Phone Number</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody">
                                <!-- Teachers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Admins Section -->
                <div class="content-section" id="manageAdminsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-user-shield"></i> Manage Admins</h2>
                        <button class="btn btn-success" id="addAdminBtn">
                            <i class="fas fa-plus"></i> Add Admin
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Admins will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="content-section" id="settingsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-user-circle"></i> Account Settings
                            </h3>
                        </div>
                        
                        <div class="form-group" style="text-align: center;">
                            <div class="profile-large-container" id="settingsProfileImage">
                                <i class="fas fa-user"></i>
                            </div>
                            <button type="button" class="btn btn-secondary" id="changeProfileBtn" style="margin-top: 10px;">
                                <i class="fas fa-camera"></i> Change Profile Picture
                            </button>
                            <input type="file" id="profileImageUpload" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="settingsName" class="form-control" value="Admin User">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="settingsEmail" class="form-control" value="admin@school.com" disabled>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="updateProfileBtn">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                        
                        <div class="form-group" style="margin-top: 40px;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-key"></i> Change Password
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                        </div>
                        
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="settingsNewPassword" class="form-control" placeholder="Enter new password">
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="settingsConfirmPassword" class="form-control" placeholder="Confirm new password">
                        </div>
                        
                        <!-- Password Requirements Display -->
                        <div class="password-requirements" id="passwordRequirements" style="display: none;">
                            <h4>Password Requirements:</h4>
                            <ul>
                                <li id="reqLength">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    At least 6 characters
                                </li>
                                <li id="reqLowercase">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains lowercase letter
                                </li>
                                <li id="reqUppercase">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains uppercase letter
                                </li>
                                <li id="reqNumber">
                                    <i class="fas fa-circle requirement-not-met"></i>
                                    Contains number
                                </li>
                            </ul>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add Teacher Modal -->
    <div class="modal" id="addTeacherModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Teacher</h3>
                <button class="close-modal" id="closeTeacherModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="teacherName" class="form-control" placeholder="Enter teacher's full name">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Subject *</label>
                    <input type="text" id="teacherSubject" class="form-control" placeholder="e.g., Mathematics">
                </div>
                
                <div class="form-group">
                    <label>Grade/Class</label>
                    <input type="text" id="teacherGrade" class="form-control" placeholder="e.g., Grade 10">
                </div>
            </div>
            
            <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" id="teacherPhone" class="form-control" placeholder="+91 9876543210">
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="teacherEmail" class="form-control" placeholder="teacher@school.com">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveTeacherBtn">
                    <i class="fas fa-save"></i> Save Teacher
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Admin Modal -->
    <div class="modal" id="addAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Admin</h3>
                <button class="close-modal" id="closeAdminModal">&times;</button>
            </div>
            
            <div class="form-group" style="text-align: center;">
                <div class="profile-large-container" id="adminModalProfileImage">
                    <i class="fas fa-user"></i>
                </div>
                <button type="button" class="btn btn-secondary" id="changeAdminProfileBtn" style="margin-top: 10px;">
                    <i class="fas fa-camera"></i> Change Profile
                </button>
                <input type="file" id="adminProfileImageUpload" accept="image/*" style="display: none;">
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="adminNameInput" class="form-control" placeholder="Enter admin's full name">
            </div>
            
            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="adminEmailInput" class="form-control" placeholder="admin@school.com">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Role *</label>
                    <select id="adminRoleSelect" class="form-control">
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status *</label>
                    <select id="adminStatusSelect" class="form-control">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Initial Password *</label>
                <input type="password" id="adminPasswordInput" class="form-control" placeholder="Enter initial password">
                <small style="color: var(--gray);">Admin can change this after login</small>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelAdminBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAdminBtn">
                    <i class="fas fa-save"></i> Create Admin
                </button>
            </div>
        </div>
    </div>
    
    <!-- OTP Verification Modal -->
    <div class="modal" id="otpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> OTP Verification</h3>
                <button class="close-modal" id="closeOtpModal">&times;</button>
            </div>
            
            <div class="form-group">
                <p id="otpMessage">Please enter the 6-digit OTP sent to your email.</p>
                <div class="otp-container">
                    <input type="text" class="otp-input" maxlength="1" data-index="0">
                    <input type="text" class="otp-input" maxlength="1" data-index="1">
                    <input type="text" class="otp-input" maxlength="1" data-index="2">
                    <input type="text" class="otp-input" maxlength="1" data-index="3">
                    <input type="text" class="otp-input" maxlength="1" data-index="4">
                    <input type="text" class="otp-input" maxlength="1" data-index="5">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="resendOtpBtn">
                    <i class="fas fa-redo"></i> Resend OTP
                </button>
                <button type="button" class="btn btn-primary" id="verifyOtpModalBtn">
                    <i class="fas fa-check"></i> Verify OTP
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Confirm Delete</h3>
                <button class="close-modal" id="closeDeleteModal">&times;</button>
            </div>
            
            <div class="form-group">
                <p id="deleteMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Teacher Details Modal -->
    <div class="modal" id="teacherDetailsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-chalkboard-teacher"></i> Teacher Details</h3>
                <button class="close-modal" id="closeTeacherDetailsModal">&times;</button>
            </div>
            
            <div id="teacherDetailsContent">
                <!-- Teacher details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div id="successMessage" style="display: none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <div>
                <h4 style="margin-bottom: 5px;">Success!</h4>
                <p id="successText">Operation completed successfully.</p>
            </div>
        </div>
    </div>
    
    <!-- Error Message -->
    <div id="errorMessage" style="display: none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
            <div>
                <h4 style="margin-bottom: 5px;">Error!</h4>
                <p id="errorText">An error occurred.</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase Configuration and App Logic -->
    <script>
        // ============================
        // CONFIGURATION SECTION
        // ============================
        
        // 1. FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
            authDomain: "schooladmin-51cdd.firebaseapp.com",
            databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
            projectId: "schooladmin-51cdd",
            storageBucket: "schooladmin-51cdd.appspot.com",
            messagingSenderId: "185301938780",
            appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
            measurementId: "G-V8C5DE930K"
        };

        // 2. EMAILJS CONFIGURATION
        const EMAILJS_CONFIG = {
            SERVICE_ID: 'service_u035226',
            TEMPLATE_ID: 'template_xyk8468',
            PUBLIC_KEY: 'D-8liyb21zvqmvhPc',
            OTP_TEMPLATE_ID: 'template_xyk8468'
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Initialize EmailJS
        (function() {
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            console.log("EmailJS initialized");
        })();

        // ============================
        // APPLICATION STATE
        // ============================
        let currentUser = null;
        let currentAdmin = null;
        let notices = [];
        let teachers = [];
        let admins = [];
        let activityLog = [];
        let itemToDelete = null;
        let deleteType = null;
        let teacherFilter = 'all';
        let pendingPasswordReset = null;
        let currentOtp = null;
        let otpType = null;
        let failedLoginAttempts = 0; // Track failed login attempts
        let lastFailedLoginTime = null;

        // ============================
        // DOM ELEMENTS
        // ============================
        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminName = document.getElementById('adminName');
        const adminEmail = document.getElementById('adminEmail');
        const adminAvatar = document.getElementById('adminAvatar');
        
        // Auth Elements
        const authTabs = document.querySelectorAll('.auth-tab');
        const authTabContents = document.querySelectorAll('.auth-tab-content');
        const loginBtn = document.getElementById('loginBtn');
        const simpleForgotBtn = document.getElementById('simpleForgotBtn');
        const sendResetOtpBtn = document.getElementById('sendResetOtpBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const otpInputs = document.querySelectorAll('.otp-input');
        const newPasswordFields = document.getElementById('newPasswordFields');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        
        // Verify OTP Button in Forgot Password Form
        const verifyOtpBtnForgot = document.getElementById('verifyOtpBtn');
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-links a');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Dashboard Elements
        const totalNoticesCount = document.getElementById('totalNoticesCount');
        const totalTeachersCount = document.getElementById('totalTeachersCount');
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const totalAdminsCount = document.getElementById('totalAdminsCount');
        const noticeCount = document.getElementById('noticeCount');
        const teacherCount = document.getElementById('teacherCount');
        const adminCount = document.getElementById('adminCount');
        const activityLogTable = document.getElementById('activityLog');
        const currentDateElement = document.getElementById('currentDate');
        
        // Notice Elements
        const sendNoticeBtn = document.getElementById('sendNoticeBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const refreshNoticesBtn = document.getElementById('refreshNoticesBtn');
        const noticesTableBody = document.getElementById('noticesTableBody');
        
        // Teacher Elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const teachersTableBody = document.getElementById('teachersTableBody');
        const saveTeacherBtn = document.getElementById('saveTeacherBtn');
        const cancelTeacherBtn = document.getElementById('cancelTeacherBtn');
        const showAllTeachersBtn = document.getElementById('showAllTeachersBtn');
        const showPendingTeachersBtn = document.getElementById('showPendingTeachersBtn');
        const pendingTeachersCount = document.getElementById('pendingTeachersCount');
        
        // Admin Elements
        const addAdminBtn = document.getElementById('addAdminBtn');
        const adminsTableBody = document.getElementById('adminsTableBody');
        const saveAdminBtn = document.getElementById('saveAdminBtn');
        const cancelAdminBtn = document.getElementById('cancelAdminBtn');
        
        // Settings Elements
        const settingsProfileImage = document.getElementById('settingsProfileImage');
        const changeProfileBtn = document.getElementById('changeProfileBtn');
        const profileImageUpload = document.getElementById('profileImageUpload');
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Password Requirements Elements
        const passwordRequirements = document.getElementById('passwordRequirements');
        const settingsNewPasswordInput = document.getElementById('settingsNewPassword');
        
        // Success/Error Messages
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // ============================
        // INITIALIZE APPLICATION
        // ============================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded");
            
            // Set current date
            const now = new Date();
            currentDateElement.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Check if user is already logged in
            checkAuthState();
            
            // Load sample data for demo
            loadSampleData();
        });

        // ============================
        // EVENT LISTENERS SETUP
        // ============================
        function setupEventListeners() {
            console.log("Setting up event listeners");
            
            // Auth Tabs
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tab
                    authTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    authTabContents.forEach(content => {
                        content.style.display = 'none';
                        if (content.id === tabId + 'Tab') {
                            content.style.display = 'block';
                        }
                    });
                    
                    // Clear OTP fields when switching tabs
                    clearOtpInputs();
                    document.getElementById('resetOtpSection').style.display = 'none';
                    newPasswordFields.style.display = 'none';
                    resetPasswordBtn.style.display = 'none'; // Hide change password button
                    verifyOtpBtnForgot.style.display = 'none';
                    document.getElementById('sendResetOtpBtn').style.display = 'block';
                    
                });
            });
            
            // Simple Forgot Password Button
            simpleForgotBtn.addEventListener('click', function() {
                // Switch to forgot password tab
                authTabs.forEach(t => t.classList.remove('active'));
                authTabs[1].classList.add('active');
                authTabContents.forEach(content => {
                    content.style.display = 'none';
                    if (content.id === 'forgotTab') {
                        content.style.display = 'block';
                    }
                });
            });
            
            // OTP Input Handling
            otpInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = this.value;
                    const index = parseInt(this.dataset.index);
                    
                    // Only allow numbers
                    if (!/^\d*$/.test(value)) {
                        this.value = value.replace(/\D/g, '');
                        return;
                    }
                    
                    // Move to next input if current is filled
                    if (value.length === 1 && index < 5) {
                        otpInputs[index + 1].focus();
                    }
                    
                    // Move to previous input on backspace
                    if (value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
                
                // Handle paste
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').trim();
                    
                    if (pastedData.length === 6 && /^\d+$/.test(pastedData)) {
                        for (let i = 0; i < 6; i++) {
                            if (otpInputs[i]) {
                                otpInputs[i].value = pastedData[i];
                            }
                        }
                        otpInputs[5].focus();
                    }
                });
            });
            
            // Auth Buttons
            loginBtn.addEventListener('click', handleLogin);
            sendResetOtpBtn.addEventListener('click', sendPasswordResetOtp);
            resetPasswordBtn.addEventListener('click', handlePasswordReset);
            
            // Verify OTP Button in Forgot Password Form
            verifyOtpBtnForgot.addEventListener('click', verifyOtpInForgotForm);
            
            // OTP Modal
            document.getElementById('verifyOtpModalBtn').addEventListener('click', verifyOtp);
            resendOtpBtn.addEventListener('click', resendOtp);
            
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = link.dataset.section + 'Section';
                    contentSections.forEach(section => {
                        section.style.display = 'none';
                        if (section.id === sectionId) {
                            section.style.display = 'block';
                        }
                    });
                    
                    // Load section data if needed
                    if (sectionId === 'manageNoticesSection') {
                        loadNoticesTable();
                    } else if (sectionId === 'manageTeachersSection') {
                        loadTeachersTable();
                    } else if (sectionId === 'manageAdminsSection') {
                        loadAdminsTable();
                    }
                });
            });

            // Notice Management
            sendNoticeBtn.addEventListener('click', sendNotice);
            saveDraftBtn.addEventListener('click', saveNoticeAsDraft);
            refreshNoticesBtn.addEventListener('click', loadNoticesTable);

            // Teacher Management
            addTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'flex';
            });
            
            saveTeacherBtn.addEventListener('click', saveTeacher);
            cancelTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            closeTeacherModal.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });

            // Admin Management
            addAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'flex';
            });
            
            saveAdminBtn.addEventListener('click', saveAdmin);
            cancelAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });
            
            closeAdminModal.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });

            // Teacher Filter Buttons
            showAllTeachersBtn.addEventListener('click', () => {
                teacherFilter = 'all';
                showAllTeachersBtn.classList.add('active');
                showPendingTeachersBtn.classList.remove('active');
                loadTeachersTable();
            });
            
            showPendingTeachersBtn.addEventListener('click', () => {
                teacherFilter = 'pending';
                showPendingTeachersBtn.classList.add('active');
                showAllTeachersBtn.classList.remove('active');
                loadTeachersTable();
            });

            // Teacher Details Modal
            closeTeacherDetailsModal.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });

            // Modal Controls
            closeDeleteModal.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
            });
            
            closeOtpModal.addEventListener('click', () => {
                document.getElementById('otpModal').style.display = 'none';
                clearOtpInputs();
            });
            
            cancelDeleteBtn.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
            });
            
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            // Settings
            changeProfileBtn.addEventListener('click', () => {
                profileImageUpload.click();
            });
            
            profileImageUpload.addEventListener('change', handleProfileImageUpload);
            updateProfileBtn.addEventListener('click', updateProfile);
            changePasswordBtn.addEventListener('click', changePassword);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Password requirement checking for settings
            settingsNewPasswordInput.addEventListener('input', checkPasswordRequirements);
            settingsNewPasswordInput.addEventListener('focus', () => {
                passwordRequirements.style.display = 'block';
            });
            settingsNewPasswordInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!settingsNewPasswordInput.matches(':focus')) {
                        passwordRequirements.style.display = 'none';
                    }
                }, 200);
            });
            
            // Password requirement checking for forgot password
            newPasswordInput.addEventListener('input', checkForgotPasswordRequirements);
            
            // Real-time validation for new password fields in forgot password
            newPasswordInput.addEventListener('input', validateForgotPasswordFields);
            confirmNewPasswordInput.addEventListener('input', validateForgotPasswordFields);
        }

        // ============================
        // EMAILJS OTP FUNCTIONS
        // ============================
        async function sendOtpEmail(email, otp, type) {
            try {
                const templateParams = {
                    to_email: email,
                    otp_code: otp,
                    type: type === 'password_reset' ? 'Password Reset' : 'OTP Verification',
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                };

                const response = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ID,
                    templateParams
                );
                
                console.log("OTP email sent successfully:", response);
                return true;
            } catch (error) {
                console.error('EmailJS Error:', error);
                // For demo purposes, we'll return true even if email fails
                return true;
            }
        }

        function generateOtp() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // ============================
        // SIMPLIFIED PASSWORD RESET FLOW - FIXED VERSION
        // ============================
        async function sendPasswordResetOtp() {
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            // Validate email format
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Show loading
            const btn = sendResetOtpBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
            btn.disabled = true;
            
            try {
                // Check if email exists in Firebase
                try {
                    const methods = await auth.fetchSignInMethodsForEmail(email);
                    if (methods.length === 0) {
                        showError('Email not registered. Please check your email address.');
                        return;
                    }
                } catch (error) {
                    console.log("Could not verify email, continuing anyway:", error);
                }
                
                // Generate OTP
                currentOtp = generateOtp();
                otpType = 'password_reset';
                
                // Save pending reset
                pendingPasswordReset = { email };
                
                // Send OTP via EmailJS
                const emailSent = await sendOtpEmail(email, currentOtp, 'password_reset');
                
                if (emailSent) {
                    showSuccess('Password reset OTP sent to your email! Please check your inbox.');
                    
                    // Show OTP section and Verify OTP button
                    document.getElementById('resetOtpSection').style.display = 'block';
                    verifyOtpBtnForgot.style.display = 'block';
                    sendResetOtpBtn.style.display = 'none';
                    
                    // Focus first OTP input
                    document.querySelectorAll('.otp-input')[0].focus();
                } else {
                    showError('Failed to send OTP. Please try again.');
                }
                
            } catch (authError) {
                console.error('Error:', authError);
                showError('Error: ' + authError.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Verify OTP in Forgot Password Form
        async function verifyOtpInForgotForm() {
            const enteredOtp = getOtpFromInputs();
            
            if (enteredOtp.length !== 6) {
                showError('Please enter the complete 6-digit OTP');
                return;
            }
            
            if (enteredOtp !== currentOtp) {
                showError('Invalid OTP. Please try again.');
                return;
            }
            
            // Show loading
            const btn = verifyOtpBtnForgot;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            btn.disabled = true;
            
            try {
                // OTP verified successfully
                showSuccess('OTP verified successfully! Now you can set your new password.');
                
                // Hide OTP section and Verify button
                document.getElementById('resetOtpSection').style.display = 'none';
                verifyOtpBtnForgot.style.display = 'none';
                
                // Show new password fields
                newPasswordFields.style.display = 'block';
                
                // Don't show the Change Password button yet - wait for password validation
                resetPasswordBtn.style.display = 'none';
                
            } catch (error) {
                showError('OTP verification failed: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Validate forgot password fields in real-time
        function validateForgotPasswordFields() {
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;
            
            // Check if both fields are filled and passwords match
            if (newPassword && confirmNewPassword && newPassword === confirmNewPassword) {
                // Check password requirements
                let requirements = [];
                if (newPassword.length < 6) requirements.push('at least 6 characters');
                if (!/[a-z]/.test(newPassword)) requirements.push('one lowercase letter');
                if (!/[A-Z]/.test(newPassword)) requirements.push('one uppercase letter');
                if (!/[0-9]/.test(newPassword)) requirements.push('one number');
                
                // If all requirements are met, show the Change Password button
                if (requirements.length === 0) {
                    resetPasswordBtn.style.display = 'block';
                } else {
                    resetPasswordBtn.style.display = 'none';
                }
            } else {
                resetPasswordBtn.style.display = 'none';
            }
        }

        function getOtpFromInputs() {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });
            return otp;
        }

        function clearOtpInputs() {
            otpInputs.forEach(input => {
                input.value = '';
            });
        }

        function checkForgotPasswordRequirements() {
            const password = newPasswordInput.value;
            
            if (!password) {
                return;
            }
            
            // Check length
            const lengthReq = document.getElementById('forgotReqLength');
            if (password.length >= 6) {
                lengthReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                lengthReq.style.color = 'var(--success)';
            } else {
                lengthReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                lengthReq.style.color = 'var(--danger)';
            }
            
            // Check lowercase
            const lowercaseReq = document.getElementById('forgotReqLowercase');
            if (/[a-z]/.test(password)) {
                lowercaseReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                lowercaseReq.style.color = 'var(--success)';
            } else {
                lowercaseReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                lowercaseReq.style.color = 'var(--danger)';
            }
            
            // Check uppercase
            const uppercaseReq = document.getElementById('forgotReqUppercase');
            if (/[A-Z]/.test(password)) {
                uppercaseReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                uppercaseReq.style.color = 'var(--success)';
            } else {
                uppercaseReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                uppercaseReq.style.color = 'var(--danger)';
            }
            
            // Check number
            const numberReq = document.getElementById('forgotReqNumber');
            if (/[0-9]/.test(password)) {
                numberReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                numberReq.style.color = 'var(--success)';
            } else {
                numberReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                numberReq.style.color = 'var(--danger)';
            }
        }

        async function handlePasswordReset() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmNewPassword) {
                showError('Please enter new password and confirm it');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showError('Passwords do not match');
                return;
            }
            
            // Check password requirements
            let requirements = [];
            if (newPassword.length < 6) requirements.push('at least 6 characters');
            if (!/[a-z]/.test(newPassword)) requirements.push('one lowercase letter');
            if (!/[A-Z]/.test(newPassword)) requirements.push('one uppercase letter');
            if (!/[0-9]/.test(newPassword)) requirements.push('one number');
            
            if (requirements.length > 0) {
                showError('Password must contain: ' + requirements.join(', '));
                return;
            }
            
            // Show loading
            const btn = resetPasswordBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
            btn.disabled = true;
            
            try {
                // Get the email from pending reset
                const email = pendingPasswordReset.email;
                
                // FIRST: Try to sign in with the old password to get current user
                // This is important for Firebase to recognize the password change
                try {
                    // Since we don't know the old password, we use Firebase's sendPasswordResetEmail
                    // This is the proper way to reset password in Firebase
                    await auth.sendPasswordResetEmail(email);
                    
                    showSuccess('Password reset email sent! Check your inbox for reset instructions.');
                    
                    // IMPORTANT: Clear the form and show user instructions
                    document.getElementById('forgotEmail').value = '';
                    newPasswordInput.value = '';
                    confirmNewPasswordInput.value = '';
                    document.getElementById('resetOtpSection').style.display = 'none';
                    newPasswordFields.style.display = 'none';
                    resetPasswordBtn.style.display = 'none';
                    verifyOtpBtnForgot.style.display = 'none';
                    document.getElementById('sendResetOtpBtn').style.display = 'block';
                    clearOtpInputs();
                    
                    // Show additional instructions
                    showSuccess('Password reset email sent! Please check your inbox and follow the link to set a new password. After resetting, you can login with your new password.');
                    
                    // Reset state
                    pendingPasswordReset = null;
                    currentOtp = null;
                    otpType = null;
                    
                    // Switch to login tab after a delay
                    setTimeout(() => {
                        authTabs.forEach(t => t.classList.remove('active'));
                        authTabs[0].classList.add('active');
                        authTabContents.forEach(content => content.style.display = 'none');
                        document.getElementById('loginTab').style.display = 'block';
                        
                        // Update login form with the email that was reset
                        document.getElementById('loginEmail').value = email;
                        document.getElementById('loginPassword').value = '';
                        
                        // Show instruction to check email
                        showSuccess('Please check your email for password reset link. After resetting, use your new password to login.');
                    }, 3000);
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    
                    // Handle specific Firebase errors
                    if (error.code === 'auth/user-not-found') {
                        showError('Email not registered. Please check your email address.');
                    } else if (error.code === 'auth/too-many-requests') {
                        showError('Too many attempts. Please try again later or reset password from Firebase console.');
                    } else {
                        showError('Password reset failed: ' + error.message);
                    }
                }
                
            } catch (error) {
                console.error('Unexpected error:', error);
                showError('An unexpected error occurred: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ============================
        // OTP VERIFICATION FUNCTIONS (Modal)
        // ============================
        async function verifyOtp() {
            const enteredOtp = getOtpFromInputs();
            
            if (enteredOtp.length !== 6) {
                showError('Please enter the complete 6-digit OTP');
                return;
            }
            
            if (enteredOtp !== currentOtp) {
                showError('Invalid OTP. Please try again.');
                return;
            }
            
            // Handle based on otpType
            if (otpType === 'password_reset' && pendingPasswordReset) {
                // Hide OTP modal
                document.getElementById('otpModal').style.display = 'none';
                clearOtpInputs();
                
                // Show new password fields
                newPasswordFields.style.display = 'block';
                resetPasswordBtn.style.display = 'none'; // Hide initially
                
                showSuccess('OTP verified! Now enter your new password.');
            }
        }

        async function resendOtp() {
            if (!pendingPasswordReset) {
                showError('No pending operation to resend OTP');
                return;
            }
            
            // Show loading
            const btn = resendOtpBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
            btn.disabled = true;
            
            try {
                // Generate new OTP
                currentOtp = generateOtp();
                
                let email, type;
                if (pendingPasswordReset) {
                    email = pendingPasswordReset.email;
                    type = 'password_reset';
                }
                
                // Send OTP via EmailJS
                const emailSent = await sendOtpEmail(email, currentOtp, type);
                
                if (emailSent) {
                    showSuccess('New OTP sent to your email!');
                } else {
                    showError('Failed to resend OTP. Please try again.');
                }
                
            } catch (error) {
                showError('Error resending OTP: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ============================
        // PASSWORD REQUIREMENT CHECKING
        // ============================
        function checkPasswordRequirements() {
            const password = settingsNewPasswordInput.value;
            
            if (!password) {
                passwordRequirements.style.display = 'none';
                return;
            }
            
            // Show requirements box
            passwordRequirements.style.display = 'block';
            
            // Check length
            const lengthReq = document.getElementById('reqLength');
            if (password.length >= 6) {
                lengthReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                lengthReq.style.color = 'var(--success)';
            } else {
                lengthReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                lengthReq.style.color = 'var(--danger)';
            }
            
            // Check lowercase
            const lowercaseReq = document.getElementById('reqLowercase');
            if (/[a-z]/.test(password)) {
                lowercaseReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                lowercaseReq.style.color = 'var(--success)';
            } else {
                lowercaseReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                lowercaseReq.style.color = 'var(--danger)';
            }
            
            // Check uppercase
            const uppercaseReq = document.getElementById('reqUppercase');
            if (/[A-Z]/.test(password)) {
                uppercaseReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                uppercaseReq.style.color = 'var(--success)';
            } else {
                uppercaseReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                uppercaseReq.style.color = 'var(--danger)';
            }
            
            // Check number
            const numberReq = document.getElementById('reqNumber');
            if (/[0-9]/.test(password)) {
                numberReq.querySelector('i').className = 'fas fa-check-circle requirement-met';
                numberReq.style.color = 'var(--success)';
            } else {
                numberReq.querySelector('i').className = 'fas fa-circle requirement-not-met';
                numberReq.style.color = 'var(--danger)';
            }
        }

        // ============================
        // FIREBASE AUTHENTICATION FUNCTIONS - IMPROVED VERSION
        // ============================
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                console.log("Auth state changed:", user);
                if (user) {
                    console.log("User is logged in:", user.email);
                    currentUser = user;
                    // Reset failed attempts counter on successful auth state change
                    failedLoginAttempts = 0;
                    lastFailedLoginTime = null;
                    
                    // Load admin data from database
                    loadAdminData(user.uid).then(() => {
                        showAdminPanel();
                    }).catch(error => {
                        console.error("Error loading admin data:", error);
                        // Show admin panel even without database data
                        showAdminPanel();
                    });
                } else {
                    console.log("No user logged in");
                    // Show auth screen
                    authContainer.style.display = 'flex';
                    adminPanel.style.display = 'none';
                }
            });
        }

        // Load admin data from Realtime Database
        async function loadAdminData(uid) {
            try {
                const snapshot = await database.ref('admins/' + uid).once('value');
                if (snapshot.exists()) {
                    currentAdmin = snapshot.val();
                    currentAdmin.id = uid;
                    
                    // Update admin info in UI
                    adminName.textContent = currentAdmin.name || currentUser.displayName || 'Admin User';
                    adminEmail.textContent = currentAdmin.email || currentUser.email || 'admin@school.com';
                    
                    // Update profile image
                    updateProfileImage(adminAvatar, currentAdmin.profileImage);
                    updateProfileImage(settingsProfileImage, currentAdmin.profileImage);
                    
                    // Update settings form
                    document.getElementById('settingsName').value = currentAdmin.name || currentUser.displayName || 'Admin User';
                    document.getElementById('settingsEmail').value = currentAdmin.email || currentUser.email || 'admin@school.com';
                } else {
                    // Create default admin data if not exists
                    currentAdmin = {
                        id: uid,
                        name: currentUser.displayName || 'Admin User',
                        email: currentUser.email || 'admin@school.com',
                        role: 'admin',
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    
                    await database.ref('admins/' + uid).set(currentAdmin);
                }
            } catch (error) {
                console.error("Error loading admin data:", error);
                // Use default values
                currentAdmin = {
                    id: uid,
                    name: currentUser?.displayName || 'Admin User',
                    email: currentUser?.email || 'admin@school.com',
                    role: 'admin',
                    status: 'active'
                };
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            console.log("Login attempt with:", email);
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            // Check if we have too many failed attempts
            const now = new Date();
            if (failedLoginAttempts >= 5) {
                if (lastFailedLoginTime) {
                    const timeDiff = (now - lastFailedLoginTime) / 1000; // in seconds
                    if (timeDiff < 300) { // 5 minutes
                        showError('Too many failed attempts. Please wait 5 minutes before trying again.');
                        return;
                    } else {
                        // Reset counter if enough time has passed
                        failedLoginAttempts = 0;
                        lastFailedLoginTime = null;
                    }
                }
            }
            
            // Show loading
            const btn = loginBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            btn.disabled = true;
            
            try {
                // REAL FIREBASE IMPLEMENTATION
                console.log("Attempting Firebase login...");
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                console.log("Login successful:", currentUser.email);
                
                // Reset failed attempts on success
                failedLoginAttempts = 0;
                lastFailedLoginTime = null;
                
                // Update last login in database if possible
                try {
                    await database.ref('admins/' + currentUser.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                } catch (dbError) {
                    console.warn('Could not update last login in database:', dbError);
                    // Continue even if database update fails
                }
                
                showSuccess('Login successful!');
                
                // Load admin data and show admin panel
                await loadAdminData(currentUser.uid);
                showAdminPanel();
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Increment failed attempts
                failedLoginAttempts++;
                lastFailedLoginTime = new Date();
                
                // Handle specific Firebase errors
                let errorMessage = 'Login failed: ';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Email not registered. Please check your email address.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid password. Please try again.';
                    // Give hint about password reset
                    if (failedLoginAttempts >= 3) {
                        errorMessage += ' If you forgot your password, use the "Forgot Password" tab.';
                    }
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format. Please enter a valid email address.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact administrator.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Access temporarily blocked. Please try again later or reset your password.';
                    // Suggest password reset
                    errorMessage += ' You can reset your password using the "Forgot Password" tab.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                showError(errorMessage);
                
                // If too many failed attempts, disable login button temporarily
                if (failedLoginAttempts >= 5) {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-clock"></i> Try again in 5 minutes';
                    
                    setTimeout(() => {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Admin Panel';
                        failedLoginAttempts = 0;
                        lastFailedLoginTime = null;
                    }, 300000); // 5 minutes
                }
            } finally {
                // Reset button (only if not disabled by too many attempts)
                if (!loginBtn.disabled) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        function handleLogout() {
            auth.signOut().then(() => {
                console.log("Logout successful");
                
                // Clear local storage
                localStorage.removeItem('schoolAdminUser');
                
                // Reset app state
                currentUser = null;
                currentAdmin = null;
                
                // Show auth screen
                authContainer.style.display = 'flex';
                adminPanel.style.display = 'none';
                
                // Reset forms
                clearLoginForm();
                
                showSuccess('Logged out successfully!');
            }).catch((error) => {
                console.error('Logout error:', error);
                showError('Logout failed: ' + error.message);
            });
        }

        // ============================
        // ADMIN PANEL FUNCTIONS
        // ============================
        function showAdminPanel() {
            console.log("Showing admin panel");
            
            // Update user info
            adminName.textContent = currentAdmin?.name || currentUser?.displayName || 'Admin User';
            adminEmail.textContent = currentAdmin?.email || currentUser?.email || 'admin@school.com';
            
            // Update admin avatar
            updateProfileImage(adminAvatar, currentAdmin?.profileImage);
            updateProfileImage(settingsProfileImage, currentAdmin?.profileImage);
            
            // Switch to admin panel
            authContainer.style.display = 'none';
            adminPanel.style.display = 'block';
            
            // Load dashboard data
            loadDashboardData();
        }

        // Function to update profile image
        function updateProfileImage(container, imageUrl) {
            if (!container) return;
            
            if (imageUrl && (imageUrl.startsWith('http') || imageUrl.startsWith('blob'))) {
                // If image URL exists and is valid, create img element
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = "Profile";
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.onerror = function() {
                    // If image fails to load, show icon instead
                    container.innerHTML = '<i class="fas fa-user"></i>';
                };
                container.innerHTML = '';
                container.appendChild(img);
            } else {
                // If no image URL, show icon
                container.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        async function loadDashboardData() {
            try {
                // Load notices count
                try {
                    const noticesSnapshot = await database.ref('notices').once('value');
                    const noticesCount = noticesSnapshot.exists() ? Object.keys(noticesSnapshot.val()).length : 0;
                    totalNoticesCount.textContent = noticesCount;
                    noticeCount.textContent = noticesCount;
                } catch (error) {
                    console.warn('Could not load notices:', error);
                    totalNoticesCount.textContent = notices.length;
                    noticeCount.textContent = notices.length;
                }
                
                // Load teachers count
                try {
                    const teachersSnapshot = await database.ref('teachers').once('value');
                    let teachersCount = 0;
                    let pendingTeachers = 0;
                    
                    if (teachersSnapshot.exists()) {
                        teachersSnapshot.forEach((childSnapshot) => {
                            const teacher = childSnapshot.val();
                            if (teacher.status === 'approved' || teacher.approved === true) {
                                teachersCount++;
                            }
                            if (teacher.status === 'pending' || teacher.approved === false) {
                                pendingTeachers++;
                            }
                        });
                    }
                    
                    totalTeachersCount.textContent = teachersCount;
                    teacherCount.textContent = pendingTeachers;
                    pendingTeachersCount.textContent = pendingTeachers;
                } catch (error) {
                    console.warn('Could not load teachers:', error);
                    const approvedTeachers = teachers.filter(t => 
                        t.status === 'approved' || t.approved === true
                    ).length;
                    totalTeachersCount.textContent = approvedTeachers;
                    
                    const pendingTeachers = teachers.filter(t => 
                        t.status === 'pending' || t.approved === false
                    ).length;
                    teacherCount.textContent = pendingTeachers;
                    pendingTeachersCount.textContent = pendingTeachers;
                }
                
                // Load admins count
                try {
                    const adminsSnapshot = await database.ref('admins').once('value');
                    const adminsCount = adminsSnapshot.exists() ? Object.keys(adminsSnapshot.val()).length : 1;
                    totalAdminsCount.textContent = adminsCount;
                    adminCount.textContent = adminsCount;
                } catch (error) {
                    console.warn('Could not load admins:', error);
                    totalAdminsCount.textContent = admins.length || 1;
                    adminCount.textContent = admins.length || 1;
                }
                
                // Simulated students data
                totalStudentsCount.textContent = '2847';
                
                // Load activity log
                loadActivityLog();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Use sample data as fallback
                totalNoticesCount.textContent = notices.length;
                
                const approvedTeachers = teachers.filter(t => 
                    t.status === 'approved' || t.approved === true
                ).length;
                totalTeachersCount.textContent = approvedTeachers;
                
                const pendingTeachers = teachers.filter(t => 
                    t.status === 'pending' || t.approved === false
                ).length;
                teacherCount.textContent = pendingTeachers;
                pendingTeachersCount.textContent = pendingTeachers;
                
                totalAdminsCount.textContent = admins.length || 1;
                adminCount.textContent = admins.length || 1;
                totalStudentsCount.textContent = '2847';
            }
        }

        function loadActivityLog() {
            // Simulated activity data
            const activities = [
                { time: '10:30 AM', activity: 'Sent Notice', details: 'Annual Sports Day Announcement', status: 'Completed' },
                { time: 'Yesterday, 3:15 PM', activity: 'Added Teacher', details: 'Mr. John Smith - Mathematics', status: 'Completed' },
                { time: 'Mar 12, 9:45 AM', activity: 'Deleted Notice', details: 'Old Library Schedule', status: 'Completed' },
                { time: 'Mar 10, 2:20 PM', activity: 'Password Changed', details: 'Account security update', status: 'Completed' },
                { time: 'Mar 8, 11:05 AM', activity: 'Sent Notice', details: 'Parent-Teacher Meeting Schedule', status: 'Completed' }
            ];
            
            activityLogTable.innerHTML = '';
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                    <td><span style="color: var(--success); font-weight: 600;">${activity.status}</span></td>
                `;
                activityLogTable.appendChild(row);
            });
        }

        // ============================
        // NOTICE MANAGEMENT FUNCTIONS (USING REALTIME DATABASE)
        // ============================
        async function sendNotice() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const priority = document.getElementById('noticePriority').value;
            const category = document.getElementById('noticeCategory').value;
            const sendToTeachers = document.getElementById('sendToTeachers').checked;
            const sendToStudents = document.getElementById('sendToStudents').checked;
            
            if (!title || !content) {
                showError('Please enter notice title and content');
                return;
            }
            
            if (!sendToTeachers && !sendToStudents) {
                showError('Please select at least one recipient group');
                return;
            }
            
            // Show loading
            const btn = sendNoticeBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            
            try {
                // REALTIME DATABASE IMPLEMENTATION
                const noticeId = database.ref().child('notices').push().key;
                const noticeData = {
                    id: noticeId,
                    title: title,
                    content: content,
                    priority: priority,
                    category: category,
                    recipients: {
                        teachers: sendToTeachers,
                        students: sendToStudents
                    },
                    timestamp: new Date().toISOString(),
                    status: 'sent',
                    sentBy: currentUser.uid,
                    sentByName: currentAdmin?.name || currentUser.displayName || 'Admin'
                };
                
                await database.ref('notices/' + noticeId).set(noticeData);
                
                showSuccess('Notice sent successfully to Teachers & Students apps!');
                
                // Add to notices array
                notices.unshift(noticeData);
                
                // Update dashboard
                loadDashboardData();
                
                // Clear form
                clearNoticeForm();
                
                // If on manage notices tab, refresh
                if (document.getElementById('manageNoticesSection').style.display === 'block') {
                    loadNoticesTable();
                }
                
                // Log activity
                addActivityLog('Sent Notice', title);
                
            } catch (error) {
                showError('Failed to send notice: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function saveNoticeAsDraft() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            
            if (!title || !content) {
                showError('Please enter notice title and content to save as draft');
                return;
            }
            
            showSuccess('Notice saved as draft successfully!');
            
            // Log activity
            addActivityLog('Saved Draft', title);
        }

        async function loadNoticesTable() {
            // Show loading
            refreshNoticesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            refreshNoticesBtn.disabled = true;
            
            try {
                // REALTIME DATABASE IMPLEMENTATION
                const snapshot = await database.ref('notices').orderByChild('timestamp').once('value');
                
                notices = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const notice = childSnapshot.val();
                        notices.unshift(notice); // Add to beginning to show newest first
                    });
                }
                
                // Clear table
                noticesTableBody.innerHTML = '';
                
                // Check if we have notices
                if (notices.length === 0) {
                    noticesTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No notices found</h3>
                                <p>Send your first notice using the "Send Notice" tab</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add notices to table
                notices.forEach(notice => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = new Date(notice.timestamp);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    // Priority badge
                    let priorityBadge = '';
                    if (notice.priority === 'high') {
                        priorityBadge = '<span class="priority-badge priority-high">High</span>';
                    } else if (notice.priority === 'medium') {
                        priorityBadge = '<span class="priority-badge priority-medium">Medium</span>';
                    } else {
                        priorityBadge = '<span class="priority-badge priority-low">Low</span>';
                    }
                    
                    // Recipients text
                    let recipientsText = '';
                    if (notice.recipients?.teachers && notice.recipients?.students) {
                        recipientsText = 'All Teachers & Students';
                    } else if (notice.recipients?.teachers) {
                        recipientsText = 'Teachers Only';
                    } else if (notice.recipients?.students) {
                        recipientsText = 'Students Only';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${notice.title}</strong></td>
                        <td>${notice.category || 'General'}</td>
                        <td>${priorityBadge}</td>
                        <td>${formattedDate}</td>
                        <td>${recipientsText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm view-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    noticesTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const noticeId = this.dataset.id;
                        showDeleteConfirmation('notice', noticeId, 'Are you sure you want to delete this notice?');
                    });
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-notice-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const noticeId = this.dataset.id;
                        viewNotice(noticeId);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load notices:', error);
                // Use sample data if database fails
                showError('Could not load notices from database. Using sample data.');
                
                // Clear table
                noticesTableBody.innerHTML = '';
                
                // Add sample notices
                notices.forEach(notice => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = new Date(notice.timestamp);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    // Priority badge
                    let priorityBadge = '';
                    if (notice.priority === 'high') {
                        priorityBadge = '<span class="priority-badge priority-high">High</span>';
                    } else if (notice.priority === 'medium') {
                        priorityBadge = '<span class="priority-badge priority-medium">Medium</span>';
                    } else {
                        priorityBadge = '<span class="priority-badge priority-low">Low</span>';
                    }
                    
                    // Recipients text
                    let recipientsText = '';
                    if (notice.recipients?.teachers && notice.recipients?.students) {
                        recipientsText = 'All Teachers & Students';
                    } else if (notice.recipients?.teachers) {
                        recipientsText = 'Teachers Only';
                    } else if (notice.recipients?.students) {
                        recipientsText = 'Students Only';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${notice.title}</strong></td>
                        <td>${notice.category || 'General'}</td>
                        <td>${priorityBadge}</td>
                        <td>${formattedDate}</td>
                        <td>${recipientsText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm view-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    noticesTableBody.appendChild(row);
                });
            } finally {
                // Reset button
                refreshNoticesBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshNoticesBtn.disabled = false;
            }
        }

        function viewNotice(noticeId) {
            const notice = notices.find(n => n.id === noticeId);
            if (!notice) return;
            
            alert(`Notice Details:\n\nTitle: ${notice.title}\n\nContent: ${notice.content}\n\nPriority: ${notice.priority}\n\nCategory: ${notice.category}\n\nSent to: ${notice.recipients?.teachers ? 'Teachers' : ''}${notice.recipients?.teachers && notice.recipients?.students ? ' & ' : ''}${notice.recipients?.students ? 'Students' : ''}\n\nDate: ${new Date(notice.timestamp).toLocaleString()}`);
        }

        // ============================
        // TEACHER MANAGEMENT FUNCTIONS (USING REALTIME DATABASE)
        // ============================
        async function loadTeachersTable() {
            try {
                // REALTIME DATABASE IMPLEMENTATION
                const snapshot = await database.ref('teachers').once('value');
                
                teachers = [];
                let pendingCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const teacher = childSnapshot.val();
                        teacher.id = childSnapshot.key;
                        teachers.push(teacher);
                        
                        // Count pending teachers
                        if (teacher.status === 'pending' || teacher.approved === false) {
                            pendingCount++;
                        }
                    });
                }
                
                // Update pending count
                pendingTeachersCount.textContent = pendingCount;
                
                // Filter teachers based on current filter
                let filteredTeachers = teachers;
                if (teacherFilter === 'pending') {
                    filteredTeachers = teachers.filter(t => 
                        t.status === 'pending' || t.approved === false
                    );
                }
                
                // Clear table
                teachersTableBody.innerHTML = '';
                
                // Check if we have teachers
                if (filteredTeachers.length === 0) {
                    teachersTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No teachers found</h3>
                                <p>${teacherFilter === 'pending' ? 'No pending approval requests' : 'Add your first teacher using the "Add Teacher" button'}</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add teachers to table
                filteredTeachers.forEach(teacher => {
                    const row = document.createElement('tr');
                    
                    // Determine status
                    let status = 'Pending';
                    let statusClass = 'status-pending';
                    
                    if (teacher.status === 'approved' || teacher.approved === true) {
                        status = 'Approved';
                        statusClass = 'status-approved';
                    } else if (teacher.status === 'rejected') {
                        status = 'Rejected';
                        statusClass = 'status-rejected';
                    }
                    
                    row.innerHTML = `
                        <td>
                            <div class="profile-image-container">
                                ${teacher.profileImage && teacher.profileImage.startsWith('http') ? 
                                    `<img src="${teacher.profileImage}" alt="${teacher.fullName || teacher.name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>';">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                        </td>
                        <td><strong>${teacher.fullName || teacher.name}</strong></td>
                        <td>${teacher.subject || 'Not specified'}</td>
                        <td>${teacher.grade || 'Not specified'}</td>
                        <td>${teacher.phone || 'Not provided'}</td>
                        <td>${teacher.email || 'Not provided'}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="view-btn view-teacher-btn" data-id="${teacher.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${(teacher.status === 'pending' || teacher.approved === false) ? `
                                <button class="approve-btn approval-action-btn" data-id="${teacher.id}" data-action="approve">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="reject-btn approval-action-btn" data-id="${teacher.id}" data-action="reject">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                ` : ''}
                                ${teacher.phone ? `
                                <a href="tel:${teacher.phone}" class="call-btn" target="_blank">
                                    <i class="fas fa-phone"></i> Call
                                </a>
                                ` : ''}
                                <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    teachersTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.view-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        viewTeacherDetails(teacherId);
                    });
                });
                
                document.querySelectorAll('.approval-action-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        const action = this.dataset.action; // 'approve' or 'reject'
                        handleTeacherApproval(teacherId, action);
                    });
                });
                
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        const teacher = teachers.find(t => t.id === teacherId);
                        const teacherName = teacher ? (teacher.fullName || teacher.name) : 'this teacher';
                        showDeleteConfirmation('teacher', teacherId, `Are you sure you want to delete ${teacherName}?`);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load teachers:', error);
                showError('Could not load teachers from database. Using sample data.');
                
                // Use sample data as fallback
                teachersTableBody.innerHTML = '';
                
                // Filter teachers based on current filter
                let filteredTeachers = teachers;
                if (teacherFilter === 'pending') {
                    filteredTeachers = teachers.filter(t => 
                        t.status === 'pending' || t.approved === false
                    );
                }
                
                if (filteredTeachers.length === 0) {
                    teachersTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No teachers found</h3>
                                <p>${teacherFilter === 'pending' ? 'No pending approval requests' : 'Add your first teacher using the "Add Teacher" button'}</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add sample teachers to table
                filteredTeachers.forEach(teacher => {
                    const row = document.createElement('tr');
                    
                    // Determine status
                    let status = 'Pending';
                    let statusClass = 'status-pending';
                    
                    if (teacher.status === 'approved' || teacher.approved === true) {
                        status = 'Approved';
                        statusClass = 'status-approved';
                    } else if (teacher.status === 'rejected') {
                        status = 'Rejected';
                        statusClass = 'status-rejected';
                    }
                    
                    row.innerHTML = `
                        <td>
                            <div class="profile-image-container">
                                <i class="fas fa-user"></i>
                            </div>
                        </td>
                        <td><strong>${teacher.fullName || teacher.name}</strong></td>
                        <td>${teacher.subject || 'Not specified'}</td>
                        <td>${teacher.grade || 'Not specified'}</td>
                        <td>${teacher.phone || 'Not provided'}</td>
                        <td>${teacher.email || 'Not provided'}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="view-btn view-teacher-btn" data-id="${teacher.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${(teacher.status === 'pending' || teacher.approved === false) ? `
                                <button class="approve-btn approval-action-btn" data-id="${teacher.id}" data-action="approve">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="reject-btn approval-action-btn" data-id="${teacher.id}" data-action="reject">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                ` : ''}
                                ${teacher.phone ? `
                                <a href="tel:${teacher.phone}" class="call-btn" target="_blank">
                                    <i class="fas fa-phone"></i> Call
                                </a>
                                ` : ''}
                                <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    teachersTableBody.appendChild(row);
                });
            }
        }

        async function viewTeacherDetails(teacherId) {
            try {
                // Get teacher data from database
                const snapshot = await database.ref('teachers/' + teacherId).once('value');
                
                if (!snapshot.exists()) {
                    showError('Teacher not found');
                    return;
                }
                
                const teacher = snapshot.val();
                teacher.id = teacherId;
                
                // Format dates
                const createdAt = teacher.createdAt ? new Date(teacher.createdAt).toLocaleString() : 'Not available';
                const updatedAt = teacher.updatedAt ? new Date(teacher.updatedAt).toLocaleString() : 'Not available';
                
                // Determine status
                let status = 'Pending';
                let statusClass = 'status-pending';
                
                if (teacher.status === 'approved' || teacher.approved === true) {
                    status = 'Approved';
                    statusClass = 'status-approved';
                } else if (teacher.status === 'rejected') {
                    status = 'Rejected';
                    statusClass = 'status-rejected';
                }
                
                // Create teacher details HTML
                teacherDetailsContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 25px;">
                        <div style="display: flex; gap: 25px; align-items: center;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); display: flex; align-items: center; justify-content: center; border: 4px solid var(--light);">
                                ${teacher.profileImage && teacher.profileImage.startsWith('http') ? 
                                    `<img src="${teacher.profileImage}" alt="${teacher.fullName || teacher.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\' style=\\'font-size: 48px; color: white;\\'></i>';">` : 
                                    `<i class="fas fa-user" style="font-size: 48px; color: white;"></i>`
                                }
                            </div>
                            <div>
                                <h2 style="color: var(--primary); margin-bottom: 10px;">${teacher.fullName || teacher.name}</h2>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span class="status-badge ${statusClass}" style="font-size: 16px;">${status}</span>
                                    <span style="background-color: rgba(52, 152, 219, 0.1); color: var(--secondary); padding: 6px 15px; border-radius: 20px; font-weight: 600;">
                                        ${teacher.subject || 'Not specified'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div>
                                <h4 style="color: var(--gray); margin-bottom: 8px;">Grade/Class</h4>
                                <p style="font-size: 18px; font-weight: 600;">${teacher.grade || 'Not specified'}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--gray); margin-bottom = 8px;">User ID</h4>
                                <p style="font-size: 14px; font-family: monospace;">${teacher.uid || teacher.id}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--gray); margin-bottom: 8px;">Phone Number</h4>
                                <p style="font-size: 18px; font-weight: 600;">${teacher.phone || 'Not provided'}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--gray); margin-bottom: 8px;">Email</h4>
                                <p>${teacher.email || 'Not provided'}</p>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--light); padding-top: 20px;">
                            <h4 style="color: var(--gray); margin-bottom: 15px;">Account Information</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <h5 style="color: var(--gray); margin-bottom: 5px;">Created At</h5>
                                    <p>${createdAt}</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--gray); margin-bottom: 5px;">Last Updated</h5>
                                    <p>${updatedAt}</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--gray); margin-bottom: 5px;">Approval Status</h5>
                                    <p>${teacher.approved === true ? 'Approved' : teacher.approved === false ? 'Not Approved' : 'Pending'}</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--gray); margin-bottom: 5px;">Role</h5>
                                    <p>${teacher.role || 'teacher'}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${(teacher.status === 'pending' || teacher.approved === false) ? `
                        <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 1px solid var(--light);">
                            <button class="btn btn-success" id="approveTeacherBtn" style="flex: 1;" data-id="${teacherId}">
                                <i class="fas fa-check"></i> Approve Teacher
                            </button>
                            <button class="btn btn-danger" id="rejectTeacherBtn" style="flex: 1;" data-id="${teacherId}">
                                <i class="fas fa-times"></i> Reject Request
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Add event listeners to modal buttons
                const approveBtn = document.getElementById('approveTeacherBtn');
                const rejectBtn = document.getElementById('rejectTeacherBtn');
                
                if (approveBtn) {
                    approveBtn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        handleTeacherApproval(teacherId, 'approve');
                        teacherDetailsModal.style.display = 'none';
                    });
                }
                
                if (rejectBtn) {
                    rejectBtn.addEventListener('click', function() {
                        const teacherId = this.dataset.id;
                        handleTeacherApproval(teacherId, 'reject');
                        teacherDetailsModal.style.display = 'none';
                    });
                }
                
                // Show modal
                teacherDetailsModal.style.display = 'flex';
                
            } catch (error) {
                showError('Failed to load teacher details: ' + error.message);
            }
        }

        async function handleTeacherApproval(teacherId, action) {
            try {
                // Show confirmation
                const confirmation = confirm(`Are you sure you want to ${action} this teacher?`);
                if (!confirmation) return;
                
                // Update teacher status in database
                const updates = {
                    status: action === 'approve' ? 'approved' : 'rejected',
                    approved: action === 'approve' ? true : false,
                    updatedAt: new Date().toISOString(),
                    reviewedBy: currentUser.uid,
                    reviewedByName: currentAdmin?.name || currentUser.displayName || 'Admin',
                    reviewedAt: new Date().toISOString()
                };
                
                await database.ref('teachers/' + teacherId).update(updates);
                
                // Update local state
                const teacherIndex = teachers.findIndex(t => t.id === teacherId);
                if (teacherIndex !== -1) {
                    teachers[teacherIndex] = { ...teachers[teacherIndex], ...updates };
                }
                
                // Show success message
                const actionText = action === 'approve' ? 'approved' : 'rejected';
                showSuccess(`Teacher request has been ${actionText} successfully!`);
                
                // Log activity
                const teacher = teachers.find(t => t.id === teacherId);
                const teacherName = teacher ? (teacher.fullName || teacher.name) : 'Teacher';
                addActivityLog(`${action === 'approve' ? 'Approved' : 'Rejected'} Teacher`, `${teacherName} - ${actionText}`);
                
                // Reload teachers table
                loadTeachersTable();
                
                // Update dashboard counts
                loadDashboardData();
                
            } catch (error) {
                showError(`Failed to ${action} teacher: ` + error.message);
            }
        }

        async function saveTeacher() {
            const name = document.getElementById('teacherName').value;
            const subject = document.getElementById('teacherSubject').value;
            const grade = document.getElementById('teacherGrade').value;
            const phone = document.getElementById('teacherPhone').value;
            const email = document.getElementById('teacherEmail').value;
            
            if (!name || !subject || !phone) {
                showError('Please fill all required fields (Name, Subject, Phone)');
                return;
            }
            
            // Show loading
            const btn = saveTeacherBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;
            
            try {
                // REALTIME DATABASE IMPLEMENTATION
                const teacherId = database.ref().child('teachers').push().key;
                const teacherData = {
                    id: teacherId,
                    name: name,
                    subject: subject,
                    grade: grade,
                    phone: phone,
                    email: email,
                    status: 'approved', // Admin-added teachers are auto-approved
                    approved: true,
                    addedDate: new Date().toISOString(),
                    addedBy: currentUser.uid,
                    addedByName: currentAdmin?.name || currentUser.displayName || 'Admin',
                    updatedAt: new Date().toISOString(),
                    role: 'teacher'
                };
                
                await database.ref('teachers/' + teacherId).set(teacherData);
                
                showSuccess('Teacher added successfully!');
                
                // Add to teachers array
                teachers.push(teacherData);
                
                // Close modal
                document.getElementById('addTeacherModal').style.display = 'none';
                
                // Update dashboard
                loadDashboardData();
                
                // If on manage teachers tab, refresh
                if (document.getElementById('manageTeachersSection').style.display === 'block') {
                    loadTeachersTable();
                }
                
                // Clear form
                clearTeacherForm();
                
                // Log activity
                addActivityLog('Added Teacher', `${name} - ${subject}`);
                
            } catch (error) {
                showError('Failed to add teacher: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherGrade').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherEmail').value = '';
        }

        // ============================
        // ADMIN MANAGEMENT FUNCTIONS - UPDATED TO LOAD PROFILE IMAGES FROM DATABASE
        // ============================
        async function loadAdminsTable() {
            try {
                // REALTIME DATABASE IMPLEMENTATION
                const snapshot = await database.ref('admins').once('value');
                
                admins = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const admin = childSnapshot.val();
                        admin.id = childSnapshot.key;
                        admins.push(admin);
                    });
                }
                
                // Update admin count
                adminCount.textContent = admins.length;
                
                // Clear table
                adminsTableBody.innerHTML = '';
                
                // Check if we have admins
                if (admins.length === 0) {
                    adminsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-user-shield" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>No admins found</h3>
                                <p>Add your first admin using the "Add Admin" button</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Add admins to table
                admins.forEach(admin => {
                    const row = document.createElement('tr');
                    
                    // Status badge
                    const statusBadge = admin.status === 'active' 
                        ? '<span class="status-badge status-active">Active</span>' 
                        : '<span class="status-badge status-inactive">Inactive</span>';
                    
                    // Role display
                    const roleDisplay = admin.role === 'super_admin' ? 'Super Admin' : 'Admin';
                    
                    row.innerHTML = `
                        <td>
                            <div class="profile-image-container">
                                ${admin.profileImage && (admin.profileImage.startsWith('http') || admin.profileImage.startsWith('blob')) ? 
                                    `<img src="${admin.profileImage}" alt="${admin.name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>';">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                        </td>
                        <td><strong>${admin.name}</strong></td>
                        <td>${admin.email}</td>
                        <td>${roleDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm edit-admin-btn" data-id="${admin.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${admin.id !== currentUser?.uid ? `
                                <button class="btn btn-danger btn-sm delete-admin-btn" data-id="${admin.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    adminsTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-admin-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const adminId = this.dataset.id;
                        editAdmin(adminId);
                    });
                });
                
                document.querySelectorAll('.delete-admin-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const adminId = this.dataset.id;
                        const admin = admins.find(a => a.id === adminId);
                        const adminName = admin ? admin.name : 'this admin';
                        showDeleteConfirmation('admin', adminId, `Are you sure you want to delete ${adminName}?`);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load admins:', error);
                showError('Could not load admins from database. Using sample data.');
                
                // Use sample data as fallback
                adminCount.textContent = admins.length;
                
                // Clear table
                adminsTableBody.innerHTML = '';
                
                // Add sample admins to table (with profile images from your database)
                const sampleAdmins = [
                    {
                        id: 'BJc2OteAUtXeO3ddrfsJP102iNy2',
                        name: 'VIJAY KUMAR',
                        email: 'vijaygond2024@gmail.com',
                        role: 'super_admin',
                        status: 'active',
                        profileImage: 'blob:https://swayamvarapp26-oss.github.io/f27d4ee4-3a89-464a-9e05-cb97eeeb251b'
                    },
                    {
                        id: 'S7R43IBsAkegvAEA1Mr5WDlyDXt2',
                        name: 'AMIT KUMAR',
                        email: 'aviptasker@gmail.com',
                        role: 'admin',
                        status: 'active',
                        profileImage: 'blob:https://run-html-chat.deepseeksvc.com/4a1d7e5a-6e84-4d72-aadf-5c00e3b36c1a'
                    }
                ];
                
                sampleAdmins.forEach(admin => {
                    const row = document.createElement('tr');
                    
                    // Status badge
                    const statusBadge = admin.status === 'active' 
                        ? '<span class="status-badge status-active">Active</span>' 
                        : '<span class="status-badge status-inactive">Inactive</span>';
                    
                    // Role display
                    const roleDisplay = admin.role === 'super_admin' ? 'Super Admin' : 'Admin';
                    
                    row.innerHTML = `
                        <td>
                            <div class="profile-image-container">
                                ${admin.profileImage ? 
                                    `<img src="${admin.profileImage}" alt="${admin.name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>';">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                        </td>
                        <td><strong>${admin.name}</strong></td>
                        <td>${admin.email}</td>
                        <td>${roleDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm edit-admin-btn" data-id="${admin.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${admin.id !== currentUser?.uid ? `
                                <button class="btn btn-danger btn-sm delete-admin-btn" data-id="${admin.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    adminsTableBody.appendChild(row);
                });
            }
        }

        async function saveAdmin() {
            const name = document.getElementById('adminNameInput').value;
            const email = document.getElementById('adminEmailInput').value;
            const role = document.getElementById('adminRoleSelect').value;
            const status = document.getElementById('adminStatusSelect').value;
            const password = document.getElementById('adminPasswordInput').value;
            
            if (!name || !email || !password) {
                showError('Please fill all required fields (Name, Email, Password)');
                return;
            }
            
            // Check password requirements
            let requirements = [];
            if (password.length < 6) requirements.push('at least 6 characters');
            if (!/[a-z]/.test(password)) requirements.push('one lowercase letter');
            if (!/[A-Z]/.test(password)) requirements.push('one uppercase letter');
            if (!/[0-9]/.test(password)) requirements.push('one number');
            
            if (requirements.length > 0) {
                showError('Password must contain: ' + requirements.join(', '));
                return;
            }
            
            // Show loading
            const btn = saveAdminBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;
            
            try {
                // Check if email already exists
                const methods = await auth.fetchSignInMethodsForEmail(email);
                if (methods.length > 0) {
                    showError('Email already registered. Please use a different email.');
                    return;
                }
                
                // Create user in Firebase
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                // Create admin record in database
                const adminData = {
                    name: name,
                    email: email,
                    role: role,
                    status: status,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    createdByName: currentAdmin?.name || currentUser.displayName || 'Admin'
                };
                
                try {
                    await database.ref('admins/' + userCredential.user.uid).set(adminData);
                } catch (dbError) {
                    console.warn('Could not save admin to database:', dbError);
                    // Continue even if database save fails
                }
                
                // Send welcome email
                try {
                    await sendWelcomeEmail(email, name, password);
                } catch (emailError) {
                    console.warn('Failed to send welcome email:', emailError);
                    // Continue even if email fails
                }
                
                showSuccess('Admin created successfully! Welcome email sent.');
                
                // Close modal
                document.getElementById('addAdminModal').style.display = 'none';
                
                // Update dashboard
                loadDashboardData();
                
                // If on manage admins tab, refresh
                if (document.getElementById('manageAdminsSection').style.display === 'block') {
                    loadAdminsTable();
                }
                
                // Clear form
                clearAdminForm();
                
                // Log activity
                addActivityLog('Added Admin', `${name} - ${role}`);
                
            } catch (error) {
                showError('Failed to create admin: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function sendWelcomeEmail(email, name, password) {
            try {
                const templateParams = {
                    to_email: email,
                    admin_name: name,
                    admin_email: email,
                    admin_password: password,
                    login_url: window.location.origin,
                    date: new Date().toLocaleDateString()
                };

                await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    'template_xyk8468', // Using the same template for now
                    templateParams
                );
                
                return true;
            } catch (error) {
                console.error('Welcome email error:', error);
                return false;
            }
        }

        function editAdmin(adminId) {
            const admin = admins.find(a => a.id === adminId);
            if (!admin) return;
            
            // For now, just show an alert. You can implement a full edit modal.
            alert(`Edit Admin: ${admin.name}\n\nEmail: ${admin.email}\nRole: ${admin.role}\nStatus: ${admin.status}\n\nEdit functionality to be implemented.`);
        }

        function clearAdminForm() {
            document.getElementById('adminNameInput').value = '';
            document.getElementById('adminEmailInput').value = '';
            document.getElementById('adminRoleSelect').value = 'admin';
            document.getElementById('adminStatusSelect').value = 'active';
            document.getElementById('adminPasswordInput').value = '';
        }

        // ============================
        // DELETE FUNCTIONS (USING REALTIME DATABASE)
        // ============================
        function showDeleteConfirmation(type, id, message) {
            itemToDelete = id;
            deleteType = type;
            
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        async function confirmDelete() {
            if (!itemToDelete || !deleteType) return;
            
            // Show loading
            confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            confirmDeleteBtn.disabled = true;
            
            try {
                if (deleteType === 'notice') {
                    // REALTIME DATABASE IMPLEMENTATION
                    try {
                        await database.ref('notices/' + itemToDelete).remove();
                    } catch (error) {
                        console.warn('Could not delete notice from database:', error);
                    }
                    
                    // Remove from local state
                    const index = notices.findIndex(n => n.id === itemToDelete);
                    if (index !== -1) {
                        const noticeTitle = notices[index].title;
                        notices.splice(index, 1);
                        
                        showSuccess(`Notice "${noticeTitle}" deleted successfully!`);
                        addActivityLog('Deleted Notice', noticeTitle);
                    }
                    
                    // Update UI
                    loadDashboardData();
                    if (document.getElementById('manageNoticesSection').style.display === 'block') {
                        loadNoticesTable();
                    }
                    
                } else if (deleteType === 'teacher') {
                    // REALTIME DATABASE IMPLEMENTATION
                    try {
                        await database.ref('teachers/' + itemToDelete).remove();
                    } catch (error) {
                        console.warn('Could not delete teacher from database:', error);
                    }
                    
                    // Remove from local state
                    const index = teachers.findIndex(t => t.id === itemToDelete);
                    if (index !== -1) {
                        const teacherName = teachers[index].name;
                        teachers.splice(index, 1);
                        
                        showSuccess(`Teacher "${teacherName}" deleted successfully!`);
                        addActivityLog('Deleted Teacher', teacherName);
                    }
                    
                    // Update UI
                    loadDashboardData();
                    if (document.getElementById('manageTeachersSection').style.display === 'block') {
                        loadTeachersTable();
                    }
                    
                } else if (deleteType === 'admin') {
                    // Don't allow deleting current user
                    if (itemToDelete === currentUser?.uid) {
                        showError('You cannot delete your own account!');
                        return;
                    }
                    
                    // REALTIME DATABASE IMPLEMENTATION
                    try {
                        await database.ref('admins/' + itemToDelete).remove();
                    } catch (error) {
                        console.warn('Could not delete admin from database:', error);
                    }
                    
                    // Remove from local state
                    const index = admins.findIndex(a => a.id === itemToDelete);
                    if (index !== -1) {
                        const adminName = admins[index].name;
                        admins.splice(index, 1);
                        
                        showSuccess(`Admin "${adminName}" deleted successfully!`);
                        addActivityLog('Deleted Admin', adminName);
                    }
                    
                    // Update UI
                    loadDashboardData();
                    if (document.getElementById('manageAdminsSection').style.display === 'block') {
                        loadAdminsTable();
                    }
                }
                
            } catch (error) {
                showError('Failed to delete: ' + error.message);
            } finally {
                // Close modal
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
                
                // Reset button
                confirmDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                confirmDeleteBtn.disabled = false;
            }
        }

        // ============================
        // SETTINGS FUNCTIONS
        // ============================
        function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('Image size should be less than 5MB');
                return;
            }
            
            // Show loading
            changeProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            changeProfileBtn.disabled = true;
            
            // In a real implementation, you would upload to Firebase Storage here
            // For demo purposes, we'll use a simulated upload
            
            setTimeout(() => {
                // Create object URL for preview
                const imageUrl = URL.createObjectURL(file);
                
                // Update profile images
                updateProfileImage(adminAvatar, imageUrl);
                updateProfileImage(settingsProfileImage, imageUrl);
                
                // Save to Firebase (in real app, upload to Firebase Storage first)
                if (currentUser) {
                    try {
                        database.ref('admins/' + currentUser.uid).update({
                            profileImage: imageUrl,
                            updatedAt: new Date().toISOString()
                        }).then(() => {
                            showSuccess('Profile picture updated successfully!');
                            addActivityLog('Updated Profile Picture', 'Changed profile image');
                        }).catch(error => {
                            console.warn('Could not update profile in database:', error);
                            showSuccess('Profile picture updated locally!');
                        });
                    } catch (error) {
                        console.warn('Database update failed:', error);
                        showSuccess('Profile picture updated locally!');
                    }
                }
                
                // Reset button
                changeProfileBtn.innerHTML = '<i class="fas fa-camera"></i> Change Profile Picture';
                changeProfileBtn.disabled = false;
            }, 1500);
        }

        async function updateProfile() {
            const name = document.getElementById('settingsName').value;
            
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            // Show loading
            const btn = updateProfileBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            btn.disabled = true;
            
            try {
                // Update in Realtime Database
                try {
                    await database.ref('admins/' + currentUser.uid).update({
                        name: name,
                        updatedAt: new Date().toISOString()
                    });
                } catch (dbError) {
                    console.warn('Could not update profile in database:', dbError);
                }
                
                // Update in Firebase Auth
                await currentUser.updateProfile({
                    displayName: name
                });
                
                // Update local state
                currentUser.displayName = name;
                if (currentAdmin) {
                    currentAdmin.name = name;
                }
                adminName.textContent = name;
                
                showSuccess('Profile updated successfully!');
                addActivityLog('Updated Profile', 'Changed display name');
                
            } catch (error) {
                showError('Failed to update profile: ' + error.message);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            // Check password requirements
            let requirements = [];
            
            if (newPassword.length < 6) {
                requirements.push('at least 6 characters');
            }
            if (!/[a-z]/.test(newPassword)) {
                requirements.push('one lowercase letter');
            }
            if (!/[A-Z]/.test(newPassword)) {
                requirements.push('one uppercase letter');
            }
            if (!/[0-9]/.test(newPassword)) {
                requirements.push('one number');
            }
            
            if (requirements.length > 0) {
                showError('Password must contain: ' + requirements.join(', '));
                return;
            }
            
            // Show loading
            const btn = changePasswordBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
            btn.disabled = true;
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Change password
                await currentUser.updatePassword(newPassword);
                
                showSuccess('Password changed successfully!');
                
                // Clear form
                document.getElementById('currentPassword').value = '';
                document.getElementById('settingsNewPassword').value = '';
                document.getElementById('settingsConfirmPassword').value = '';
                
                // Hide password requirements
                passwordRequirements.style.display = 'none';
                
                // Log activity
                addActivityLog('Changed Password', 'Account security update');
                
            } catch (error) {
                // Handle specific Firebase errors
                let errorMessage = 'Failed to change password. ';
                
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Current password is incorrect.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'New password is too weak.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage += 'Please log in again and try.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage += 'Too many attempts. Please try again later.';
                } else {
                    errorMessage += error.message;
                }
                
                showError(errorMessage);
            } finally {
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function loadSampleData() {
            // Sample notices (for demo when Firebase is not connected)
            notices = [
                {
                    id: 'notice_1',
                    title: 'Annual Sports Day Announcement',
                    content: 'We are pleased to announce that our Annual Sports Day will be held on 25th November 2023. All students are required to participate in at least one event. Teachers are requested to coordinate with the sports department.',
                    priority: 'high',
                    category: 'event',
                    recipients: { teachers: true, students: true },
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                },
                {
                    id: 'notice_2',
                    title: 'Library Maintenance Notice',
                    content: 'The main library will be closed for maintenance on 5th October 2023. Students can use the digital library during this period. All borrowed books must be returned by 4th October.',
                    priority: 'medium',
                    category: 'academic',
                    recipients: { teachers: false, students: true },
                    timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                },
                {
                    id: 'notice_3',
                    title: 'Parent-Teacher Meeting Schedule',
                    content: 'Meeting scheduled for all classes from 10th to 15th October 2023. Parents are requested to book their slots through the portal. Teachers should prepare progress reports.',
                    priority: 'high',
                    category: 'general',
                    recipients: { teachers: true, students: true },
                    timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                }
            ];
            
            // Sample teachers (for demo when Firebase is not connected)
            teachers = [
                {
                    id: 'teacher_1',
                    fullName: 'Mr. John Smith',
                    subject: 'Mathematics',
                    grade: 'Grade 10',
                    phone: '+91 9876543210',
                    email: 'john.smith@school.com',
                    addedDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin',
                    status: 'approved',
                    approved: true
                },
                {
                    id: 'teacher_2',
                    fullName: 'Ms. Sarah Johnson',
                    subject: 'Science',
                    grade: 'Grade 9 & 10',
                    phone: '+91 9876543211',
                    email: 'sarah.j@school.com',
                    addedDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin',
                    status: 'approved',
                    approved: true
                },
                {
                    id: 'teacher_3',
                    fullName: 'Mr. Robert Williams',
                    subject: 'English Literature',
                    grade: 'Grade 11 & 12',
                    phone: '+91 9876543212',
                    email: 'robert.w@school.com',
                    addedDate: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                    addedBy: 'Admin',
                    status: 'approved',
                    approved: true
                }
            ];
            
            // Sample admins (for demo when Firebase is not connected)
            admins = [
                {
                    id: 'BJc2OteAUtXeO3ddrfsJP102iNy2',
                    name: 'VIJAY KUMAR',
                    email: 'vijaygond2024@gmail.com',
                    role: 'super_admin',
                    status: 'active',
                    profileImage: 'blob:https://swayamvarapp26-oss.github.io/f27d4ee4-3a89-464a-9e05-cb97eeeb251b',
                    createdAt: '2026-01-12T08:46:17.614Z',
                    createdBy: 'BJc2OteAUtXeO3ddrfsJP102iNy2',
                    createdByName: 'VIJAY',
                    lastLogin: '2026-01-12T16:43:25.792Z',
                    updatedAt: '2026-01-12T08:58:33.087Z'
                },
                {
                    id: 'S7R43IBsAkegvAEA1Mr5WDlyDXt2',
                    name: 'AMIT KUMAR',
                    email: 'aviptasker@gmail.com',
                    role: 'admin',
                    status: 'active',
                    profileImage: 'blob:https://run-html-chat.deepseeksvc.com/4a1d7e5a-6e84-4d72-aadf-5c00e3b36c1a',
                    createdAt: '2026-01-12T09:10:20.466Z',
                    lastLogin: '2026-01-13T02:05:15.118Z'
                }
            ];
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function clearNoticeForm() {
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('noticePriority').value = 'low';
            document.getElementById('noticeCategory').value = 'general';
            document.getElementById('sendToTeachers').checked = true;
            document.getElementById('sendToStudents').checked = true;
        }

        function clearLoginForm() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function addActivityLog(activity, details) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Add to beginning of array
            activityLog.unshift({
                time: timeString,
                activity: activity,
                details: details,
                status: 'Completed'
            });
            
            // Update activity log table if on dashboard
            if (document.getElementById('dashboardSection').style.display === 'block') {
                loadActivityLog();
            }
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
