 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHOOL ADMIN - Management Portal</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #3498db;
            --secondary-dark: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #bdc3c7;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 32px;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .user-details h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-details p {
            font-size: 14px;
            color: var(--light-gray);
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: white;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
            padding: 30px 0;
            transition: var(--transition);
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 18px 30px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            border-left: 5px solid transparent;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 5px solid var(--secondary);
        }

        .nav-links i {
            font-size: 20px;
            margin-right: 15px;
            width: 25px;
        }

        .nav-count {
            background-color: var(--secondary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .card-notices::before { background: linear-gradient(90deg, #3498db, #2ecc71); }
        .card-teachers::before { background: linear-gradient(90deg, #9b59b6, #e74c3c); }
        .card-students::before { background: linear-gradient(90deg, #f39c12, #d35400); }
        .card-urgent::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 30px;
            color: white;
        }

        .card-notices .card-icon { background: linear-gradient(135deg, #3498db, #2ecc71); }
        .card-teachers .card-icon { background: linear-gradient(135deg, #9b59b6, #e74c3c); }
        .card-students .card-icon { background: linear-gradient(135deg, #f39c12, #d35400); }
        .card-urgent .card-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .dashboard-card h3 {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .dashboard-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .dashboard-card .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--gray);
        }

        .trend.up { color: var(--success); }
        .trend.down { color: var(--danger); }

        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h2 i {
            color: var(--secondary);
        }

        /* Forms */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        /* Buttons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-block {
            width: 100%;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: var(--primary);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 16px;
        }

        tbody tr {
            border-bottom: 1px solid var(--light);
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        td {
            padding: 18px 15px;
            color: var(--dark);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Profile image in table */
        .teacher-profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--light);
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--gray);
            overflow: hidden;
        }

        .teacher-profile-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-initials {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .priority-high { background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .priority-medium { background-color: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .priority-low { background-color: rgba(52, 152, 219, 0.1); color: #3498db; }

        /* Call Button */
        .call-btn {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
        }

        .call-btn:hover {
            background-color: rgba(46, 204, 113, 0.2);
            color: #219653;
        }

        /* View Button */
        .view-btn {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(52, 152, 219, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
        }

        .view-btn:hover {
            background-color: rgba(52, 152, 219, 0.2);
            color: var(--secondary-dark);
        }

        /* Profile Image */
        .profile-image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--light);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }

        .profile-image-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            border: 5px solid var(--light);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }

        .upload-profile-btn {
            background-color: var(--light);
            color: var(--dark);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .upload-profile-btn:hover {
            background-color: var(--light-gray);
        }

        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-box {
            background-color: white;
            border-radius: 20px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .auth-logo i {
            font-size: 42px;
            color: var(--secondary);
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        .auth-content {
            display: none;
        }

        .auth-content.active {
            display: block;
        }

        /* Updated OTP Container - Minimal Size */
        .otp-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .otp-input {
            width: 40px;
            height: 45px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            transition: var(--transition);
        }

        .otp-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .resend-otp {
            text-align: center;
            margin-top: 15px;
            color: var(--gray);
            font-size: 14px;
        }

        .resend-otp a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray);
            font-size: 14px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* Teacher Details Modal */
        .teacher-details-modal .modal-content {
            max-width: 700px;
        }

        .teacher-details-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .teacher-header {
            display: flex;
            align-items: center;
            gap: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .teacher-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--light);
            box-shadow: var(--box-shadow);
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            overflow: hidden;
        }

        .teacher-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .teacher-info h3 {
            font-size: 28px;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .teacher-info p {
            color: var(--gray);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .teacher-info .subject-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 5px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--secondary);
        }

        .detail-item h4 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item p {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px 0;
            }
            
            .nav-links {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-links li {
                flex-shrink: 0;
            }
            
            .nav-links a {
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 15px 20px;
            }
            
            .nav-links a:hover, .nav-links a.active {
                border-left: none;
                border-bottom: 3px solid var(--secondary);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .teacher-header {
                flex-direction: column;
                text-align: center;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .auth-box {
                padding: 30px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
            
            .otp-input {
                width: 35px;
                height: 40px;
                font-size: 16px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons .btn,
            .action-buttons .call-btn,
            .action-buttons .view-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screens -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-user-shield"></i>
                    <h1>SCHOOL <span>ADMIN</span></h1>
                </div>
                <p>School Administration Management Portal</p>
            </div>
            
            <!-- Only Login and Reset Password tabs -->
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="forgot">Reset Password</div>
            </div>
            
            <!-- Login Tab -->
            <div class="auth-content active" id="loginTab">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="admin@school.com" value="admin@school.com">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" value="admin123">
                </div>
                
                <div class="form-group" style="text-align: right;">
                    <a href="#" class="forgot-password-link" style="color: var(--secondary); text-decoration: none; font-size: 14px;">
                        Forgot Password?
                    </a>
                </div>
                
                <button class="btn btn-primary btn-block" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login to Admin Panel
                </button>
                
                <div class="auth-footer">
                    <p>Default Admin Credentials: admin@school.com / admin123</p>
                </div>
            </div>
            
            <!-- Forgot Password Tab -->
            <div class="auth-content" id="forgotTab">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" class="form-control" placeholder="Enter your registered email">
                </div>
                
                <button class="btn btn-primary btn-block" id="sendOtpBtn">
                    <i class="fas fa-paper-plane"></i> Send OTP to Email
                </button>
                
                <!-- Updated minimal OTP box -->
                <div class="otp-container" id="forgotOtpContainer" style="display: none; margin-top: 20px;">
                    <input type="text" class="otp-input" maxlength="1" data-index="0">
                    <input type="text" class="otp-input" maxlength="1" data-index="1">
                    <input type="text" class="otp-input" maxlength="1" data-index="2">
                    <input type="text" class="otp-input" maxlength="1" data-index="3">
                    <input type="text" class="otp-input" maxlength="1" data-index="4">
                    <input type="text" class="otp-input" maxlength="1" data-index="5">
                </div>
                
                <div class="resend-otp" id="forgotResendOtp" style="display: none;">
                    <p>Didn't receive OTP? <a href="#" id="forgotResendLink">Resend OTP</a></p>
                    <p id="forgotOtpTimer" style="color: var(--danger); font-weight: 600;"></p>
                </div>
                
                <button class="btn btn-success btn-block" id="verifyOtpBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Verify OTP
                </button>
                
                <div id="resetPasswordForm" style="display: none;">
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                    </div>
                    
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="resetPasswordBtn">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h1>SCHOOL <span>ADMIN</span></h1>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="adminAvatar"></div>
                <div class="user-details">
                    <h3 id="adminName">Admin User</h3>
                    <p id="adminEmail">admin@school.com</p>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <!-- Main Container -->
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <ul class="nav-links">
                    <li>
                        <a href="#" class="active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="sendNotice">
                            <i class="fas fa-bullhorn"></i>
                            <span>Send Notice</span>
                            <span class="nav-count" id="noticeCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageNotices">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Manage Notices</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageTeachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Manage Teachers</span>
                            <span class="nav-count" id="teacherCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="manageAdmins">
                            <i class="fas fa-user-shield"></i>
                            <span>Manage Admins</span>
                            <span class="nav-count" id="adminCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboardSection">
                    <div class="section-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p id="currentDate">Loading date...</p>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card card-notices">
                            <div class="card-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <h3>Total Notices</h3>
                            <div class="number" id="totalNoticesCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>5 sent this week</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-teachers">
                            <div class="card-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h3>Teachers</h3>
                            <div class="number" id="totalTeachersCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>2 new this month</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-students">
                            <div class="card-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3>Students (App Users)</h3>
                            <div class="number" id="totalStudentsCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>45 active today</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card card-urgent">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Active Admins</h3>
                            <div class="number" id="activeAdminsCount">0</div>
                            <div class="trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>All systems operational</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityLog">
                                <!-- Activity log will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Send Notice Section -->
                <div class="content-section" id="sendNoticeSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-bullhorn"></i> Send New Notice</h2>
                        <p>Notices will be sent to Teachers & Students apps</p>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label for="noticeTitle">Notice Title *</label>
                            <input type="text" id="noticeTitle" class="form-control" placeholder="Enter notice title">
                        </div>
                        
                        <div class="form-group">
                            <label for="noticeContent">Notice Content *</label>
                            <textarea id="noticeContent" class="form-control textarea" placeholder="Enter notice content..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="noticePriority">Priority Level</label>
                                <select id="noticePriority" class="form-control">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="noticeCategory">Category</label>
                                <select id="noticeCategory" class="form-control">
                                    <option value="general">General Announcement</option>
                                    <option value="academic">Academic</option>
                                    <option value="exam">Exam Related</option>
                                    <option value="event">School Event</option>
                                    <option value="holiday">Holiday</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Send To *</label>
                            <div style="display: flex; gap: 30px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToTeachers" checked>
                                    <label for="sendToTeachers">All Teachers</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="sendToStudents" checked>
                                    <label for="sendToStudents">All Students</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                            <button type="button" class="btn btn-primary pulse" id="sendNoticeBtn">
                                <i class="fas fa-paper-plane"></i> Send Notice
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Notices Section -->
                <div class="content-section" id="manageNoticesSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-clipboard-list"></i> Manage Notices</h2>
                        <button class="btn btn-primary" id="refreshNoticesBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                    <th>Sent To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="noticesTableBody">
                                <!-- Notices will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Teachers Section -->
                <div class="content-section" id="manageTeachersSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-chalkboard-teacher"></i> Manage Teachers</h2>
                        <button class="btn btn-success" id="addTeacherBtn">
                            <i class="fas fa-plus"></i> Add Teacher
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Phone Number</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody">
                                <!-- Teachers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Admins Section -->
                <div class="content-section" id="manageAdminsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-user-shield"></i> Manage Admins</h2>
                        <button class="btn btn-success" id="addAdminBtn">
                            <i class="fas fa-plus"></i> Add Admin
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Admins will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="content-section" id="settingsSection" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                    </div>
                    
                    <div class="form-container">
                        <!-- Profile Image Section -->
                        <div class="profile-image-container">
                            <div id="profileImageContainer">
                                <!-- Profile image will be loaded here -->
                            </div>
                            <button class="upload-profile-btn" id="uploadProfileBtn">
                                <i class="fas fa-camera"></i> Change Profile Picture
                            </button>
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-user-circle"></i> Account Settings
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="settingsName" class="form-control" placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="settingsEmail" class="form-control" placeholder="Enter your email" disabled>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="updateProfileBtn">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                        
                        <!-- Password Reset Section -->
                        <div class="form-group" style="margin-top: 40px;">
                            <h3 style="margin-bottom: 20px; color: var(--primary);">
                                <i class="fas fa-key"></i> Change Password
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="resetEmail" class="form-control" placeholder="Enter your registered email">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="sendResetOtpBtn">
                                <i class="fas fa-paper-plane"></i> Send OTP to Email
                            </button>
                        </div>
                        
                        <div class="otp-container" id="resetOtpContainer" style="display: none; margin-top: 20px;">
                            <input type="text" class="otp-input" maxlength="1" data-index="0">
                            <input type="text" class="otp-input" maxlength="1" data-index="1">
                            <input type="text" class="otp-input" maxlength="1" data-index="2">
                            <input type="text" class="otp-input" maxlength="1" data-index="3">
                            <input type="text" class="otp-input" maxlength="1" data-index="4">
                            <input type="text" class="otp-input" maxlength="1" data-index="5">
                        </div>
                        
                        <div class="resend-otp" id="resetResendOtp" style="display: none;">
                            <p>Didn't receive OTP? <a href="#" id="resetResendLink">Resend OTP</a></p>
                            <p id="resetOtpTimer" style="color: var(--danger); font-weight: 600;"></p>
                        </div>
                        
                        <button class="btn btn-success btn-block" id="verifyResetOtpBtn" style="display: none;">
                            <i class="fas fa-check-circle"></i> Verify OTP
                        </button>
                        
                        <div id="changePasswordForm" style="display: none;">
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="settingsNewPassword" class="form-control" placeholder="Enter new password">
                            </div>
                            
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="settingsConfirmPassword" class="form-control" placeholder="Confirm new password">
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="changePasswordBtn">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add Teacher Modal -->
    <div class="modal" id="addTeacherModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Teacher</h3>
                <button class="close-modal" id="closeTeacherModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="teacherName" class="form-control" placeholder="Enter teacher's full name">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Subject *</label>
                    <input type="text" id="teacherSubject" class="form-control" placeholder="e.g., Mathematics">
                </div>
                
                <div class="form-group">
                    <label>Grade/Class</label>
                    <input type="text" id="teacherGrade" class="form-control" placeholder="e.g., Grade 10">
                </div>
            </div>
            
            <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" id="teacherPhone" class="form-control" placeholder="+91 9876543210">
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="teacherEmail" class="form-control" placeholder="teacher@school.com">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveTeacherBtn">
                    <i class="fas fa-save"></i> Save Teacher
                </button>
            </div>
        </div>
    </div>
    
    <!-- Teacher Details Modal -->
    <div class="modal teacher-details-modal" id="teacherDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chalkboard-teacher"></i> Teacher Details</h3>
                <button class="close-modal" id="closeTeacherDetailsModal">&times;</button>
            </div>
            
            <div class="teacher-details-container" id="teacherDetailsContent">
                <!-- Teacher details will be loaded here -->
            </div>
            
            <div class="form-actions" style="margin-top: 25px;">
                <button type="button" class="btn btn-secondary" id="closeTeacherDetailsBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Admin Modal -->
    <div class="modal" id="addAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-shield"></i> Add New Admin</h3>
                <button class="close-modal" id="closeAdminModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="adminNameInput" class="form-control" placeholder="Enter admin's full name">
            </div>
            
            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="adminEmailInput" class="form-control" placeholder="admin@school.com">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Role *</label>
                    <select id="adminRole" class="form-control">
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="adminStatus" class="form-control">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Initial Password *</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter initial password">
                <small style="color: var(--gray); margin-top: 5px; display: block;">
                    Admin will be able to change this password after first login
                </small>
            </div>
            
            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" id="adminConfirmPassword" class="form-control" placeholder="Confirm password">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelAdminBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAdminBtn">
                    <i class="fas fa-save"></i> Create Admin Account
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Confirm Delete</h3>
                <button class="close-modal" id="closeDeleteModal">&times;</button>
            </div>
            
            <div class="form-group">
                <p id="deleteMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div id="successMessage" style="display: none; position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <div>
                <h4 style="margin-bottom: 5px;">Success!</h4>
                <p id="successText">Operation completed successfully.</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase Configuration and App Logic -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
            authDomain: "schooladmin-51cdd.firebaseapp.com",
            databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
            projectId: "schooladmin-51cdd",
            storageBucket: "schooladmin-51cdd.firebasestorage.app",
            messagingSenderId: "185301938780",
            appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
            measurementId: "G-V8C5DE930K"
        };

        // EmailJS Configuration
        const emailjsConfig = {
            serviceId: 'service_u035226',
            templateId: 'template_xyk8468',
            publicKey: 'D-8liyb21zvqmvhPc'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize EmailJS
        (function() {
            emailjs.init(emailjsConfig.publicKey);
            console.log('EmailJS initialized with public key:', emailjsConfig.publicKey);
        })();

        // Application State
        let currentUser = null;
        let currentAdmin = null;
        let notices = [];
        let teachers = [];
        let admins = [];
        let activityLog = [];
        let itemToDelete = null;
        let deleteType = null;
        let otpStore = {}; // Store OTPs temporarily

        // Default profile image URL
        const defaultProfileImage = "https://res.cloudinary.com/dmhyflswb/image/upload/v1766410851/teacher_app/profiles/upoa2bskjucas6ogpwuh.png";

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminName = document.getElementById('adminName');
        const adminEmail = document.getElementById('adminEmail');
        const adminAvatar = document.getElementById('adminAvatar');
        const profileImageContainer = document.getElementById('profileImageContainer');
        
        // Auth Elements
        const authTabs = document.querySelectorAll('.auth-tab');
        const authContents = document.querySelectorAll('.auth-content');
        const loginBtn = document.getElementById('loginBtn');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        
        // Teacher Elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const teachersTableBody = document.getElementById('teachersTableBody');
        const saveTeacherBtn = document.getElementById('saveTeacherBtn');
        const cancelTeacherBtn = document.getElementById('cancelTeacherBtn');
        const closeTeacherModal = document.getElementById('closeTeacherModal');
        const addTeacherModal = document.getElementById('addTeacherModal');
        
        // Teacher Details Modal Elements
        const teacherDetailsModal = document.getElementById('teacherDetailsModal');
        const teacherDetailsContent = document.getElementById('teacherDetailsContent');
        const closeTeacherDetailsModal = document.getElementById('closeTeacherDetailsModal');
        const closeTeacherDetailsBtn = document.getElementById('closeTeacherDetailsBtn');
        
        // Admin Management
        const addAdminBtn = document.getElementById('addAdminBtn');
        const saveAdminBtn = document.getElementById('saveAdminBtn');
        const cancelAdminBtn = document.getElementById('cancelAdminBtn');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const addAdminModal = document.getElementById('addAdminModal');
        const adminsTableBody = document.getElementById('adminsTableBody');
        const adminCount = document.getElementById('adminCount');
        const activeAdminsCount = document.getElementById('activeAdminsCount');
        
        // Profile Image
        const uploadProfileBtn = document.getElementById('uploadProfileBtn');
        const profileImageInput = document.getElementById('profileImageInput');
        
        // Settings Elements
        const sendResetOtpBtn = document.getElementById('sendResetOtpBtn');
        const verifyResetOtpBtn = document.getElementById('verifyResetOtpBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const resetEmail = document.getElementById('resetEmail');
        const resetOtpContainer = document.getElementById('resetOtpContainer');
        const resetResendOtp = document.getElementById('resetResendOtp');
        const changePasswordForm = document.getElementById('changePasswordForm');
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-links a');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Dashboard Elements
        const totalNoticesCount = document.getElementById('totalNoticesCount');
        const totalTeachersCount = document.getElementById('totalTeachersCount');
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const noticeCount = document.getElementById('noticeCount');
        const teacherCount = document.getElementById('teacherCount');
        const activityLogTable = document.getElementById('activityLog');
        const currentDateElement = document.getElementById('currentDate');
        
        // Notice Elements
        const sendNoticeBtn = document.getElementById('sendNoticeBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const refreshNoticesBtn = document.getElementById('refreshNoticesBtn');
        const noticesTableBody = document.getElementById('noticesTableBody');
        
        // Modal Elements
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // Settings Elements
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Success Message
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            currentDateElement.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Check if user is already logged in
            checkAuthState();
            
            // Load data from Firebase
            loadDataFromFirebase();
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Auth Tab Switching
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Update active tab
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    authContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId + 'Tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // Forgot password link
            document.querySelector('.forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                authTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.auth-tab[data-tab="forgot"]').classList.add('active');
                authContents.forEach(content => content.classList.remove('active'));
                document.getElementById('forgotTab').classList.add('active');
            });

            // Login
            loginBtn.addEventListener('click', handleLogin);
            
            // Send OTP for password reset (forgot password tab)
            sendOtpBtn.addEventListener('click', handleSendOtp);
            
            // Verify OTP for password reset (forgot password tab)
            verifyOtpBtn.addEventListener('click', handleVerifyOtp);
            
            // Reset Password (forgot password tab)
            resetPasswordBtn.addEventListener('click', handleResetPassword);
            
            // Resend OTP links
            document.getElementById('forgotResendLink')?.addEventListener('click', handleResendForgotOtp);
            document.getElementById('resetResendLink')?.addEventListener('click', handleResendResetOtp);

            // Teacher Management
            addTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'flex';
            });
            
            saveTeacherBtn.addEventListener('click', saveTeacher);
            cancelTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            closeTeacherModal.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            // Teacher Details Modal
            closeTeacherDetailsModal.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });
            
            closeTeacherDetailsBtn.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });

            // Admin Management
            addAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'flex';
            });
            
            saveAdminBtn.addEventListener('click', handleAddAdmin);
            cancelAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });
            
            closeAdminModal.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });

            // Profile Image Upload
            uploadProfileBtn.addEventListener('click', () => {
                profileImageInput.click();
            });
            
            profileImageInput.addEventListener('change', handleProfileImageUpload);

            // Settings - Password Reset
            sendResetOtpBtn.addEventListener('click', handleSendResetOtp);
            verifyResetOtpBtn.addEventListener('click', handleVerifyResetOtp);
            changePasswordBtn.addEventListener('click', handleChangePasswordInSettings);

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = link.dataset.section + 'Section';
                    contentSections.forEach(section => {
                        section.style.display = 'none';
                        if (section.id === sectionId) {
                            section.style.display = 'block';
                        }
                    });
                    
                    // Load section data if needed
                    if (sectionId === 'manageNoticesSection') {
                        loadNoticesTable();
                    } else if (sectionId === 'manageTeachersSection') {
                        loadTeachersTable();
                    } else if (sectionId === 'manageAdminsSection') {
                        loadAdminsTable();
                    }
                });
            });

            // Notice Management
            sendNoticeBtn.addEventListener('click', sendNotice);
            saveDraftBtn.addEventListener('click', saveNoticeAsDraft);
            refreshNoticesBtn.addEventListener('click', loadNoticesTable);

            // Modal Controls
            closeDeleteModal.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
            });
            
            cancelDeleteBtn.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
            });
            
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            // Settings
            updateProfileBtn.addEventListener('click', updateProfile);
            logoutBtn.addEventListener('click', handleLogout);

            // OTP Input Handling
            setupOtpInputs();
        }

        // Firebase Functions
        async function loadDataFromFirebase() {
            try {
                // Load admins
                const adminsSnapshot = await database.ref('admins').once('value');
                const firebaseAdmins = adminsSnapshot.val();
                
                if (firebaseAdmins) {
                    admins = Object.keys(firebaseAdmins).map(adminId => ({
                        id: adminId,
                        ...firebaseAdmins[adminId]
                    }));
                    updateCounts();
                }
                
                // Load notices
                const noticesSnapshot = await database.ref('notices').once('value');
                const firebaseNotices = noticesSnapshot.val();
                
                if (firebaseNotices) {
                    notices = Object.keys(firebaseNotices).map(noticeId => ({
                        id: noticeId,
                        ...firebaseNotices[noticeId]
                    }));
                    updateCounts();
                }
                
                // Load teachers from the actual Firebase path
                const teachersSnapshot = await database.ref().once('value');
                const allData = teachersSnapshot.val();
                teachers = [];
                
                // Find all teacher records in the database
                for (const key in allData) {
                    if (allData[key] && typeof allData[key] === 'object') {
                        for (const userId in allData[key]) {
                            const user = allData[key][userId];
                            if (user && user.role === 'teacher' && user.status === 'approved') {
                                teachers.push({
                                    id: userId,
                                    ...user
                                });
                            }
                        }
                    }
                }
                
                console.log('Loaded teachers from Firebase:', teachers);
                updateCounts();
                
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                // Load sample data if Firebase fails
                loadSampleData();
            }
        }

        // Update Counts Function
        function updateCounts() {
            // Update admin counts
            adminCount.textContent = admins.length;
            const activeAdmins = admins.filter(a => a.isActive !== false).length;
            activeAdminsCount.textContent = activeAdmins;
            
            // Update notice counts
            noticeCount.textContent = notices.length;
            totalNoticesCount.textContent = notices.length;
            
            // Update teacher counts
            teacherCount.textContent = teachers.length;
            totalTeachersCount.textContent = teachers.length;
            
            // Update student count (simulated)
            totalStudentsCount.textContent = '2847';
        }

        // Profile Image Functions
        function getProfileImageUrl(teacher) {
            // Return the profile image URL if it exists, otherwise use default
            if (teacher.profileImage && teacher.profileImage.trim() !== '') {
                return teacher.profileImage;
            }
            return defaultProfileImage;
        }

        function getInitials(name) {
            if (!name) return '?';
            const nameParts = name.split(' ');
            if (nameParts.length >= 2) {
                return (nameParts[0][0] + nameParts[1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }

        function loadProfileImage() {
            const profileImageUrl = currentAdmin?.profileImage || defaultProfileImage;
            
            // Update header avatar
            adminAvatar.style.backgroundImage = `url('${profileImageUrl}')`;
            adminAvatar.innerHTML = ''; // Remove text
            
            // Update settings profile image
            profileImageContainer.innerHTML = `
                <img src="${profileImageUrl}" alt="Profile" class="profile-image" id="profileImage">
            `;
        }

        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showSuccess('Profile image updated! Using default image for demo.');
            
            // Update profile image in Firebase
            try {
                await updateAdminProfile({
                    profileImage: defaultProfileImage,
                    updatedAt: new Date().toISOString()
                });
                
                // Update current admin
                currentAdmin.profileImage = defaultProfileImage;
                
                // Reload profile image
                loadProfileImage();
                
                addActivityLog('Updated Profile', 'Changed profile picture');
                
            } catch (error) {
                console.error('Error updating profile image:', error);
                showError('Failed to update profile image');
            }
            
            // Reset file input
            event.target.value = '';
        }

        // Teacher Management Functions
        async function saveTeacher() {
            const name = document.getElementById('teacherName').value;
            const subject = document.getElementById('teacherSubject').value;
            const grade = document.getElementById('teacherGrade').value;
            const phone = document.getElementById('teacherPhone').value;
            const email = document.getElementById('teacherEmail').value;
            
            if (!name || !subject || !phone) {
                showError('Please fill all required fields (Name, Subject, Phone)');
                return;
            }
            
            // Create teacher object
            const teacher = {
                name: name,
                subject: subject,
                phone: phone,
                email: email || '',
                grade: grade || ''
            };
            
            try {
                // Show loading
                saveTeacherBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveTeacherBtn.disabled = true;
                
                // Save to Firebase
                const teacherId = await saveTeacherToFirebase(teacher);
                
                // Add to local array with ID
                teacher.id = teacherId;
                teacher.addedDate = new Date().toISOString();
                teacher.profileImage = defaultProfileImage;
                teachers.push(teacher);
                
                // Update counts
                updateCounts();
                
                showSuccess('Teacher added successfully!');
                
                // Close modal
                document.getElementById('addTeacherModal').style.display = 'none';
                
                // If on manage teachers tab, refresh
                if (document.getElementById('manageTeachersSection').style.display === 'block') {
                    loadTeachersTable();
                }
                
                // Clear form
                clearTeacherForm();
                
                // Log activity
                addActivityLog('Added Teacher', `${name} - ${subject}`);
                
            } catch (error) {
                console.error('Error saving teacher:', error);
                showError('Failed to add teacher. Please try again.');
            } finally {
                // Reset button
                saveTeacherBtn.innerHTML = '<i class="fas fa-save"></i> Save Teacher';
                saveTeacherBtn.disabled = false;
            }
        }

        async function saveTeacherToFirebase(teacher) {
            try {
                const teacherRef = database.ref('teachers').push();
                const teacherId = teacherRef.key;
                
                const teacherData = {
                    id: teacherId,
                    name: teacher.name,
                    subject: teacher.subject,
                    phone: teacher.phone,
                    email: teacher.email || '',
                    grade: teacher.grade || '',
                    addedDate: new Date().toISOString(),
                    addedBy: currentUser.uid,
                    addedByName: currentAdmin?.name || currentUser.displayName || 'Admin',
                    profileImage: defaultProfileImage,
                    role: 'teacher',
                    status: 'approved'
                };
                
                await teacherRef.set(teacherData);
                return teacherId;
            } catch (error) {
                console.error('Error saving teacher to Firebase:', error);
                throw error;
            }
        }

        function loadTeachersTable() {
            // Clear table
            teachersTableBody.innerHTML = '';
            
            // Check if we have teachers
            if (teachers.length === 0) {
                teachersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No teachers added yet</h3>
                            <p>Add your first teacher using the "Add Teacher" button</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add teachers to table with profile images
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                const profileImageUrl = getProfileImageUrl(teacher);
                const initials = getInitials(teacher.name || teacher.fullName);
                
                row.innerHTML = `
                    <td>
                        <div class="teacher-profile-img">
                            ${profileImageUrl ? 
                                `<img src="${profileImageUrl}" alt="${teacher.name || teacher.fullName}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\"profile-initials\">${initials}</div>';">` : 
                                `<div class="profile-initials">${initials}</div>`
                            }
                        </div>
                    </td>
                    <td><strong>${teacher.name || teacher.fullName || 'N/A'}</strong></td>
                    <td>${teacher.subject || 'N/A'}</td>
                    <td>${teacher.phone || 'N/A'}</td>
                    <td>${teacher.email || 'Not provided'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="view-btn view-teacher-btn" data-id="${teacher.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <a href="tel:${teacher.phone}" class="call-btn" target="_blank">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                teachersTableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-teacher-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const teacherId = this.dataset.id;
                    showTeacherDetails(teacherId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const teacherId = this.dataset.id;
                    const teacher = teachers.find(t => t.id === teacherId);
                    showDeleteConfirmation('teacher', teacherId, `Are you sure you want to delete teacher "${teacher?.name || teacher?.fullName}"?`);
                });
            });
        }

        function showTeacherDetails(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            const profileImageUrl = getProfileImageUrl(teacher);
            const initials = getInitials(teacher.name || teacher.fullName);
            
            // Format dates
            const createdAt = teacher.createdAt ? new Date(teacher.createdAt).toLocaleString() : 'N/A';
            const updatedAt = teacher.updatedAt ? new Date(teacher.updatedAt).toLocaleString() : 'N/A';
            const reviewedAt = teacher.reviewedAt ? new Date(teacher.reviewedAt).toLocaleString() : 'N/A';
            
            teacherDetailsContent.innerHTML = `
                <div class="teacher-header">
                    <div class="teacher-avatar-large">
                        ${profileImageUrl ? 
                            `<img src="${profileImageUrl}" alt="${teacher.name || teacher.fullName}" onerror="this.onerror=null; this.parentElement.innerHTML='${initials}';">` : 
                            initials
                        }
                    </div>
                    <div class="teacher-info">
                        <h3>${teacher.name || teacher.fullName || 'N/A'}</h3>
                        <p><i class="fas fa-envelope"></i> ${teacher.email || 'Not provided'}</p>
                        <p><i class="fas fa-phone"></i> ${teacher.phone || 'N/A'}</p>
                        <p><i class="fas fa-graduation-cap"></i> ${teacher.grade || 'N/A'}</p>
                        <span class="subject-badge">${teacher.subject || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="details-grid">
                    <div class="detail-item">
                        <h4>Teacher ID</h4>
                        <p>${teacher.id || 'N/A'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Status</h4>
                        <p style="color: var(--success); font-weight: 700;">${teacher.status ? teacher.status.toUpperCase() : 'APPROVED'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Role</h4>
                        <p>${teacher.role ? teacher.role.toUpperCase() : 'TEACHER'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Students Assigned</h4>
                        <p>${teacher.students ? Object.keys(teacher.students).length : '0'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Created At</h4>
                        <p>${createdAt}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Last Updated</h4>
                        <p>${updatedAt}</p>
                    </div>
                    ${teacher.reviewedBy ? `
                        <div class="detail-item">
                            <h4>Reviewed By</h4>
                            <p>${teacher.reviewedByName || 'Admin'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>Reviewed At</h4>
                            <p>${reviewedAt}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="detail-item" style="margin-top: 20px;">
                    <h4>Additional Information</h4>
                    <p>${teacher.notes || 'No additional information available.'}</p>
                </div>
            `;
            
            teacherDetailsModal.style.display = 'flex';
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherGrade').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherEmail').value = '';
        }

        // Rest of the existing functions remain the same...
        // (All the existing functions from the original code should be kept here)
        // I'm including the most important ones, but you should keep all the original functions

        async function deleteTeacherFromFirebase(teacherId) {
            try {
                // We need to find which path this teacher is in
                const snapshot = await database.ref().once('value');
                const allData = snapshot.val();
                let deletePath = null;
                
                // Search for teacher in all paths
                for (const path in allData) {
                    if (allData[path] && allData[path][teacherId]) {
                        deletePath = `${path}/${teacherId}`;
                        break;
                    }
                }
                
                if (deletePath) {
                    await database.ref(deletePath).remove();
                    return true;
                } else {
                    // Fallback to teachers path
                    await database.ref('teachers').child(teacherId).remove();
                    return true;
                }
            } catch (error) {
                console.error('Error deleting teacher from Firebase:', error);
                throw error;
            }
        }

        // Show delete confirmation modal
        function showDeleteConfirmation(type, itemId, message) {
            itemToDelete = itemId;
            deleteType = type;
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        // Utility Functions
        function loadSampleData() {
            // Sample admins (fallback if Firebase fails)
            admins = [
                {
                    id: 'admin_1',
                    name: 'Admin User',
                    email: 'admin@school.com',
                    role: 'admin',
                    isActive: true,
                    profileImage: defaultProfileImage,
                    createdAt: new Date().toISOString()
                }
            ];
            
            // Sample notices (fallback if Firebase fails)
            notices = [
                {
                    id: 'notice_1',
                    title: 'Annual Sports Day Announcement',
                    content: 'We are pleased to announce that our Annual Sports Day will be held on 25th November 2023. All students are required to participate in at least one event. Teachers are requested to coordinate with the sports department.',
                    priority: 'high',
                    category: 'event',
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                }
            ];
            
            // Sample teachers (fallback if Firebase fails)
            teachers = [
                {
                    id: 'teacher_1',
                    name: 'Mr. John Smith',
                    subject: 'Mathematics',
                    phone: '+91 9876543210',
                    email: 'john.smith@school.com',
                    profileImage: defaultProfileImage,
                    addedDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    role: 'teacher',
                    status: 'approved'
                }
            ];
            
            // Update counts
            updateCounts();
        }

        // Success and Error Message Functions
        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // The rest of your existing functions (handleLogin, handleSendOtp, etc.) should remain here
        // I'm including just the essential structure to keep the response manageable

        // Add this function to update OTP input setup
        function setupOtpInputs() {
            // For forgot password OTP
            const forgotOtpInputs = document.querySelectorAll('#forgotOtpContainer .otp-input');
            setupOtpInputBehavior(forgotOtpInputs, 'forgot');
            
            // For reset password OTP (settings)
            const resetOtpInputs = document.querySelectorAll('#resetOtpContainer .otp-input');
            setupOtpInputBehavior(resetOtpInputs, 'reset');
        }

        function setupOtpInputBehavior(inputs, type) {
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    
                    // Only allow numbers
                    if (!/^\d*$/.test(value)) {
                        e.target.value = '';
                        return;
                    }
                    
                    // Auto-focus next input
                    if (value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    
                    // Enable paste
                    if (value.length > 1) {
                        const pastedValue = value.replace(/\D/g, '').substring(0, inputs.length);
                        for (let i = 0; i < pastedValue.length; i++) {
                            inputs[i].value = pastedValue[i];
                            if (i < inputs.length - 1) {
                                inputs[i + 1].focus();
                            }
                        }
                        e.target.value = pastedValue[0];
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    // Handle backspace
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = '';
                    }
                    
                    // Handle arrow keys
                    if (e.key === 'ArrowLeft' && index > 0) {
                        inputs[index - 1].focus();
                    }
                    if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
            });
        }
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
            authDomain: "schooladmin-51cdd.firebaseapp.com",
            databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
            projectId: "schooladmin-51cdd",
            storageBucket: "schooladmin-51cdd.firebasestorage.app",
            messagingSenderId: "185301938780",
            appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
            measurementId: "G-V8C5DE930K"
        };

        // EmailJS Configuration
        const emailjsConfig = {
            serviceId: 'service_u035226',
            templateId: 'template_xyk8468',
            publicKey: 'D-8liyb21zvqmvhPc'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize EmailJS
        (function() {
            emailjs.init(emailjsConfig.publicKey);
            console.log('EmailJS initialized with public key:', emailjsConfig.publicKey);
        })();

        // Application State
        let currentUser = null;
        let currentAdmin = null;
        let notices = [];
        let teachers = [];
        let admins = [];
        let activityLog = [];
        let itemToDelete = null;
        let deleteType = null;
        let otpStore = {}; // Store OTPs temporarily

        // Default profile image URL
        const defaultProfileImage = "https://res.cloudinary.com/dmhyflswb/image/upload/v1766410851/teacher_app/profiles/upoa2bskjucas6ogpwuh.png";

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminName = document.getElementById('adminName');
        const adminEmail = document.getElementById('adminEmail');
        const adminAvatar = document.getElementById('adminAvatar');
        const profileImageContainer = document.getElementById('profileImageContainer');
        
        // Auth Elements
        const authTabs = document.querySelectorAll('.auth-tab');
        const authContents = document.querySelectorAll('.auth-content');
        const loginBtn = document.getElementById('loginBtn');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        
        // Teacher Elements
        const addTeacherBtn = document.getElementById('addTeacherBtn');
        const teachersTableBody = document.getElementById('teachersTableBody');
        const saveTeacherBtn = document.getElementById('saveTeacherBtn');
        const cancelTeacherBtn = document.getElementById('cancelTeacherBtn');
        const closeTeacherModal = document.getElementById('closeTeacherModal');
        const addTeacherModal = document.getElementById('addTeacherModal');
        
        // Teacher Details Modal Elements
        const teacherDetailsModal = document.getElementById('teacherDetailsModal');
        const teacherDetailsContent = document.getElementById('teacherDetailsContent');
        const closeTeacherDetailsModal = document.getElementById('closeTeacherDetailsModal');
        const closeTeacherDetailsBtn = document.getElementById('closeTeacherDetailsBtn');
        
        // Admin Management
        const addAdminBtn = document.getElementById('addAdminBtn');
        const saveAdminBtn = document.getElementById('saveAdminBtn');
        const cancelAdminBtn = document.getElementById('cancelAdminBtn');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const addAdminModal = document.getElementById('addAdminModal');
        const adminsTableBody = document.getElementById('adminsTableBody');
        const adminCount = document.getElementById('adminCount');
        const activeAdminsCount = document.getElementById('activeAdminsCount');
        
        // Profile Image
        const uploadProfileBtn = document.getElementById('uploadProfileBtn');
        const profileImageInput = document.getElementById('profileImageInput');
        
        // Settings Elements
        const sendResetOtpBtn = document.getElementById('sendResetOtpBtn');
        const verifyResetOtpBtn = document.getElementById('verifyResetOtpBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const resetEmail = document.getElementById('resetEmail');
        const resetOtpContainer = document.getElementById('resetOtpContainer');
        const resetResendOtp = document.getElementById('resetResendOtp');
        const changePasswordForm = document.getElementById('changePasswordForm');
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-links a');
        const contentSections = document.querySelectorAll('.content-section');
        
        // Dashboard Elements
        const totalNoticesCount = document.getElementById('totalNoticesCount');
        const totalTeachersCount = document.getElementById('totalTeachersCount');
        const totalStudentsCount = document.getElementById('totalStudentsCount');
        const noticeCount = document.getElementById('noticeCount');
        const teacherCount = document.getElementById('teacherCount');
        const activityLogTable = document.getElementById('activityLog');
        const currentDateElement = document.getElementById('currentDate');
        
        // Notice Elements
        const sendNoticeBtn = document.getElementById('sendNoticeBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const refreshNoticesBtn = document.getElementById('refreshNoticesBtn');
        const noticesTableBody = document.getElementById('noticesTableBody');
        
        // Modal Elements
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // Settings Elements
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Success Message
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            currentDateElement.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Check if user is already logged in
            checkAuthState();
            
            // Load data from Firebase
            loadDataFromFirebase();
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Auth Tab Switching
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Update active tab
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    authContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId + 'Tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // Forgot password link
            document.querySelector('.forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                authTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.auth-tab[data-tab="forgot"]').classList.add('active');
                authContents.forEach(content => content.classList.remove('active'));
                document.getElementById('forgotTab').classList.add('active');
            });

            // Login
            loginBtn.addEventListener('click', handleLogin);
            
            // Send OTP for password reset (forgot password tab)
            sendOtpBtn.addEventListener('click', handleSendOtp);
            
            // Verify OTP for password reset (forgot password tab)
            verifyOtpBtn.addEventListener('click', handleVerifyOtp);
            
            // Reset Password (forgot password tab)
            resetPasswordBtn.addEventListener('click', handleResetPassword);
            
            // Resend OTP links
            document.getElementById('forgotResendLink')?.addEventListener('click', handleResendForgotOtp);
            document.getElementById('resetResendLink')?.addEventListener('click', handleResendResetOtp);

            // Teacher Management
            addTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'flex';
            });
            
            saveTeacherBtn.addEventListener('click', saveTeacher);
            cancelTeacherBtn.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            closeTeacherModal.addEventListener('click', () => {
                document.getElementById('addTeacherModal').style.display = 'none';
                clearTeacherForm();
            });
            
            // Teacher Details Modal
            closeTeacherDetailsModal.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });
            
            closeTeacherDetailsBtn.addEventListener('click', () => {
                teacherDetailsModal.style.display = 'none';
            });

            // Admin Management
            addAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'flex';
            });
            
            saveAdminBtn.addEventListener('click', handleAddAdmin);
            cancelAdminBtn.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });
            
            closeAdminModal.addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });

            // Profile Image Upload
            uploadProfileBtn.addEventListener('click', () => {
                profileImageInput.click();
            });
            
            profileImageInput.addEventListener('change', handleProfileImageUpload);

            // Settings - Password Reset
            sendResetOtpBtn.addEventListener('click', handleSendResetOtp);
            verifyResetOtpBtn.addEventListener('click', handleVerifyResetOtp);
            changePasswordBtn.addEventListener('click', handleChangePasswordInSettings);

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = link.dataset.section + 'Section';
                    contentSections.forEach(section => {
                        section.style.display = 'none';
                        if (section.id === sectionId) {
                            section.style.display = 'block';
                        }
                    });
                    
                    // Load section data if needed
                    if (sectionId === 'manageNoticesSection') {
                        loadNoticesTable();
                    } else if (sectionId === 'manageTeachersSection') {
                        loadTeachersTable();
                    } else if (sectionId === 'manageAdminsSection') {
                        loadAdminsTable();
                    }
                });
            });

            // Notice Management
            sendNoticeBtn.addEventListener('click', sendNotice);
            saveDraftBtn.addEventListener('click', saveNoticeAsDraft);
            refreshNoticesBtn.addEventListener('click', loadNoticesTable);

            // Modal Controls
            closeDeleteModal.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
            });
            
            cancelDeleteBtn.addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
            });
            
            confirmDeleteBtn.addEventListener('click', confirmDelete);

            // Settings
            updateProfileBtn.addEventListener('click', updateProfile);
            logoutBtn.addEventListener('click', handleLogout);

            // OTP Input Handling
            setupOtpInputs();
        }

        // Firebase Functions
        async function loadDataFromFirebase() {
            try {
                // Load admins
                const adminsSnapshot = await database.ref('admins').once('value');
                const firebaseAdmins = adminsSnapshot.val();
                
                if (firebaseAdmins) {
                    admins = Object.keys(firebaseAdmins).map(adminId => ({
                        id: adminId,
                        ...firebaseAdmins[adminId]
                    }));
                    updateCounts();
                }
                
                // Load notices
                const noticesSnapshot = await database.ref('notices').once('value');
                const firebaseNotices = noticesSnapshot.val();
                
                if (firebaseNotices) {
                    notices = Object.keys(firebaseNotices).map(noticeId => ({
                        id: noticeId,
                        ...firebaseNotices[noticeId]
                    }));
                    updateCounts();
                }
                
                // Load teachers from the actual Firebase path
                const teachersSnapshot = await database.ref().once('value');
                const allData = teachersSnapshot.val();
                teachers = [];
                
                // Find all teacher records in the database
                for (const key in allData) {
                    if (allData[key] && typeof allData[key] === 'object') {
                        for (const userId in allData[key]) {
                            const user = allData[key][userId];
                            if (user && user.role === 'teacher' && user.status === 'approved') {
                                teachers.push({
                                    id: userId,
                                    ...user
                                });
                            }
                        }
                    }
                }
                
                console.log('Loaded teachers from Firebase:', teachers);
                updateCounts();
                
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                // Load sample data if Firebase fails
                loadSampleData();
            }
        }

        // Update Counts Function
        function updateCounts() {
            // Update admin counts
            adminCount.textContent = admins.length;
            const activeAdmins = admins.filter(a => a.isActive !== false).length;
            activeAdminsCount.textContent = activeAdmins;
            
            // Update notice counts
            noticeCount.textContent = notices.length;
            totalNoticesCount.textContent = notices.length;
            
            // Update teacher counts
            teacherCount.textContent = teachers.length;
            totalTeachersCount.textContent = teachers.length;
            
            // Update student count (simulated)
            totalStudentsCount.textContent = '2847';
        }

        // Profile Image Functions
        function getProfileImageUrl(teacher) {
            // Return the profile image URL if it exists, otherwise use default
            if (teacher.profileImage && teacher.profileImage.trim() !== '') {
                return teacher.profileImage;
            }
            return defaultProfileImage;
        }

        function getInitials(name) {
            if (!name) return '?';
            const nameParts = name.split(' ');
            if (nameParts.length >= 2) {
                return (nameParts[0][0] + nameParts[1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }

        function loadProfileImage() {
            const profileImageUrl = currentAdmin?.profileImage || defaultProfileImage;
            
            // Update header avatar
            adminAvatar.style.backgroundImage = `url('${profileImageUrl}')`;
            adminAvatar.innerHTML = ''; // Remove text
            
            // Update settings profile image
            profileImageContainer.innerHTML = `
                <img src="${profileImageUrl}" alt="Profile" class="profile-image" id="profileImage">
            `;
        }

        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showSuccess('Profile image updated! Using default image for demo.');
            
            // Update profile image in Firebase
            try {
                await updateAdminProfile({
                    profileImage: defaultProfileImage,
                    updatedAt: new Date().toISOString()
                });
                
                // Update current admin
                currentAdmin.profileImage = defaultProfileImage;
                
                // Reload profile image
                loadProfileImage();
                
                addActivityLog('Updated Profile', 'Changed profile picture');
                
            } catch (error) {
                console.error('Error updating profile image:', error);
                showError('Failed to update profile image');
            }
            
            // Reset file input
            event.target.value = '';
        }

        // Teacher Management Functions
        async function saveTeacher() {
            const name = document.getElementById('teacherName').value;
            const subject = document.getElementById('teacherSubject').value;
            const grade = document.getElementById('teacherGrade').value;
            const phone = document.getElementById('teacherPhone').value;
            const email = document.getElementById('teacherEmail').value;
            
            if (!name || !subject || !phone) {
                showError('Please fill all required fields (Name, Subject, Phone)');
                return;
            }
            
            // Create teacher object
            const teacher = {
                name: name,
                subject: subject,
                phone: phone,
                email: email || '',
                grade: grade || ''
            };
            
            try {
                // Show loading
                saveTeacherBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveTeacherBtn.disabled = true;
                
                // Save to Firebase
                const teacherId = await saveTeacherToFirebase(teacher);
                
                // Add to local array with ID
                teacher.id = teacherId;
                teacher.addedDate = new Date().toISOString();
                teacher.profileImage = defaultProfileImage;
                teachers.push(teacher);
                
                // Update counts
                updateCounts();
                
                showSuccess('Teacher added successfully!');
                
                // Close modal
                document.getElementById('addTeacherModal').style.display = 'none';
                
                // If on manage teachers tab, refresh
                if (document.getElementById('manageTeachersSection').style.display === 'block') {
                    loadTeachersTable();
                }
                
                // Clear form
                clearTeacherForm();
                
                // Log activity
                addActivityLog('Added Teacher', `${name} - ${subject}`);
                
            } catch (error) {
                console.error('Error saving teacher:', error);
                showError('Failed to add teacher. Please try again.');
            } finally {
                // Reset button
                saveTeacherBtn.innerHTML = '<i class="fas fa-save"></i> Save Teacher';
                saveTeacherBtn.disabled = false;
            }
        }

        async function saveTeacherToFirebase(teacher) {
            try {
                const teacherRef = database.ref('teachers').push();
                const teacherId = teacherRef.key;
                
                const teacherData = {
                    id: teacherId,
                    name: teacher.name,
                    subject: teacher.subject,
                    phone: teacher.phone,
                    email: teacher.email || '',
                    grade: teacher.grade || '',
                    addedDate: new Date().toISOString(),
                    addedBy: currentUser.uid,
                    addedByName: currentAdmin?.name || currentUser.displayName || 'Admin',
                    profileImage: defaultProfileImage,
                    role: 'teacher',
                    status: 'approved'
                };
                
                await teacherRef.set(teacherData);
                return teacherId;
            } catch (error) {
                console.error('Error saving teacher to Firebase:', error);
                throw error;
            }
        }

        function loadTeachersTable() {
            // Clear table
            teachersTableBody.innerHTML = '';
            
            // Check if we have teachers
            if (teachers.length === 0) {
                teachersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No teachers added yet</h3>
                            <p>Add your first teacher using the "Add Teacher" button</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add teachers to table with profile images
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                const profileImageUrl = getProfileImageUrl(teacher);
                const initials = getInitials(teacher.name || teacher.fullName);
                
                row.innerHTML = `
                    <td>
                        <div class="teacher-profile-img">
                            ${profileImageUrl ? 
                                `<img src="${profileImageUrl}" alt="${teacher.name || teacher.fullName}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\"profile-initials\">${initials}</div>';">` : 
                                `<div class="profile-initials">${initials}</div>`
                            }
                        </div>
                    </td>
                    <td><strong>${teacher.name || teacher.fullName || 'N/A'}</strong></td>
                    <td>${teacher.subject || 'N/A'}</td>
                    <td>${teacher.phone || 'N/A'}</td>
                    <td>${teacher.email || 'Not provided'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="view-btn view-teacher-btn" data-id="${teacher.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <a href="tel:${teacher.phone}" class="call-btn" target="_blank">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                teachersTableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-teacher-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const teacherId = this.dataset.id;
                    showTeacherDetails(teacherId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const teacherId = this.dataset.id;
                    const teacher = teachers.find(t => t.id === teacherId);
                    showDeleteConfirmation('teacher', teacherId, `Are you sure you want to delete teacher "${teacher?.name || teacher?.fullName}"?`);
                });
            });
        }

        function showTeacherDetails(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            const profileImageUrl = getProfileImageUrl(teacher);
            const initials = getInitials(teacher.name || teacher.fullName);
            
            // Format dates
            const createdAt = teacher.createdAt ? new Date(teacher.createdAt).toLocaleString() : 'N/A';
            const updatedAt = teacher.updatedAt ? new Date(teacher.updatedAt).toLocaleString() : 'N/A';
            const reviewedAt = teacher.reviewedAt ? new Date(teacher.reviewedAt).toLocaleString() : 'N/A';
            
            teacherDetailsContent.innerHTML = `
                <div class="teacher-header">
                    <div class="teacher-avatar-large">
                        ${profileImageUrl ? 
                            `<img src="${profileImageUrl}" alt="${teacher.name || teacher.fullName}" onerror="this.onerror=null; this.parentElement.innerHTML='${initials}';">` : 
                            initials
                        }
                    </div>
                    <div class="teacher-info">
                        <h3>${teacher.name || teacher.fullName || 'N/A'}</h3>
                        <p><i class="fas fa-envelope"></i> ${teacher.email || 'Not provided'}</p>
                        <p><i class="fas fa-phone"></i> ${teacher.phone || 'N/A'}</p>
                        <p><i class="fas fa-graduation-cap"></i> ${teacher.grade || 'N/A'}</p>
                        <span class="subject-badge">${teacher.subject || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="details-grid">
                    <div class="detail-item">
                        <h4>Teacher ID</h4>
                        <p>${teacher.id || 'N/A'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Status</h4>
                        <p style="color: var(--success); font-weight: 700;">${teacher.status ? teacher.status.toUpperCase() : 'APPROVED'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Role</h4>
                        <p>${teacher.role ? teacher.role.toUpperCase() : 'TEACHER'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Students Assigned</h4>
                        <p>${teacher.students ? Object.keys(teacher.students).length : '0'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Created At</h4>
                        <p>${createdAt}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Last Updated</h4>
                        <p>${updatedAt}</p>
                    </div>
                    ${teacher.reviewedBy ? `
                        <div class="detail-item">
                            <h4>Reviewed By</h4>
                            <p>${teacher.reviewedByName || 'Admin'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>Reviewed At</h4>
                            <p>${reviewedAt}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="detail-item" style="margin-top: 20px;">
                    <h4>Additional Information</h4>
                    <p>${teacher.notes || 'No additional information available.'}</p>
                </div>
            `;
            
            teacherDetailsModal.style.display = 'flex';
        }

        function clearTeacherForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherGrade').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherEmail').value = '';
        }

        async function deleteTeacherFromFirebase(teacherId) {
            try {
                // We need to find which path this teacher is in
                const snapshot = await database.ref().once('value');
                const allData = snapshot.val();
                let deletePath = null;
                
                // Search for teacher in all paths
                for (const path in allData) {
                    if (allData[path] && allData[path][teacherId]) {
                        deletePath = `${path}/${teacherId}`;
                        break;
                    }
                }
                
                if (deletePath) {
                    await database.ref(deletePath).remove();
                    return true;
                } else {
                    // Fallback to teachers path
                    await database.ref('teachers').child(teacherId).remove();
                    return true;
                }
            } catch (error) {
                console.error('Error deleting teacher from Firebase:', error);
                throw error;
            }
        }

        // Admin Management Functions
        async function handleAddAdmin() {
            const name = document.getElementById('adminNameInput').value;
            const email = document.getElementById('adminEmailInput').value;
            const role = document.getElementById('adminRole').value;
            const status = document.getElementById('adminStatus').value;
            const password = document.getElementById('adminPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            
            if (!name || !email || !password || !confirmPassword) {
                showError('Please fill all required fields');
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            // Check if admin already exists
            const existingAdmin = admins.find(a => a.email === email);
            if (existingAdmin) {
                showError('An admin with this email already exists');
                return;
            }
            
            // Show loading
            saveAdminBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Admin...';
            saveAdminBtn.disabled = true;
            
            try {
                const adminData = {
                    name: name,
                    email: email,
                    role: role,
                    isActive: status === 'active',
                    password: password,
                    profileImage: defaultProfileImage
                };
                
                const result = await createAdminInFirebase(adminData);
                
                if (result.success) {
                    // Add to local array
                    admins.push({
                        id: result.adminId,
                        ...result.adminRecord
                    });
                    
                    // Update counts
                    updateCounts();
                    
                    showSuccess(`Admin "${name}" created successfully!`);
                    
                    // Close modal
                    document.getElementById('addAdminModal').style.display = 'none';
                    
                    // Clear form
                    clearAdminForm();
                    
                    // If on manage admins tab, refresh
                    if (document.getElementById('manageAdminsSection').style.display === 'block') {
                        loadAdminsTable();
                    }
                    
                    // Log activity
                    addActivityLog('Added Admin', `${name} (${email})`);
                    
                    // Send welcome email with credentials
                    await sendAdminWelcomeEmail(email, name, password);
                }
                
            } catch (error) {
                console.error('Error creating admin:', error);
                showError(getFirebaseErrorMessage(error));
            } finally {
                // Reset button
                saveAdminBtn.innerHTML = '<i class="fas fa-save"></i> Create Admin Account';
                saveAdminBtn.disabled = false;
            }
        }

        async function createAdminInFirebase(adminData) {
            try {
                // First create the user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(
                    adminData.email, 
                    adminData.password
                );
                
                const newAdminUser = userCredential.user;
                
                // Update user profile
                await newAdminUser.updateProfile({
                    displayName: adminData.name
                });
                
                // Create admin record in database
                const adminRecord = {
                    name: adminData.name,
                    email: adminData.email,
                    role: adminData.role || 'admin',
                    isActive: adminData.isActive !== false,
                    profileImage: adminData.profileImage || defaultProfileImage,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    createdByName: currentAdmin?.name || currentUser.displayName || 'Admin'
                };
                
                await database.ref('admins').child(newAdminUser.uid).set(adminRecord);
                
                return { 
                    success: true, 
                    adminId: newAdminUser.uid,
                    adminRecord 
                };
                
            } catch (error) {
                console.error('Error creating admin:', error);
                throw error;
            }
        }

        async function sendAdminWelcomeEmail(email, name, password) {
            try {
                const templateParams = {
                    to_email: email,
                    admin_name: name,
                    admin_email: email,
                    admin_password: password,
                    login_url: window.location.href,
                    school_name: 'School Admin Portal',
                    timestamp: new Date().toLocaleString()
                };

                await emailjs.send(
                    emailjsConfig.serviceId,
                    'template_welcome_admin',
                    templateParams
                );

                console.log('Welcome email sent to:', email);
            } catch (error) {
                console.error('Error sending welcome email:', error);
                // Don't show error to user - admin creation was successful
            }
        }

        async function deleteAdminFromFirebase(adminId) {
            try {
                await database.ref('admins').child(adminId).remove();
                return true;
            } catch (error) {
                console.error('Error deleting admin:', error);
                throw error;
            }
        }

        function loadAdminsTable() {
            // Clear table
            adminsTableBody.innerHTML = '';
            
            // Check if we have admins
            if (admins.length === 0) {
                adminsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No admins found</h3>
                            <p>Add your first admin using the "Add Admin" button</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add admins to table (excluding current user)
            const otherAdmins = admins.filter(admin => admin.id !== currentUser.uid);
            
            if (otherAdmins.length === 0) {
                adminsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-user-shield" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No other admins</h3>
                            <p>You are the only admin. Add more admins using the "Add Admin" button</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            otherAdmins.forEach(admin => {
                const row = document.createElement('tr');
                
                // Profile image
                const profileImageUrl = admin.profileImage || defaultProfileImage;
                const initials = getInitials(admin.name);
                
                // Status badge
                let statusBadge = '';
                if (admin.isActive === false) {
                    statusBadge = '<span class="priority-badge priority-low">Inactive</span>';
                } else {
                    statusBadge = '<span class="priority-badge" style="background-color: rgba(46, 204, 113, 0.1); color: #27ae60;">Active</span>';
                }
                
                // Role badge
                let roleBadge = '';
                if (admin.role === 'super_admin') {
                    roleBadge = '<span class="priority-badge priority-high">Super Admin</span>';
                } else {
                    roleBadge = '<span class="priority-badge priority-medium">Admin</span>';
                }
                
                row.innerHTML = `
                    <td>
                        <div class="teacher-profile-img">
                            ${profileImageUrl ? 
                                `<img src="${profileImageUrl}" alt="${admin.name}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\"profile-initials\">${initials}</div>';">` : 
                                `<div class="profile-initials">${initials}</div>`
                            }
                        </div>
                    </td>
                    <td><strong>${admin.name}</strong></td>
                    <td>${admin.email}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm edit-admin-btn" data-id="${admin.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-admin-btn" data-id="${admin.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                adminsTableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const adminId = this.dataset.id;
                    const admin = admins.find(a => a.id === adminId);
                    showDeleteConfirmation('admin', adminId, `Are you sure you want to delete admin "${admin?.name}"?`);
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const adminId = this.dataset.id;
                    editAdmin(adminId);
                });
            });
        }

        function editAdmin(adminId) {
            const admin = admins.find(a => a.id === adminId);
            if (!admin) return;
            
            // For now, just show an alert with admin details
            // In a real app, you would show an edit modal
            alert(`Admin Details:\n\nName: ${admin.name}\nEmail: ${admin.email}\nRole: ${admin.role}\nStatus: ${admin.isActive !== false ? 'Active' : 'Inactive'}\nCreated: ${admin.createdAt ? new Date(admin.createdAt).toLocaleString() : 'N/A'}`);
        }

        function clearAdminForm() {
            document.getElementById('adminNameInput').value = '';
            document.getElementById('adminEmailInput').value = '';
            document.getElementById('adminRole').value = 'admin';
            document.getElementById('adminStatus').value = 'active';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
        }

        // Delete Functions
        async function confirmDelete() {
            if (!itemToDelete || !deleteType) return;
            
            try {
                if (deleteType === 'notice') {
                    // Delete notice from Firebase
                    await deleteNoticeFromFirebase(itemToDelete);
                    
                    // Delete from local array
                    const index = notices.findIndex(n => n.id === itemToDelete);
                    if (index !== -1) {
                        const noticeTitle = notices[index].title;
                        notices.splice(index, 1);
                        
                        showSuccess(`Notice "${noticeTitle}" deleted successfully!`);
                        addActivityLog('Deleted Notice', noticeTitle);
                    }
                    
                    // Update UI
                    updateCounts();
                    if (document.getElementById('manageNoticesSection').style.display === 'block') {
                        loadNoticesTable();
                    }
                    
                } else if (deleteType === 'teacher') {
                    // Delete teacher from Firebase
                    await deleteTeacherFromFirebase(itemToDelete);
                    
                    // Delete from local array
                    const index = teachers.findIndex(t => t.id === itemToDelete);
                    if (index !== -1) {
                        const teacherName = teachers[index].name || teachers[index].fullName;
                        teachers.splice(index, 1);
                        
                        showSuccess(`Teacher "${teacherName}" deleted successfully!`);
                        addActivityLog('Deleted Teacher', teacherName);
                    }
                    
                    // Update UI
                    updateCounts();
                    if (document.getElementById('manageTeachersSection').style.display === 'block') {
                        loadTeachersTable();
                    }
                    
                } else if (deleteType === 'admin') {
                    // Delete admin from Firebase
                    await deleteAdminFromFirebase(itemToDelete);
                    
                    // Delete from local array
                    const index = admins.findIndex(a => a.id === itemToDelete);
                    if (index !== -1) {
                        const adminName = admins[index].name;
                        admins.splice(index, 1);
                        
                        showSuccess(`Admin "${adminName}" deleted successfully!`);
                        addActivityLog('Deleted Admin', adminName);
                    }
                    
                    // Update counts
                    updateCounts();
                    
                    // Update UI
                    if (document.getElementById('manageAdminsSection').style.display === 'block') {
                        loadAdminsTable();
                    }
                }
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showError('Failed to delete item. Please try again.');
            } finally {
                // Close modal
                document.getElementById('deleteModal').style.display = 'none';
                itemToDelete = null;
                deleteType = null;
            }
        }

        // Notice Management Functions
        async function sendNotice() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const priority = document.getElementById('noticePriority').value;
            const category = document.getElementById('noticeCategory').value;
            const sendToTeachers = document.getElementById('sendToTeachers').checked;
            const sendToStudents = document.getElementById('sendToStudents').checked;
            
            if (!title || !content) {
                showError('Please enter notice title and content');
                return;
            }
            
            if (!sendToTeachers && !sendToStudents) {
                showError('Please select at least one recipient group');
                return;
            }
            
            // Create notice object
            const notice = {
                title: title,
                content: content,
                priority: priority,
                category: category,
                timestamp: new Date().toISOString(),
                sentBy: currentUser.uid,
                sentByName: currentAdmin?.name || currentUser.displayName || 'Admin'
            };
            
            try {
                // Show loading
                sendNoticeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendNoticeBtn.disabled = true;
                
                // Save to Firebase
                const noticeId = await saveNoticeToFirebase(notice);
                
                // Add to local array with ID
                notice.id = noticeId;
                notices.unshift(notice);
                
                // Update counts
                updateCounts();
                
                showSuccess('Notice sent successfully to Teachers & Students apps!');
                
                // Clear form
                clearNoticeForm();
                
                // If on manage notices tab, refresh
                if (document.getElementById('manageNoticesSection').style.display === 'block') {
                    loadNoticesTable();
                }
                
                // Log activity
                addActivityLog('Sent Notice', title);
                
            } catch (error) {
                console.error('Error sending notice:', error);
                showError('Failed to send notice. Please try again.');
            } finally {
                // Reset button
                sendNoticeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Notice';
                sendNoticeBtn.disabled = false;
            }
        }

        async function saveNoticeToFirebase(notice) {
            try {
                const noticeRef = database.ref('notices').push();
                const noticeId = noticeRef.key;
                
                const noticeData = {
                    id: noticeId,
                    title: notice.title,
                    content: notice.content,
                    priority: notice.priority,
                    category: notice.category,
                    timestamp: new Date().toISOString(),
                    sentBy: currentUser.uid,
                    sentByName: currentAdmin?.name || currentUser.displayName || 'Admin'
                };
                
                await noticeRef.set(noticeData);
                return noticeId;
            } catch (error) {
                console.error('Error saving notice to Firebase:', error);
                throw error;
            }
        }

        async function deleteNoticeFromFirebase(noticeId) {
            try {
                await database.ref('notices').child(noticeId).remove();
                return true;
            } catch (error) {
                console.error('Error deleting notice from Firebase:', error);
                throw error;
            }
        }

        function saveNoticeAsDraft() {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            
            if (!title || !content) {
                showError('Please enter notice title and content to save as draft');
                return;
            }
            
            showSuccess('Notice saved as draft successfully!');
            addActivityLog('Saved Draft', title);
        }

        function loadNoticesTable() {
            // Clear table
            noticesTableBody.innerHTML = '';
            
            // Check if we have notices
            if (notices.length === 0) {
                noticesTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <h3>No notices found</h3>
                            <p>Send your first notice using the "Send Notice" tab</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add notices to table
            notices.forEach(notice => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(notice.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                
                // Priority badge
                let priorityBadge = '';
                if (notice.priority === 'high') {
                    priorityBadge = '<span class="priority-badge priority-high">High</span>';
                } else if (notice.priority === 'medium') {
                    priorityBadge = '<span class="priority-badge priority-medium">Medium</span>';
                } else {
                    priorityBadge = '<span class="priority-badge priority-low">Low</span>';
                }
                
                row.innerHTML = `
                    <td><strong>${notice.title}</strong></td>
                    <td>${notice.category || 'General'}</td>
                    <td>${priorityBadge}</td>
                    <td>${formattedDate}</td>
                    <td>All Teachers & Students</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm view-notice-btn" data-id="${notice.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                noticesTableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noticeId = this.dataset.id;
                    showDeleteConfirmation('notice', noticeId, 'Are you sure you want to delete this notice?');
                });
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-notice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noticeId = this.dataset.id;
                    viewNotice(noticeId);
                });
            });
        }

        function viewNotice(noticeId) {
            const notice = notices.find(n => n.id === noticeId);
            if (!notice) return;
            
            alert(`Notice Details:\n\nTitle: ${notice.title}\n\nContent: ${notice.content}\n\nPriority: ${notice.priority}\n\nCategory: ${notice.category}\n\nDate: ${new Date(notice.timestamp).toLocaleString()}`);
        }

        function clearNoticeForm() {
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('noticePriority').value = 'low';
            document.getElementById('noticeCategory').value = 'general';
            document.getElementById('sendToTeachers').checked = true;
            document.getElementById('sendToStudents').checked = true;
        }

        // Firebase Authentication Functions
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // Check if user is admin in database
                    try {
                        const adminSnapshot = await database.ref('admins').child(user.uid).once('value');
                        if (adminSnapshot.exists()) {
                            currentAdmin = adminSnapshot.val();
                            showAdminPanel();
                        } else {
                            showError('You are not authorized as an admin');
                            await auth.signOut();
                        }
                    } catch (error) {
                        console.error('Error checking admin status:', error);
                        showError('Error checking authorization');
                        await auth.signOut();
                    }
                }
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                // Show loading
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                loginBtn.disabled = true;
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user is admin in database
                const adminSnapshot = await database.ref('admins').child(currentUser.uid).once('value');
                
                if (adminSnapshot.exists()) {
                    currentAdmin = adminSnapshot.val();
                    
                    // Update last login
                    await database.ref('admins').child(currentUser.uid).update({
                        lastLogin: new Date().toISOString()
                    });
                    
                    showSuccess('Login successful!');
                    showAdminPanel();
                } else {
                    showError('You are not authorized as an admin');
                    await auth.signOut();
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError(getFirebaseErrorMessage(error));
            } finally {
                // Reset button
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Admin Panel';
                loginBtn.disabled = false;
            }
        }

        async function handleSendOtp() {
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Check if email exists in admins
            try {
                const adminsSnapshot = await database.ref('admins').once('value');
                const admins = adminsSnapshot.val();
                let adminExists = false;
                
                for (const adminId in admins) {
                    if (admins[adminId].email === email) {
                        adminExists = true;
                        break;
                    }
                }
                
                if (!adminExists) {
                    showError('No admin account found with this email');
                    return;
                }
            } catch (error) {
                console.error('Error checking admin email:', error);
                showError('Error checking email. Please try again.');
                return;
            }
            
            // Generate OTP
            const otp = generateOTP();
            
            // Store OTP temporarily
            otpStore[email] = {
                otp: otp,
                expires: Date.now() + 10 * 60 * 1000 // 10 minutes
            };
            
            // Show loading
            sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
            sendOtpBtn.disabled = true;
            
            try {
                // Send OTP via EmailJS
                const result = await sendOTPEmail(email, otp, 'password_reset');
                
                if (result.success) {
                    showSuccess('OTP sent to your email! Please check your inbox.');
                    
                    // Show OTP section
                    document.getElementById('forgotOtpContainer').style.display = 'flex';
                    document.getElementById('forgotResendOtp').style.display = 'block';
                    document.getElementById('verifyOtpBtn').style.display = 'block';
                    sendOtpBtn.style.display = 'none';
                    
                    // Start OTP timer
                    startOtpTimer('forgot');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Failed to send OTP. Please try again.');
            } finally {
                // Reset button
                sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP to Email';
                sendOtpBtn.disabled = false;
            }
        }

        function handleVerifyOtp() {
            const email = document.getElementById('forgotEmail').value;
            const otp = getOtpValue('forgot');
            
            if (!otp || otp.length !== 6) {
                showError('Please enter a valid 6-digit OTP');
                return;
            }
            
            // Check if OTP exists and is valid
            if (!otpStore[email] || otpStore[email].otp !== otp) {
                showError('Invalid OTP. Please try again.');
                return;
            }
            
            // Check if OTP is expired
            if (Date.now() > otpStore[email].expires) {
                showError('OTP has expired. Please request a new one.');
                delete otpStore[email];
                return;
            }
            
            showSuccess('OTP verified! You can now reset your password.');
            
            // Show password reset form
            document.getElementById('resetPasswordForm').style.display = 'block';
            document.getElementById('verifyOtpBtn').style.display = 'none';
            document.getElementById('forgotOtpContainer').style.display = 'none';
            document.getElementById('forgotResendOtp').style.display = 'none';
            
            // Clear OTP from store
            delete otpStore[email];
        }

        async function handleResetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmNewPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                // Show loading
                resetPasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting Password...';
                resetPasswordBtn.disabled = true;
                
                // Get user by email
                const userCredential = await auth.signInWithEmailAndPassword(email, 'temporary_password');
                const user = userCredential.user;
                
                // Update password
                await user.updatePassword(newPassword);
                
                showSuccess('Password reset successful! You can now login with your new password.');
                
                // Switch to login tab
                document.querySelector('.auth-tab[data-tab="login"]').click();
                
                // Reset form
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('sendOtpBtn').style.display = 'block';
                document.getElementById('forgotEmail').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
            } catch (error) {
                console.error('Password reset error:', error);
                showError(getFirebaseErrorMessage(error));
            } finally {
                // Reset button
                resetPasswordBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
                resetPasswordBtn.disabled = false;
            }
        }

        // Settings Password Reset Functions
        async function handleSendResetOtp() {
            const email = resetEmail.value;
            
            if (!email) {
                showError('Please enter your registered email address');
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Check if the email matches the logged-in user
            if (email !== currentUser.email) {
                showError('Please enter the email address associated with your account');
                return;
            }
            
            // Generate OTP
            const otp = generateOTP();
            
            // Store OTP temporarily
            otpStore[email] = {
                otp: otp,
                expires: Date.now() + 10 * 60 * 1000 // 10 minutes
            };
            
            // Show loading
            sendResetOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
            sendResetOtpBtn.disabled = true;
            
            try {
                // Send OTP via EmailJS
                const result = await sendOTPEmail(email, otp, 'password_reset');
                
                if (result.success) {
                    showSuccess('OTP sent to your email! Please check your inbox.');
                    
                    // Show OTP section
                    resetOtpContainer.style.display = 'flex';
                    resetResendOtp.style.display = 'block';
                    verifyResetOtpBtn.style.display = 'block';
                    sendResetOtpBtn.style.display = 'none';
                    
                    // Start OTP timer
                    startOtpTimer('reset');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Failed to send OTP. Please try again.');
            } finally {
                // Reset button
                sendResetOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP to Email';
                sendResetOtpBtn.disabled = false;
            }
        }

        function handleVerifyResetOtp() {
            const email = resetEmail.value;
            const otp = getOtpValue('reset');
            
            if (!otp || otp.length !== 6) {
                showError('Please enter a valid 6-digit OTP');
                return;
            }
            
            // Check if OTP exists and is valid
            if (!otpStore[email] || otpStore[email].otp !== otp) {
                showError('Invalid OTP. Please try again.');
                return;
            }
            
            // Check if OTP is expired
            if (Date.now() > otpStore[email].expires) {
                showError('OTP has expired. Please request a new one.');
                delete otpStore[email];
                return;
            }
            
            showSuccess('OTP verified! You can now change your password.');
            
            // Show password change form
            changePasswordForm.style.display = 'block';
            verifyResetOtpBtn.style.display = 'none';
            resetOtpContainer.style.display = 'none';
            resetResendOtp.style.display = 'none';
            
            // Clear OTP from store
            delete otpStore[email];
        }

        async function handleChangePasswordInSettings() {
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                // Show loading
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
                changePasswordBtn.disabled = true;
                
                // Update password
                await currentUser.updatePassword(newPassword);
                
                showSuccess('Password changed successfully!');
                
                // Clear form
                document.getElementById('settingsNewPassword').value = '';
                document.getElementById('settingsConfirmPassword').value = '';
                changePasswordForm.style.display = 'none';
                sendResetOtpBtn.style.display = 'block';
                resetEmail.value = '';
                
                // Log activity
                addActivityLog('Changed Password', 'Account security update');
                
            } catch (error) {
                console.error('Password change error:', error);
                showError(getFirebaseErrorMessage(error));
            } finally {
                // Reset button
                changePasswordBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
                changePasswordBtn.disabled = false;
            }
        }

        async function handleResendForgotOtp(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                showError('Please enter your email first');
                return;
            }
            
            // Generate new OTP
            const otp = generateOTP();
            
            // Update OTP store
            otpStore[email] = {
                otp: otp,
                expires: Date.now() + 10 * 60 * 1000
            };
            
            // Show loading
            const resendLink = document.getElementById('forgotResendLink');
            resendLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
            resendLink.style.pointerEvents = 'none';
            
            try {
                const result = await sendOTPEmail(email, otp, 'password_reset');
                
                if (result.success) {
                    showSuccess('New OTP sent to your email!');
                    startOtpTimer('forgot');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Failed to resend OTP. Please try again.');
            } finally {
                // Reset link
                resendLink.innerHTML = 'Resend OTP';
                resendLink.style.pointerEvents = 'auto';
            }
        }

        async function handleResendResetOtp(e) {
            e.preventDefault();
            
            const email = resetEmail.value;
            
            if (!email) {
                showError('Please enter your email first');
                return;
            }
            
            // Generate new OTP
            const otp = generateOTP();
            
            // Update OTP store
            otpStore[email] = {
                otp: otp,
                expires: Date.now() + 10 * 60 * 1000
            };
            
            // Show loading
            const resendLink = document.getElementById('resetResendLink');
            resendLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
            resendLink.style.pointerEvents = 'none';
            
            try {
                const result = await sendOTPEmail(email, otp, 'password_reset');
                
                if (result.success) {
                    showSuccess('New OTP sent to your email!');
                    startOtpTimer('reset');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Failed to resend OTP. Please try again.');
            } finally {
                // Reset link
                resendLink.innerHTML = 'Resend OTP';
                resendLink.style.pointerEvents = 'auto';
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                
                // Clear app state
                currentUser = null;
                currentAdmin = null;
                
                // Show auth screen
                authContainer.style.display = 'flex';
                adminPanel.style.display = 'none';
                
                // Reset forms
                clearLoginForm();
                
                showSuccess('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
                showError('Error logging out. Please try again.');
            }
        }

        // Admin Panel Functions
        function showAdminPanel() {
            // Update user info
            adminName.textContent = currentAdmin?.name || currentUser.displayName || 'Admin User';
            adminEmail.textContent = currentUser.email;
            
            // Load profile image
            loadProfileImage();
            
            // Set email in reset form
            resetEmail.value = currentUser.email;
            document.getElementById('settingsName').value = currentAdmin?.name || currentUser.displayName || '';
            document.getElementById('settingsEmail').value = currentUser.email;
            
            // Switch to admin panel
            authContainer.style.display = 'none';
            adminPanel.style.display = 'block';
            
            // Load dashboard data
            loadDashboardData();
        }

        function loadDashboardData() {
            // Update counts
            updateCounts();
            
            // Load activity log
            loadActivityLog();
        }

        function loadActivityLog() {
            // Simulated activity data
            const activities = [
                { time: '10:30 AM', activity: 'Sent Notice', details: 'Annual Sports Day Announcement', status: 'Completed' },
                { time: 'Yesterday, 3:15 PM', activity: 'Added Teacher', details: 'Mr. John Smith - Mathematics', status: 'Completed' },
                { time: 'Mar 12, 9:45 AM', activity: 'Deleted Notice', details: 'Old Library Schedule', status: 'Completed' },
                { time: 'Mar 10, 2:20 PM', activity: 'Password Changed', details: 'Account security update', status: 'Completed' },
                { time: 'Mar 8, 11:05 AM', activity: 'Sent Notice', details: 'Parent-Teacher Meeting Schedule', status: 'Completed' }
            ];
            
            activityLogTable.innerHTML = '';
            activities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                    <td><span style="color: var(--success); font-weight: 600;">${activity.status}</span></td>
                `;
                activityLogTable.appendChild(row);
            });
        }

        // Settings Functions
        async function updateProfile() {
            const name = document.getElementById('settingsName').value;
            
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            try {
                // Show loading
                updateProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                updateProfileBtn.disabled = true;
                
                // Update in Firebase Auth
                await currentUser.updateProfile({
                    displayName: name
                });
                
                // Update in Firebase Database
                await updateAdminProfile({
                    name: name,
                    updatedAt: new Date().toISOString()
                });
                
                // Update current admin
                currentAdmin.name = name;
                
                // Update UI
                adminName.textContent = name;
                
                showSuccess('Profile updated successfully!');
                addActivityLog('Updated Profile', 'Changed display name');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Failed to update profile. Please try again.');
            } finally {
                // Reset button
                updateProfileBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';
                updateProfileBtn.disabled = false;
            }
        }

        async function updateAdminProfile(adminData) {
            try {
                if (!currentUser || !currentUser.uid) {
                    throw new Error('No user logged in');
                }
                
                await database.ref('admins').child(currentUser.uid).update(adminData);
                return true;
            } catch (error) {
                console.error('Error updating admin profile:', error);
                throw error;
            }
        }

        // Utility Functions
        function loadSampleData() {
            // Sample admins (fallback if Firebase fails)
            admins = [
                {
                    id: 'admin_1',
                    name: 'Admin User',
                    email: 'admin@school.com',
                    role: 'admin',
                    isActive: true,
                    profileImage: defaultProfileImage,
                    createdAt: new Date().toISOString()
                }
            ];
            
            // Sample notices (fallback if Firebase fails)
            notices = [
                {
                    id: 'notice_1',
                    title: 'Annual Sports Day Announcement',
                    content: 'We are pleased to announce that our Annual Sports Day will be held on 25th November 2023. All students are required to participate in at least one event. Teachers are requested to coordinate with the sports department.',
                    priority: 'high',
                    category: 'event',
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'sent',
                    sentBy: 'Admin'
                }
            ];
            
            // Sample teachers (fallback if Firebase fails)
            teachers = [
                {
                    id: 'teacher_1',
                    name: 'Mr. John Smith',
                    subject: 'Mathematics',
                    phone: '+91 9876543210',
                    email: 'john.smith@school.com',
                    profileImage: defaultProfileImage,
                    addedDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    role: 'teacher',
                    status: 'approved'
                }
            ];
            
            // Update counts
            updateCounts();
        }

        // Email Functions
        function generateOTP() {
            // Generate a 6-digit OTP
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendOTPEmail(email, otp, purpose = 'verification') {
            try {
                const templateParams = {
                    to_email: email,
                    otp_code: otp,
                    purpose: purpose,
                    school_name: 'School Admin Portal',
                    timestamp: new Date().toLocaleString()
                };

                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.templateId,
                    templateParams
                );

                console.log('Email sent successfully:', response);
                return { success: true, message: 'OTP sent successfully!' };
            } catch (error) {
                console.error('Email sending failed:', error);
                return { success: false, message: 'Failed to send OTP email. Please try again.' };
            }
        }

        // OTP Functions
        function setupOtpInputs() {
            // For forgot password OTP
            const forgotOtpInputs = document.querySelectorAll('#forgotOtpContainer .otp-input');
            setupOtpInputBehavior(forgotOtpInputs, 'forgot');
            
            // For reset password OTP (settings)
            const resetOtpInputs = document.querySelectorAll('#resetOtpContainer .otp-input');
            setupOtpInputBehavior(resetOtpInputs, 'reset');
        }

        function setupOtpInputBehavior(inputs, type) {
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    
                    // Only allow numbers
                    if (!/^\d*$/.test(value)) {
                        e.target.value = '';
                        return;
                    }
                    
                    // Auto-focus next input
                    if (value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    
                    // Enable paste
                    if (value.length > 1) {
                        const pastedValue = value.replace(/\D/g, '').substring(0, inputs.length);
                        for (let i = 0; i < pastedValue.length; i++) {
                            inputs[i].value = pastedValue[i];
                            if (i < inputs.length - 1) {
                                inputs[i + 1].focus();
                            }
                        }
                        e.target.value = pastedValue[0];
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    // Handle backspace
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = '';
                    }
                    
                    // Handle arrow keys
                    if (e.key === 'ArrowLeft' && index > 0) {
                        inputs[index - 1].focus();
                    }
                    if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
            });
        }

        function getOtpValue(type) {
            const containerId = type === 'forgot' ? 'forgotOtpContainer' : 'resetOtpContainer';
            const inputs = document.querySelectorAll(`#${containerId} .otp-input`);
            let otp = '';
            inputs.forEach(input => {
                otp += input.value;
            });
            return otp;
        }

        function startOtpTimer(type) {
            const timerId = type === 'forgot' ? 'forgotOtpTimer' : 'resetOtpTimer';
            const timerElement = document.getElementById(timerId);
            let timeLeft = 300; // 5 minutes
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `OTP expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timer);
                    timerElement.textContent = 'OTP expired';
                    timerElement.style.color = 'var(--danger)';
                }
            }, 1000);
        }

        // Show delete confirmation modal
        function showDeleteConfirmation(type, itemId, message) {
            itemToDelete = itemId;
            deleteType = type;
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/user-disabled':
                    return 'User account is disabled';
                case 'auth/user-not-found':
                    return 'User not found';
                case 'auth/wrong-password':
                    return 'Incorrect password';
                case 'auth/email-already-in-use':
                    return 'Email already in use';
                case 'auth/weak-password':
                    return 'Password is too weak';
                case 'auth/operation-not-allowed':
                    return 'Operation not allowed';
                case 'auth/too-many-requests':
                    return 'Too many requests. Please try again later';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your connection';
                default:
                    return error.message || 'An error occurred. Please try again';
            }
        }

        function clearLoginForm() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function addActivityLog(activity, details) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Add to beginning of array
            activityLog.unshift({
                time: timeString,
                activity: activity,
                details: details,
                status: 'Completed'
            });
            
            // Update activity log table if on dashboard
            if (document.getElementById('dashboardSection').style.display === 'block') {
                loadActivityLog();
            }
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }
   
    </script>
</body>
</html>
